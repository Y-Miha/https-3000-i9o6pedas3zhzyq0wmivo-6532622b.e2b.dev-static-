<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM "–ü–æ–≤–∞—Ä –ë–∏–º" - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•ò</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .nav-item:hover {
            background-color: #f3f4f6;
            border-radius: 8px;
        }
        .table-row:hover {
            background-color: #f9fafb;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal {
            display: none;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.show {
            display: flex !important;
        }
        .modal.fixed {
            position: fixed;
        }
        .modal-container {
            max-height: 95vh;
            overflow-y: auto;
            margin: 2.5vh auto;
        }
        
        /* –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ */
        .badge-physical { @apply bg-blue-100 text-blue-800; }
        .badge-legal { @apply bg-purple-100 text-purple-800; }
        .badge-store { @apply bg-green-100 text-green-800; }
        .badge-wholesale { @apply bg-orange-100 text-orange-800; }
        .badge-company { @apply bg-gray-100 text-gray-800; }
        .badge-active { @apply bg-green-100 text-green-800; }
        .badge-inactive { @apply bg-red-100 text-red-800; }
        
        /* –°—Ç–∞—Ç—É—Å—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ */
        .status-available { @apply text-green-600; }
        .status-unavailable { @apply text-red-600; }
        
        /* –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã */
        .status-draft { @apply bg-gray-100 text-gray-800; }
        .status-active { @apply bg-blue-100 text-blue-800; }
        .status-in-production { @apply bg-yellow-100 text-yellow-800; }
        .status-completed { @apply bg-green-100 text-green-800; }
        .status-cancelled { @apply bg-red-100 text-red-800; }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ */
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #10b981;
            transition: width 0.3s ease;
        }
        
        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–µ–Ω—é */
        .nav-item.active {
            background-color: #fed7aa;
            color: #ea580c;
            border-radius: 8px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ */
        .ingredient-row {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
        }
        .ingredient-row:hover {
            border-color: #d97706;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* –ü–µ—á–∞—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { font-size: 12px; }
            .modal { position: static; background: white; display: block !important; }
            .modal-container { max-height: none; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- –®–∞–ø–∫–∞ -->
    <header class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-dog text-2xl text-orange-600 mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">CRM "–ü–æ–≤–∞—Ä –ë–∏–º" - –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h1>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="current-time"></span>
                </div>
            </div>
        </div>
    </header>

    <div class="flex min-h-screen">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="w-64 bg-white shadow-sm border-r no-print">
            <nav class="mt-5 px-2">
                <a href="#" onclick="showSection('dashboard')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                    <i class="fas fa-chart-bar text-gray-400 mr-3 text-lg"></i>
                    –î–∞—à–±–æ—Ä–¥
                </a>
                
                <a href="#" onclick="showSection('customers')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                    <i class="fas fa-users text-gray-400 mr-3 text-lg"></i>
                    –ö–ª–∏–µ–Ω—Ç—ã
                </a>
                
                <a href="#" onclick="showSection('products')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                    <i class="fas fa-box text-gray-400 mr-3 text-lg"></i>
                    –¢–æ–≤–∞—Ä—ã
                </a>
                
                <a href="#" onclick="showSection('orders')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                    <i class="fas fa-shopping-cart text-gray-400 mr-3 text-lg"></i>
                    –ó–∞–∫–∞–∑—ã
                </a>

                <!-- –ù–û–í–´–ï –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ï –ú–û–î–£–õ–ò -->
                <div class="mt-6 border-t pt-6">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
                        <i class="fas fa-industry mr-2"></i>
                        –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    </h3>
                    
                    <a href="#" onclick="showSection('ingredients')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-seedling text-gray-400 mr-3 text-lg"></i>
                        –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
                    </a>
                    
                    <a href="#" onclick="showSection('recipes')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-clipboard-list text-gray-400 mr-3 text-lg"></i>
                        –†–µ—Ü–µ–ø—Ç—ã
                    </a>
                    
                    <a href="#" onclick="showSection('production')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-cogs text-gray-400 mr-3 text-lg"></i>
                        –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    </a>
                    
                    <a href="#" onclick="showSection('packaging')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-boxes text-gray-400 mr-3 text-lg"></i>
                        –£–ø–∞–∫–æ–≤–∫–∞
                    </a>
                </div>

                <div class="mt-8">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
                        –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                    </h3>
                    
                    <button onclick="showSection('recipes'); showModal('recipe-modal')" 
                            class="w-full nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-plus-circle text-gray-400 mr-3 text-lg"></i>
                        –ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç
                    </button>
                    
                    <button onclick="showSection('production'); showModal('production-task-modal')" 
                            class="w-full nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-play-circle text-gray-400 mr-3 text-lg"></i>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    </button>
                    
                    <button onclick="showSection('customers'); showModal('customer-modal')" 
                            class="w-full nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-user-plus text-gray-400 mr-3 text-lg"></i>
                        –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                    </button>
                </div>
            </nav>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="flex-1 relative z-0 overflow-y-auto focus:outline-none">
            <!-- –î–∞—à–±–æ—Ä–¥ -->
            <section id="dashboard-section" class="section">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-tachometer-alt text-orange-600 mr-3"></i>
                                –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∞—à–±–æ—Ä–¥
                            </h2>
                        </div>

                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-users text-2xl text-orange-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–ö–ª–∏–µ–Ω—Ç—ã</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="total-customers">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-clipboard-list text-2xl text-blue-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–†–µ—Ü–µ–ø—Ç—ã</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="total-recipes">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-cogs text-2xl text-green-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="active-production">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-seedling text-2xl text-purple-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="total-ingredients">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-ruble-sign text-2xl text-indigo-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–í—ã—Ä—É—á–∫–∞</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="monthly-revenue">0 ‚ÇΩ</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É -->
                        <div class="bg-white shadow rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">
                                <i class="fas fa-bolt text-orange-600 mr-2"></i>
                                –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button onclick="showSection('recipes'); showModal('recipe-modal')"
                                        class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-orange-50 hover:border-orange-300 transition-colors">
                                    <i class="fas fa-plus-circle text-orange-600 text-2xl mb-2"></i>
                                    <span class="text-sm font-medium text-center">–°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç</span>
                                </button>
                                
                                <button onclick="showSection('production'); showModal('production-task-modal')"
                                        class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors">
                                    <i class="fas fa-play-circle text-blue-600 text-2xl mb-2"></i>
                                    <span class="text-sm font-medium text-center">–ó–∞–ø—É—Å–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</span>
                                </button>
                                
                                <button onclick="showSection('ingredients'); showModal('ingredient-modal')"
                                        class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition-colors">
                                    <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                                    <span class="text-sm font-medium text-center">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</span>
                                </button>
                                
                                <button onclick="showSection('packaging'); showModal('packaging-modal')"
                                        class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 transition-colors">
                                    <i class="fas fa-boxes text-purple-600 text-2xl mb-2"></i>
                                    <span class="text-sm font-medium text-center">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø–∞–∫–æ–≤–∫–æ–π</span>
                                </button>
                            </div>
                        </div>

                        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è -->
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">
                                <i class="fas fa-tasks text-blue-600 mr-2"></i>
                                –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
                            </h3>
                            <div id="active-production-tasks" class="space-y-4">
                                <div class="text-gray-500 text-center py-8">
                                    <i class="fas fa-clipboard-check text-4xl mb-3"></i>
                                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
                                    <button onclick="showSection('production'); showModal('production-task-modal')" 
                                            class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                                        <i class="fas fa-plus mr-2"></i>
                                        –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ú–û–î–£–õ–¨ –ò–ù–ì–†–ï–î–ò–ï–ù–¢–´ -->
            <section id="ingredients-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-seedling text-green-600 mr-3"></i>
                                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏
                            </h2>
                            <button onclick="showModal('ingredient-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                <i class="fas fa-plus mr-2"></i>
                                –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                            </button>
                        </div>

                        <!-- –§–∏–ª—å—Ç—Ä—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ -->
                        <div class="bg-white shadow rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü–æ–∏—Å–∫</label>
                                    <input type="text" id="ingredient-search" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞" onkeyup="filterIngredients()"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                    <select id="ingredient-category-filter" onchange="filterIngredients()"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                        <option value="–º—è—Å–æ">–ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞</option>
                                        <option value="—Ä—ã–±–∞">–†—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</option>
                                        <option value="–∫—Ä—É–ø—ã">–ö—Ä—É–ø—ã –∏ –∑–ª–∞–∫–∏</option>
                                        <option value="–æ–≤–æ—â–∏">–û–≤–æ—â–∏</option>
                                        <option value="–≤–∏—Ç–∞–º–∏–Ω—ã">–í–∏—Ç–∞–º–∏–Ω—ã –∏ –º–∏–Ω–µ—Ä–∞–ª—ã</option>
                                        <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–ª–∏—á–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                                    <select id="ingredient-availability-filter" onchange="filterIngredients()"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">–í—Å–µ</option>
                                        <option value="available">–ï—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ</option>
                                        <option value="low">–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è</option>
                                        <option value="unavailable">–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="clearIngredientFilters()" 
                                            class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –¶–µ–Ω–∞ –∑–∞ –∫–≥
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—Ç–∞—Ç—É—Å
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="ingredients-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ú–û–î–£–õ–¨ –†–ï–¶–ï–ü–¢–´ -->
            <section id="recipes-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-clipboard-list text-blue-600 mr-3"></i>
                                –ë–∞–∑–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∫–∞—à "–ü–æ–≤–∞—Ä –ë–∏–º"
                            </h2>
                            <button onclick="showModal('recipe-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>
                                –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç
                            </button>
                        </div>

                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤ -->
                        <div id="recipes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- –†–µ—Ü–µ–ø—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>

                        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                        <div id="recipes-empty" class="text-center py-12 hidden">
                            <i class="fas fa-clipboard-list text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤</h3>
                            <p class="text-gray-500 mb-6">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–µ—Ü–µ–ø—Ç –∫–∞—à–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</p>
                            <button onclick="showModal('recipe-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>
                                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ä–µ—Ü–µ–ø—Ç
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ú–û–î–£–õ–¨ –ü–†–û–ò–ó–í–û–î–°–¢–í–û -->
            <section id="production-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-cogs text-orange-600 mr-3"></i>
                                –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
                            </h2>
                            <button onclick="showModal('production-task-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                                <i class="fas fa-play-circle mr-2"></i>
                                –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                            </button>
                        </div>

                        <!-- –§–∏–ª—å—Ç—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π -->
                        <div class="bg-white shadow rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü–æ–∏—Å–∫</label>
                                    <input type="text" id="production-search" placeholder="–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ –∏–ª–∏ —Ä–µ—Ü–µ–ø—Ç" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                                    <select id="production-status-filter" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                        <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                                        <option value="active">–ê–∫—Ç–∏–≤–Ω–æ–µ</option>
                                        <option value="in-production">–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ</option>
                                        <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                                        <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–†–µ—Ü–µ–ø—Ç</label>
                                    <select id="production-recipe-filter" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="">–í—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã</option>
                                        <!-- –†–µ—Ü–µ–ø—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞</label>
                                    <input type="date" id="production-date-filter" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="clearProductionFilters()" 
                                            class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                        –°–±—Ä–æ—Å–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ü–∞—Ä—Ç–∏—è / –†–µ—Ü–µ–ø—Ç
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –û–±—ä–µ–º (–∫–≥)
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—Ç–∞—Ç—É—Å
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="production-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ú–û–î–£–õ–¨ –£–ü–ê–ö–û–í–ö–ê -->
            <section id="packaging-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-boxes text-purple-600 mr-3"></i>
                                –£–ø–∞–∫–æ–≤–∫–∞ –∏ —Ä–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                            </h2>
                            <button onclick="showModal('packaging-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">
                                <i class="fas fa-plus mr-2"></i>
                                –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                            </button>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ —É–ø–∞–∫–æ–≤–æ—á–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ú–∞—Ç–µ—Ä–∏–∞–ª
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –¢–∏–ø
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –û—Å—Ç–∞—Ç–æ–∫
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="packaging-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ -->
    <div id="ingredient-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-seedling text-green-600 mr-2"></i>
                    <span id="ingredient-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</span>
                </h3>
                <button onclick="hideModal('ingredient-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="ingredient-form" onsubmit="saveIngredient(event)">
                <input type="hidden" id="ingredient-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ *</label>
                        <input type="text" id="ingredient-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                        <select id="ingredient-category" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <option value="–º—è—Å–æ">–ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞</option>
                            <option value="—Ä—ã–±–∞">–†—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</option>
                            <option value="–∫—Ä—É–ø—ã">–ö—Ä—É–ø—ã –∏ –∑–ª–∞–∫–∏</option>
                            <option value="–æ–≤–æ—â–∏">–û–≤–æ—â–∏</option>
                            <option value="–≤–∏—Ç–∞–º–∏–Ω—ã">–í–∏—Ç–∞–º–∏–Ω—ã –∏ –º–∏–Ω–µ—Ä–∞–ª—ã</option>
                            <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ (–∫–≥) *</label>
                        <input type="number" id="ingredient-stock" step="0.01" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ) *</label>
                        <input type="number" id="ingredient-price" step="0.01" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–∫–≥)</label>
                        <input type="number" id="ingredient-min-stock" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                        <input type="text" id="ingredient-supplier"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                </div>

                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="ingredient-description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                </div>

                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideModal('ingredient-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ—Ü–µ–ø—Ç–∞ -->
    <div id="recipe-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
                    <span id="recipe-modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç</span>
                </h3>
                <button onclick="hideModal('recipe-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="recipe-form" onsubmit="saveRecipe(event)">
                <input type="hidden" id="recipe-id">
                
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Ü–µ–ø—Ç–µ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ *</label>
                        <input type="text" id="recipe-name" required placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—à–∞ '–ì–æ–≤—è–¥–∏–Ω–∞'"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–∞—à–∏ *</label>
                        <div class="flex">
                            <select id="recipe-category" required 
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="–≥–æ–≤—è–¥–∏–Ω–∞">–ì–æ–≤—è–¥–∏–Ω–∞</option>
                                <option value="–∫—É—Ä–∏—Ü–∞">–ö—É—Ä–∏—Ü–∞</option>
                                <option value="–ª–æ—Å–æ—Å—å">–õ–æ—Å–æ—Å—å</option>
                                <option value="–ª–∞–π—Ç">–õ–∞–π—Ç (–¥–∏–µ—Ç–∏—á–µ—Å–∫–∞—è)</option>
                            </select>
                            <button type="button" onclick="addNewCategory()" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é"
                                    class="px-3 py-2 bg-green-600 text-white hover:bg-green-700">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button type="button" onclick="manageCategoriesModal()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏"
                                    class="px-3 py-2 bg-orange-600 text-white rounded-r-lg hover:bg-orange-700">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <i class="fas fa-plus text-green-600"></i> –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, <i class="fas fa-cog text-orange-600"></i> –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</p>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞</label>
                    <textarea id="recipe-description" rows="2" 
                              placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π —Ä–µ—Ü–µ–ø—Ç–∞"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>

                <!-- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞ -->
                <div class="border border-gray-300 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-md font-medium text-gray-900">
                            <i class="fas fa-flask text-blue-600 mr-2"></i>
                            –°–æ—Å—Ç–∞–≤ —Ä–µ—Ü–µ–ø—Ç–∞ (–Ω–∞ 1 –∫–≥)
                        </h4>
                        <button type="button" onclick="addIngredientToRecipe()" 
                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-plus mr-1"></i>
                            –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                        </button>
                    </div>

                    <div id="recipe-ingredients" class="space-y-3">
                        <!-- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Ä–µ—Ü–µ–ø—Ç–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>

                    <!-- –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="mt-4 pt-4 border-t border-gray-200 bg-gray-50 p-3 rounded-md">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-600">–û–±—â–∏–π –≤–µ—Å:</span>
                                <span id="recipe-total-weight" class="ml-2 font-bold text-gray-900">0 –≥</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                                <span id="recipe-total-cost" class="ml-2 font-bold text-green-600">0 ‚ÇΩ</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">–¶–µ–Ω–∞ –∑–∞ 1 –∫–≥:</span>
                                <span id="recipe-cost-per-kg" class="ml-2 font-bold text-blue-600">0 ‚ÇΩ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideModal('recipe-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ -->
    <div id="categories-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-tags text-orange-600 mr-2"></i>
                    <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∫–∞—à</span>
                </h3>
                <button onclick="hideModal('categories-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
                <div id="categories-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                <div class="flex">
                    <input type="text" id="new-category-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–Ω–¥–µ–π–∫–∞)"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="addCategoryFromModal()" 
                            class="px-3 py-2 bg-green-600 text-white rounded-r-lg hover:bg-green-700">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button onclick="hideModal('categories-modal')" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
    <div id="production-task-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-play-circle text-orange-600 mr-2"></i>
                    <span id="production-task-modal-title">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</span>
                </h3>
                <button onclick="hideModal('production-task-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="production-task-form" onsubmit="saveProductionTask(event)">
                <input type="hidden" id="production-task-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç *</label>
                        <select id="production-recipe-select" required onchange="updateProductionCalculations()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç –∏–∑ –±–∞–∑—ã</option>
                            <!-- –†–µ—Ü–µ–ø—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–û–±—ä–µ–º –ø–∞—Ä—Ç–∏–∏ (–∫–≥) *</label>
                        <input type="number" id="production-batch-size" step="0.1" min="0.1" required onchange="updateProductionCalculations()"
                               placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 50"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ *</label>
                        <input type="date" id="production-date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏</label>
                        <div class="flex">
                            <input type="text" id="production-batch-number" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <button type="button" onclick="generateBatchNumber()" 
                                    class="px-3 py-2 bg-orange-600 text-white rounded-r-lg hover:bg-orange-700">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>
                    </div>
                </div>

                <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –∑–∞–¥–∞–Ω–∏—é</label>
                    <textarea id="production-notes" rows="3" 
                              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideModal('production-task-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md">
                        <i class="fas fa-play mr-2"></i>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø–∞–∫–æ–≤–æ—á–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
    <div id="packaging-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-boxes text-purple-600 mr-2"></i>
                    <span id="packaging-modal-title">–î–æ–±–∞–≤–∏—Ç—å —É–ø–∞–∫–æ–≤–æ—á–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª</span>
                </h3>
                <button onclick="hideModal('packaging-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="packaging-form" onsubmit="savePackaging(event)">
                <input type="hidden" id="packaging-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                        <input type="text" id="packaging-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                        <select id="packaging-type" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="–ø–∞–∫–µ—Ç—ã">–ü–∞–∫–µ—Ç—ã</option>
                            <option value="–∫–æ—Ä–æ–±–∫–∏">–ö–æ—Ä–æ–±–∫–∏</option>
                            <option value="—ç—Ç–∏–∫–µ—Ç–∫–∏">–≠—Ç–∏–∫–µ—Ç–∫–∏</option>
                            <option value="–ø–ª–µ–Ω–∫–∞">–ü–ª–µ–Ω–∫–∞</option>
                            <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–û—Å—Ç–∞—Ç–æ–∫ (—à—Ç) *</label>
                        <input type="number" id="packaging-stock" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (‚ÇΩ) *</label>
                        <input type="number" id="packaging-price" step="0.01" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideModal('packaging-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—Å—Ç—Ä–æ–µ–Ω –≤ HTML -->
    <script>
// JavaScript —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è CRM "–ü–æ–≤–∞—Ä –ë–∏–º" - –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
let ingredients = [];
let recipes = [];
let productionTasks = [];
let packagingMaterials = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadSampleData();
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    showSection('dashboard');
    updateDashboardStats();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    updateCategorySelect();
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
function updateCurrentTime() {
    const now = new Date();
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = now.toLocaleString('ru-RU');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞–º–∏
function showSection(sectionName) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
        targetSection.classList.remove('hidden');
        targetSection.classList.add('fade-in');
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–µ–Ω—é
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    const activeMenuItem = document.querySelector(`[onclick*="${sectionName}"]`);
    if (activeMenuItem) {
        activeMenuItem.classList.add('active');
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–∫—Ü–∏–∏
    switch (sectionName) {
        case 'ingredients':
            loadIngredients();
            break;
        case 'recipes':
            loadRecipes();
            break;
        case 'production':
            loadProductionTasks();
            break;
        case 'packaging':
            loadPackagingMaterials();
            break;
        case 'dashboard':
            updateDashboardStats();
            break;
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
function showModal(modalId, skipReset = false) {
    console.log('üîß showModal called:', modalId, 'skipReset:', skipReset);
    
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        
        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
        if (!skipReset) {
            const form = modal.querySelector('form');
            if (form) {
                console.log('üîß Resetting form for modal:', modalId);
                form.reset();
                // –û—á–∏—Å—Ç–∫–∞ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π ID
                const idField = form.querySelector('input[type="hidden"]');
                if (idField) idField.value = '';
            }
        }

        // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        if (modalId === 'recipe-modal' && !skipReset) {
            console.log('üîß Clearing recipe ingredients for recipe modal');
            clearRecipeIngredients();
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            addIngredientToRecipe();
            
            // –°–±—Ä–æ—Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
            const title = document.getElementById('recipe-modal-title');
            if (title) title.textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const saveBtn = modal.querySelector('button[type="submit"]');
            if (saveBtn) saveBtn.style.display = 'inline-flex';
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è
            const inputs = modal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => input.readOnly = false);
        }
        if (modalId === 'ingredient-modal' && !skipReset) {
            console.log('üîß Opening ingredient modal - this may affect recipe form!');
        }
        if (modalId === 'production-task-modal') {
            loadRecipesForProduction();
            setDefaultProductionDate();
        }
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
    }
}

// –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò
function saveDataToStorage() {
    try {
        localStorage.setItem('povoarBimIngredients', JSON.stringify(ingredients));
        localStorage.setItem('povoarBimRecipes', JSON.stringify(recipes));
        localStorage.setItem('povoarBimProductionTasks', JSON.stringify(productionTasks));
        localStorage.setItem('povoarBimPackagingMaterials', JSON.stringify(packagingMaterials));
    } catch (e) {
        console.error('Error saving to localStorage:', e);
    }
}

function loadDataFromStorage() {
    try {
        const storedIngredients = localStorage.getItem('povoarBimIngredients');
        const storedRecipes = localStorage.getItem('povoarBimRecipes');
        const storedTasks = localStorage.getItem('povoarBimProductionTasks');
        const storedPackaging = localStorage.getItem('povoarBimPackagingMaterials');

        if (storedIngredients) ingredients = JSON.parse(storedIngredients);
        if (storedRecipes) recipes = JSON.parse(storedRecipes);
        if (storedTasks) productionTasks = JSON.parse(storedTasks);
        if (storedPackaging) packagingMaterials = JSON.parse(storedPackaging);
    } catch (e) {
        console.error('Error loading from localStorage:', e);
    }
}

function loadSampleData() {
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
    loadDataFromStorage();

    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã
    if (ingredients.length === 0) {
        ingredients = [
            {
                id: '1',
                name: '–ì–æ–≤—è–¥–∏–Ω–∞ (—Ñ–∞—Ä—à)',
                category: '–º—è—Å–æ',
                stock: 25.5,
                price: 450,
                minStock: 5,
                supplier: '–ú—è—Å–æ–∫–æ–º–±–∏–Ω–∞—Ç "–ü—Ä–µ–º–∏—É–º"',
                description: '–°–≤–µ–∂–∏–π –≥–æ–≤—è–∂–∏–π —Ñ–∞—Ä—à –≤—ã—Å—à–µ–≥–æ —Å–æ—Ä—Ç–∞',
                createdAt: new Date().toISOString()
            },
            {
                id: '2',
                name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ (—Ä—É–±–ª–µ–Ω–∞—è)',
                category: '–º—è—Å–æ',
                stock: 18.2,
                price: 320,
                minStock: 3,
                supplier: '–ü—Ç–∏—Ü–µ—Ñ–∞–±—Ä–∏–∫–∞ "–ó–¥–æ—Ä–æ–≤—å–µ"',
                description: '–î–∏–µ—Ç–∏—á–µ—Å–∫–æ–µ –∫—É—Ä–∏–Ω–æ–µ –º—è—Å–æ –±–µ–∑ –∫–æ–∂–∏',
                createdAt: new Date().toISOString()
            },
            {
                id: '3',
                name: '–§–∏–ª–µ –ª–æ—Å–æ—Å—è',
                category: '—Ä—ã–±–∞',
                stock: 12.8,
                price: 850,
                minStock: 2,
                supplier: '–†—ã–±–Ω—ã–π –¥–æ–º "–û–∫–µ–∞–Ω"',
                description: '–°–≤–µ–∂–µ–µ —Ñ–∏–ª–µ –∞—Ç–ª–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ—Å–æ—Å—è',
                createdAt: new Date().toISOString()
            },
            {
                id: '4',
                name: '–†–∏—Å –±—É—Ä—ã–π',
                category: '–∫—Ä—É–ø—ã',
                stock: 45.0,
                price: 80,
                minStock: 10,
                supplier: '–û–û–û "–ó–¥–æ—Ä–æ–≤—ã–µ –∑–ª–∞–∫–∏"',
                description: '–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π –±—É—Ä—ã–π —Ä–∏—Å, –±–æ–≥–∞—Ç—ã–π –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π',
                createdAt: new Date().toISOString()
            },
            {
                id: '5',
                name: '–ú–æ—Ä–∫–æ–≤—å —Å—É—à–µ–Ω–∞—è',
                category: '–æ–≤–æ—â–∏',
                stock: 8.5,
                price: 120,
                minStock: 2,
                supplier: '–≠–∫–æ-–ü—Ä–æ–¥—É–∫—Ç',
                description: '–ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Å—É—à–µ–Ω–∞—è –º–æ—Ä–∫–æ–≤—å –±–µ–∑ –¥–æ–±–∞–≤–æ–∫',
                createdAt: new Date().toISOString()
            },
            {
                id: '6',
                name: '–í–∏—Ç–∞–º–∏–Ω–Ω–æ-–º–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å',
                category: '–≤–∏—Ç–∞–º–∏–Ω—ã',
                stock: 3.2,
                price: 1200,
                minStock: 0.5,
                supplier: '–í–µ—Ç–§–∞—Ä–º',
                description: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤ –¥–ª—è —Å–æ–±–∞–∫',
                createdAt: new Date().toISOString()
            }
        ];
        saveDataToStorage();
    }
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –î–ê–®–ë–û–†–î–ê
function updateDashboardStats() {
    const totalCustomersEl = document.getElementById('total-customers');
    const totalRecipesEl = document.getElementById('total-recipes');
    const activeProductionEl = document.getElementById('active-production');
    const totalIngredientsEl = document.getElementById('total-ingredients');
    
    if (totalCustomersEl) totalCustomersEl.textContent = '0';
    if (totalRecipesEl) totalRecipesEl.textContent = recipes.length;
    if (activeProductionEl) {
        activeProductionEl.textContent = productionTasks.filter(task => 
            task.status === 'in-production' || task.status === 'active'
        ).length;
    }
    if (totalIngredientsEl) totalIngredientsEl.textContent = ingredients.length;
}

// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–ì–†–ï–î–ò–ï–ù–¢–ê–ú–ò
function saveIngredient(event) {
    event.preventDefault();

    const formData = {
        id: document.getElementById('ingredient-id').value || Date.now().toString(),
        name: document.getElementById('ingredient-name').value,
        category: document.getElementById('ingredient-category').value,
        stock: parseFloat(document.getElementById('ingredient-stock').value),
        price: parseFloat(document.getElementById('ingredient-price').value),
        minStock: parseFloat(document.getElementById('ingredient-min-stock').value) || 0,
        supplier: document.getElementById('ingredient-supplier').value,
        description: document.getElementById('ingredient-description').value,
        createdAt: new Date().toISOString()
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
    const existingIndex = ingredients.findIndex(ing => ing.id === formData.id);
    if (existingIndex >= 0) {
        ingredients[existingIndex] = formData;
    } else {
        ingredients.push(formData);
    }

    saveDataToStorage();
    hideModal('ingredient-modal');
    loadIngredients();
    updateDashboardStats();

    showNotification('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
}

function loadIngredients() {
    const tbody = document.getElementById('ingredients-table');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (ingredients.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-seedling text-4xl mb-3"></i>
                    <p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</p>
                    <button onclick="showModal('ingredient-modal')" 
                            class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>
                        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    ingredients.forEach(ingredient => {
        const status = getIngredientStatus(ingredient);
        const row = `
            <tr class="table-row">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${ingredient.name}</div>
                    <div class="text-sm text-gray-500">${ingredient.description || ''}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        ${ingredient.category}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${ingredient.stock} –∫–≥</div>
                    ${ingredient.minStock > 0 ? `<div class="text-xs text-gray-500">–ú–∏–Ω: ${ingredient.minStock} –∫–≥</div>` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${ingredient.price.toFixed(2)} ‚ÇΩ
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center ${status.class}">
                        <i class="fas ${status.icon} mr-1"></i>
                        ${status.text}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editIngredient('${ingredient.id}')" 
                            class="text-blue-600 hover:text-blue-900 mr-3">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteIngredient('${ingredient.id}')" 
                            class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function getIngredientStatus(ingredient) {
    if (ingredient.stock <= 0) {
        return {
            class: 'status-unavailable',
            icon: 'fa-times-circle',
            text: '–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ'
        };
    } else if (ingredient.minStock > 0 && ingredient.stock <= ingredient.minStock) {
        return {
            class: 'text-yellow-600',
            icon: 'fa-exclamation-triangle',
            text: '–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è'
        };
    } else {
        return {
            class: 'status-available',
            icon: 'fa-check-circle',
            text: '–ï—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ'
        };
    }
}

function editIngredient(id) {
    const ingredient = ingredients.find(ing => ing.id === id);
    if (!ingredient) return;

    document.getElementById('ingredient-id').value = ingredient.id;
    document.getElementById('ingredient-name').value = ingredient.name;
    document.getElementById('ingredient-category').value = ingredient.category;
    document.getElementById('ingredient-stock').value = ingredient.stock;
    document.getElementById('ingredient-price').value = ingredient.price;
    document.getElementById('ingredient-min-stock').value = ingredient.minStock;
    document.getElementById('ingredient-supplier').value = ingredient.supplier || '';
    document.getElementById('ingredient-description').value = ingredient.description || '';

    document.getElementById('ingredient-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç';
    showModal('ingredient-modal');
}

function deleteIngredient(id) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç?')) {
        ingredients = ingredients.filter(ing => ing.id !== id);
        saveDataToStorage();
        loadIngredients();
        updateDashboardStats();
        showNotification('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω', 'success');
    }
}

// –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–¶–ï–ü–¢–ê–ú–ò  
function loadRecipes() {
    const grid = document.getElementById('recipes-grid');
    const empty = document.getElementById('recipes-empty');

    if (!grid || !empty) return;

    if (recipes.length === 0) {
        grid.style.display = 'none';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    grid.style.display = 'grid';
    grid.innerHTML = '';

    recipes.forEach(recipe => {
        const card = `
            <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">${recipe.name}</h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${recipe.category}
                        </span>
                    </div>

                    <p class="text-sm text-gray-600 mb-4">${recipe.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>

                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤:</span>
                            <span class="font-medium">${recipe.ingredients ? recipe.ingredients.length : 0}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">–û–±—â–∏–π –≤–µ—Å:</span>
                            <span class="font-medium">${recipe.totalWeight || 0} –≥</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                            <span class="font-medium text-green-600">${(recipe.totalCost || 0).toFixed(2)} ‚ÇΩ</span>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button onclick="viewRecipe('${recipe.id}')" 
                                class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                            <i class="fas fa-eye mr-1"></i>
                            –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        <div class="space-x-2">
                            <button onclick="editRecipe('${recipe.id}')" 
                                    class="text-orange-600 hover:text-orange-900 text-sm" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="exportRecipeToExcel('${recipe.id}')" 
                                    class="text-green-600 hover:text-green-900 text-sm" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel">
                                <i class="fas fa-file-excel"></i>
                            </button>
                            <button onclick="deleteRecipe('${recipe.id}')" 
                                    class="text-red-600 hover:text-red-900 text-sm" title="–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        grid.innerHTML += card;
    });
}

// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ò–ó–í–û–î–°–¢–í–û–ú
function loadProductionTasks() {
    const tbody = document.getElementById('production-table');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (productionTasks.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-cogs text-4xl mb-3"></i>
                    <p>–ù–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
                    <button onclick="showModal('production-task-modal')" 
                            class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                        <i class="fas fa-plus mr-2"></i>
                        –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    productionTasks.forEach(task => {
        const status = getProductionStatus(task);
        const row = `
            <tr class="table-row">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${task.batchNumber || task.id}</div>
                    <div class="text-sm text-gray-500">${task.recipeName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${task.batchSize || 0} –∫–≥
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${task.productionDate ? new Date(task.productionDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${(task.totalCost || 0).toFixed(2)} ‚ÇΩ</div>
                    <div class="text-xs text-gray-500">${(task.costPerKg || 0).toFixed(2)} ‚ÇΩ/–∫–≥</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${status.class}">
                        ${status.text}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                    <button onclick="viewProductionTask('${task.id}')" 
                            class="text-blue-600 hover:text-blue-900" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞–Ω–∏—è">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="editProductionTask('${task.id}')" 
                            class="text-green-600 hover:text-green-900" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="changeTaskStatus('${task.id}')" 
                            class="text-orange-600 hover:text-orange-900" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button onclick="deleteProductionTask('${task.id}')" 
                            class="text-red-600 hover:text-red-900" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button onclick="exportProductionTask('${task.id}')" 
                            class="text-purple-600 hover:text-purple-900" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function getProductionStatus(task) {
    switch (task.status) {
        case 'draft':
            return { class: 'status-draft', text: '–ß–µ—Ä–Ω–æ–≤–∏–∫' };
        case 'active':
            return { class: 'status-active', text: '–ê–∫—Ç–∏–≤–Ω–æ–µ' };
        case 'in-production':
            return { class: 'status-in-production', text: '–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ' };
        case 'completed':
            return { class: 'status-completed', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' };
        case 'cancelled':
            return { class: 'status-cancelled', text: '–û—Ç–º–µ–Ω–µ–Ω–æ' };
        default:
            return { class: 'status-draft', text: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
    }
}

function loadRecipesForProduction() {
    const select = document.getElementById('production-recipe-select');
    if (!select) return;

    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç –∏–∑ –±–∞–∑—ã</option>';
    
    recipes.forEach(recipe => {
        const option = `<option value="${recipe.id}">${recipe.name} (${recipe.category})</option>`;
        select.innerHTML += option;
    });
}

function setDefaultProductionDate() {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('production-date');
    if (dateInput) {
        dateInput.value = today;
    }
}

// –ö–û–ù–°–¢–†–£–ö–¢–û–† –†–ï–¶–ï–ü–¢–û–í
function clearRecipeIngredients() {
    const container = document.getElementById('recipe-ingredients');
    if (container) {
        container.innerHTML = '';
    }
    updateRecipeCalculations();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
    setTimeout(() => {
        addIngredientToRecipe();
    }, 100);
}

function addIngredientToRecipe() {
    console.log('üîß addIngredientToRecipe called, ingredients count:', ingredients.length);
    
    if (ingredients.length === 0) {
        // –í–º–µ—Å—Ç–æ alert –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
        if (confirm('–£ –≤–∞—Å –Ω–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ. –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç?')) {
            showModal('ingredient-modal');
            return;
        } else {
            return;
        }
    }

    const ingredientsContainer = document.getElementById('recipe-ingredients');
    
    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FIX: –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫
    const existingRows = ingredientsContainer.querySelectorAll('.ingredient-row');
    const savedData = [];
    
    console.log('üîß Existing rows count:', existingRows.length);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
    existingRows.forEach((row, index) => {
        const select = row.querySelector('.ingredient-select');
        const weightInput = row.querySelector('.ingredient-weight');
        const costSpan = row.querySelector('.ingredient-cost');
        
        const data = {
            ingredientId: select ? select.value : '',
            weight: weightInput ? weightInput.value : '',
            cost: costSpan ? costSpan.textContent : '0 ‚ÇΩ'
        };
        
        savedData.push(data);
        console.log(`üîß SAVED row ${index}:`, data);
    });

    const ingredientId = `recipe-ingredient-${Date.now()}`;

    const ingredientRow = `
        <div class="ingredient-row" data-id="${ingredientId}">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <select class="ingredient-select w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            onchange="updateRecipeCalculations()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</option>
                        ${ingredients.map(ing => `
                            <option value="${ing.id}" data-price="${ing.price}" data-stock="${ing.stock}">
                                ${ing.name} (${ing.stock} –∫–≥ –Ω–∞ —Å–∫–ª–∞–¥–µ, ${ing.price} ‚ÇΩ/–∫–≥)
                            </option>
                        `).join('')}
                    </select>
                </div>
                <div class="w-32">
                    <input type="number" step="0.1" min="0" placeholder="–í–µ—Å (–≥)" 
                           class="ingredient-weight w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onchange="updateRecipeCalculations()">
                </div>
                <div class="w-24 text-sm text-gray-600 text-center">
                    <span class="ingredient-cost">0 ‚ÇΩ</span>
                </div>
                <button type="button" onclick="removeIngredientFromRecipe('${ingredientId}')" 
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;

    if (ingredientsContainer) {
        ingredientsContainer.innerHTML += ingredientRow;
        
        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FIX: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const newRows = ingredientsContainer.querySelectorAll('.ingredient-row');
        console.log('üîß New rows count after adding:', newRows.length);
        
        savedData.forEach((data, index) => {
            if (newRows[index]) {
                const select = newRows[index].querySelector('.ingredient-select');
                const weightInput = newRows[index].querySelector('.ingredient-weight');
                const costSpan = newRows[index].querySelector('.ingredient-cost');
                
                if (select && data.ingredientId) {
                    select.value = data.ingredientId;
                    console.log(`üîß RESTORED select ${index}:`, data.ingredientId);
                }
                if (weightInput && data.weight) {
                    weightInput.value = data.weight;
                    console.log(`üîß RESTORED weight ${index}:`, data.weight);
                }
                if (costSpan && data.cost) {
                    costSpan.textContent = data.cost;
                    console.log(`üîß RESTORED cost ${index}:`, data.cost);
                }
            }
        });
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        setTimeout(() => updateRecipeCalculations(), 100);
        console.log('üîß ‚úÖ DATA RESTORATION COMPLETED');
    }
}

function removeIngredientFromRecipe(ingredientId) {
    const element = document.querySelector(`[data-id="${ingredientId}"]`);
    if (element) {
        element.remove();
        updateRecipeCalculations();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
function addRecipeIngredient(ingredientId, weight) {
    const ingredientsContainer = document.getElementById('recipe-ingredients');
    const rowId = `recipe-ingredient-${Date.now()}`;

    const ingredientRow = `
        <div class="ingredient-row" data-id="${rowId}">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <select class="ingredient-select w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            onchange="updateRecipeCalculations()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</option>
                        ${ingredients.map(ing => `
                            <option value="${ing.id}" data-price="${ing.price}" data-stock="${ing.stock}" 
                                    ${ing.id === ingredientId ? 'selected' : ''}>
                                ${ing.name} (${ing.stock} –∫–≥ –Ω–∞ —Å–∫–ª–∞–¥–µ, ${ing.price} ‚ÇΩ/–∫–≥)
                            </option>
                        `).join('')}
                    </select>
                </div>
                <div class="w-32">
                    <input type="number" step="0.1" min="0" placeholder="–í–µ—Å (–≥)" 
                           class="ingredient-weight w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                           value="${weight || ''}"
                           onchange="updateRecipeCalculations()">
                </div>
                <div class="w-24 text-sm text-gray-600 text-center">
                    <span class="ingredient-cost">0 ‚ÇΩ</span>
                </div>
                <button type="button" onclick="removeIngredientFromRecipe('${rowId}')" 
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;

    if (ingredientsContainer) {
        ingredientsContainer.innerHTML += ingredientRow;
    }
}

function updateRecipeCalculations() {
    const ingredientRows = document.querySelectorAll('.ingredient-row');
    let totalWeight = 0;
    let totalCost = 0;

    ingredientRows.forEach(row => {
        const select = row.querySelector('.ingredient-select');
        const weightInput = row.querySelector('.ingredient-weight');
        const costSpan = row.querySelector('.ingredient-cost');

        const selectedOption = select.selectedOptions[0];
        const weight = parseFloat(weightInput.value) || 0;

        if (selectedOption && selectedOption.value && weight > 0) {
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const cost = (weight / 1000) * price; // –≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö, —Ü–µ–Ω–∞ –∑–∞ –∫–≥

            costSpan.textContent = cost.toFixed(2) + ' ‚ÇΩ';
            totalWeight += weight;
            totalCost += cost;
        } else {
            costSpan.textContent = '0 ‚ÇΩ';
        }
    });

    const totalWeightEl = document.getElementById('recipe-total-weight');
    const totalCostEl = document.getElementById('recipe-total-cost');
    const costPerKgEl = document.getElementById('recipe-cost-per-kg');

    if (totalWeightEl) totalWeightEl.textContent = totalWeight + ' –≥';
    if (totalCostEl) totalCostEl.textContent = totalCost.toFixed(2) + ' ‚ÇΩ';
    if (costPerKgEl) costPerKgEl.textContent = totalCost.toFixed(2) + ' ‚ÇΩ';
}

function saveRecipe(event) {
    event.preventDefault();

    const recipeIngredients = getRecipeIngredients();
    if (recipeIngredients.length === 0) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –≤ —Ä–µ—Ü–µ–ø—Ç');
        return;
    }

    const formData = {
        id: document.getElementById('recipe-id').value || Date.now().toString(),
        name: document.getElementById('recipe-name').value,
        category: document.getElementById('recipe-category').value,
        description: document.getElementById('recipe-description').value,
        ingredients: recipeIngredients,
        totalWeight: calculateRecipeTotalWeight(recipeIngredients),
        totalCost: calculateRecipeTotalCost(recipeIngredients),
        createdAt: new Date().toISOString()
    };

    const existingIndex = recipes.findIndex(recipe => recipe.id === formData.id);
    if (existingIndex >= 0) {
        recipes[existingIndex] = formData;
    } else {
        recipes.push(formData);
    }

    saveDataToStorage();
    hideModal('recipe-modal');
    loadRecipes();
    updateDashboardStats();

    showNotification('–†–µ—Ü–µ–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
}

function getRecipeIngredients() {
    const ingredientRows = document.querySelectorAll('.ingredient-row');
    const recipeIngredients = [];

    ingredientRows.forEach(row => {
        const select = row.querySelector('.ingredient-select');
        const weightInput = row.querySelector('.ingredient-weight');

        const ingredientId = select.value;
        const weight = parseFloat(weightInput.value) || 0;

        if (ingredientId && weight > 0) {
            const ingredient = ingredients.find(ing => ing.id === ingredientId);
            if (ingredient) {
                recipeIngredients.push({
                    ingredientId: ingredientId,
                    name: ingredient.name,
                    weight: weight,
                    price: ingredient.price,
                    cost: (weight / 1000) * ingredient.price
                });
            }
        }
    });

    return recipeIngredients;
}

function calculateRecipeTotalWeight(ingredients) {
    return ingredients.reduce((total, ing) => total + ing.weight, 0);
}

function calculateRecipeTotalCost(ingredients) {
    return ingredients.reduce((total, ing) => total + ing.cost, 0);
}

// –£–ü–ê–ö–û–í–û–ß–ù–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´
function loadPackagingMaterials() {
    const tbody = document.getElementById('packaging-table');
    if (!tbody) return;

    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                <i class="fas fa-boxes text-4xl mb-3"></i>
                <p>–§—É–Ω–∫—Ü–∏—è —É–ø–∞–∫–æ–≤–æ—á–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
            </td>
        </tr>
    `;
}

function savePackaging(event) {
    event.preventDefault();
    showNotification('–§—É–Ω–∫—Ü–∏—è —É–ø–∞–∫–æ–≤–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    hideModal('packaging-modal');
}

// –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
    
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    notification.className += ` ${bgColor} text-white`;
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle mr-3"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // –°–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏
function viewRecipe(id) {
    console.log('üîß viewRecipe called with id:', id);
    
    const recipes = JSON.parse(localStorage.getItem('povoarBimRecipes')) || [];
    console.log('üîß Found recipes:', recipes.length);
    
    const recipe = recipes.find(r => r.id == id);
    console.log('üîß Found recipe:', recipe);
    
    if (!recipe) {
        console.error('üîß Recipe not found with id:', id);
        showNotification('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
    document.getElementById('recipe-name').value = recipe.name;
    document.getElementById('recipe-category').value = recipe.category;
    document.getElementById('recipe-description').value = recipe.description || '';
    
    // –û—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Ä–µ—Ü–µ–ø—Ç–∞
    clearRecipeIngredients();
    
    console.log('üîß Recipe ingredients:', recipe.ingredients);
    
    if (recipe.ingredients && recipe.ingredients.length > 0) {
        recipe.ingredients.forEach((ingredient, index) => {
            console.log(`üîß Adding ingredient ${index}:`, ingredient);
            const ingredientId = ingredient.ingredientId || ingredient.id;
            addRecipeIngredient(ingredientId, ingredient.weight);
        });
    }
    
    // –î–µ–ª–∞–µ–º –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
    const modal = document.getElementById('recipe-modal');
    const inputs = modal.querySelectorAll('input, select, textarea');
    inputs.forEach(input => input.readOnly = true);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = modal.querySelector('button[type="submit"]');
    if (saveBtn) saveBtn.style.display = 'none';
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('recipe-modal-title');
    if (title) title.textContent = `–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ—Ü–µ–ø—Ç–∞: ${recipe.name}`;
    
    console.log('üîß Opening recipe modal for viewing');
    showModal('recipe-modal', true);
}

function editRecipe(id) {
    console.log('üîß editRecipe called with id:', id);
    
    const recipes = JSON.parse(localStorage.getItem('povoarBimRecipes')) || [];
    console.log('üîß Found recipes:', recipes.length);
    
    const recipe = recipes.find(r => r.id == id);
    console.log('üîß Found recipe for editing:', recipe);
    
    if (!recipe) {
        console.error('üîß Recipe not found for editing with id:', id);
        showNotification('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ —Ä–µ—Ü–µ–ø—Ç–∞
    document.getElementById('recipe-id').value = recipe.id;
    document.getElementById('recipe-name').value = recipe.name;
    document.getElementById('recipe-category').value = recipe.category;
    document.getElementById('recipe-description').value = recipe.description || '';
    
    // –û—á–∏—Å—Ç–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
    clearRecipeIngredients();
    
    console.log('üîß Recipe ingredients for editing:', recipe.ingredients);
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Ä–µ—Ü–µ–ø—Ç–∞
    if (recipe.ingredients && recipe.ingredients.length > 0) {
        recipe.ingredients.forEach((ingredient, index) => {
            console.log(`üîß Adding ingredient ${index} for editing:`, ingredient);
            const ingredientId = ingredient.ingredientId || ingredient.id;
            addRecipeIngredient(ingredientId, ingredient.weight);
        });
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const modal = document.getElementById('recipe-modal');
    const inputs = modal.querySelectorAll('input, select, textarea');
    inputs.forEach(input => input.readOnly = false);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = modal.querySelector('button[type="submit"]');
    if (saveBtn) saveBtn.style.display = 'inline-flex';
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('recipe-modal-title');
    if (title) title.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç: ${recipe.name}`;
    
    console.log('üîß Opening recipe modal for editing');
    updateRecipeCalculations();
    showModal('recipe-modal', true);
}

function deleteRecipe(id) {
    console.log('üîß deleteRecipe called with id:', id);
    
    const recipes = JSON.parse(localStorage.getItem('povoarBimRecipes')) || [];
    const recipe = recipes.find(r => r.id == id);
    
    if (!recipe) {
        console.error('üîß Recipe not found for deletion with id:', id);
        showNotification('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç "${recipe.name}"?`)) {
        console.log('üîß Deleting recipe:', recipe.name);
        
        let updatedRecipes = recipes.filter(r => r.id != id);
        localStorage.setItem('povoarBimRecipes', JSON.stringify(updatedRecipes));
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ recipes
        window.recipes = updatedRecipes;
        
        loadRecipes();
        updateDashboardStats();
        showNotification(`–†–µ—Ü–µ–ø—Ç "${recipe.name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`, 'success');
        
        console.log('üîß Recipe deleted successfully');
    }
}

// –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò –†–ï–¶–ï–ü–¢–û–í
let customCategories = JSON.parse(localStorage.getItem('povoarBimCategories')) || [];

function getDefaultCategories() {
    return [
        { value: '–≥–æ–≤—è–¥–∏–Ω–∞', name: '–ì–æ–≤—è–¥–∏–Ω–∞', default: true },
        { value: '–∫—É—Ä–∏—Ü–∞', name: '–ö—É—Ä–∏—Ü–∞', default: true },
        { value: '–ª–æ—Å–æ—Å—å', name: '–õ–æ—Å–æ—Å—å', default: true },
        { value: '–ª–∞–π—Ç', name: '–õ–∞–π—Ç (–¥–∏–µ—Ç–∏—á–µ—Å–∫–∞—è)', default: true }
    ];
}

function getAllCategories() {
    const defaultCategories = getDefaultCategories();
    const allCategories = [...defaultCategories, ...customCategories];
    return allCategories;
}

function saveCategoriesState() {
    localStorage.setItem('povoarBimCategories', JSON.stringify(customCategories));
}

function updateCategorySelect() {
    const categorySelect = document.getElementById('recipe-category');
    if (!categorySelect) return;
    
    const selectedValue = categorySelect.value;
    const categories = getAllCategories();
    
    // –û—á–∏—â–∞–µ–º select –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π –æ–ø—Ü–∏–∏
    categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.value;
        option.textContent = cat.name;
        categorySelect.appendChild(option);
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if (selectedValue) {
        categorySelect.value = selectedValue;
    }
}

function addNewCategory() {
    const categoryName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞—à–∏:');
    
    if (categoryName && categoryName.trim()) {
        const cleanName = categoryName.trim().toLowerCase();
        const displayName = categoryName.trim();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—â–µ –Ω–µ—Ç
        const allCategories = getAllCategories();
        const exists = allCategories.some(cat => cat.value === cleanName);
        
        if (exists) {
            showNotification('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        customCategories.push({
            value: cleanName,
            name: displayName,
            default: false
        });
        
        saveCategoriesState();
        updateCategorySelect();
        
        // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        const categorySelect = document.getElementById('recipe-category');
        categorySelect.value = cleanName;
        
        showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${displayName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
    }
}

function manageCategoriesModal() {
    loadCategoriesList();
    showModal('categories-modal');
}

function loadCategoriesList() {
    const categoriesList = document.getElementById('categories-list');
    if (!categoriesList) return;
    
    const allCategories = getAllCategories();
    
    categoriesList.innerHTML = '';
    
    allCategories.forEach(category => {
        const categoryItem = document.createElement('div');
        categoryItem.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md';
        
        const canDelete = !category.default; // –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ
        
        categoryItem.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${category.default ? 'fa-tag' : 'fa-user-tag'} text-blue-600 mr-2"></i>
                <span class="text-sm font-medium">${category.name}</span>
                ${category.default ? '<span class="ml-2 text-xs text-gray-500">(–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</span>' : ''}
            </div>
            <div>
                ${canDelete ? `
                    <button onclick="deleteCategory('${category.value}')" 
                            class="text-red-600 hover:text-red-900 text-sm" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <span class="text-xs text-gray-400">—Å–∏—Å—Ç–µ–º–Ω–∞—è</span>
                `}
            </div>
        `;
        
        categoriesList.appendChild(categoryItem);
    });
}

function addCategoryFromModal() {
    const input = document.getElementById('new-category-name');
    const categoryName = input.value.trim();
    
    if (!categoryName) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'warning');
        return;
    }
    
    const cleanName = categoryName.toLowerCase();
    const allCategories = getAllCategories();
    const exists = allCategories.some(cat => cat.value === cleanName);
    
    if (exists) {
        showNotification('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    customCategories.push({
        value: cleanName,
        name: categoryName,
        default: false
    });
    
    saveCategoriesState();
    updateCategorySelect();
    loadCategoriesList();
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    input.value = '';
    
    showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${categoryName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
}

function deleteCategory(categoryValue) {
    const category = customCategories.find(cat => cat.value === categoryValue);
    if (!category) return;
    
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category.name}"?`)) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        customCategories = customCategories.filter(cat => cat.value !== categoryValue);
        
        saveCategoriesState();
        updateCategorySelect();
        loadCategoriesList();
        
        showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${category.name}" —É–¥–∞–ª–µ–Ω–∞`, 'success');
    }
}

// –§–£–ù–ö–¶–ò–Ø –≠–ö–°–ü–û–†–¢–ê –†–ï–¶–ï–ü–¢–ê –í EXCEL
function exportRecipeToExcel(id) {
    console.log('üîß exportRecipeToExcel called with id:', id);
    
    const recipes = JSON.parse(localStorage.getItem('povoarBimRecipes')) || [];
    const recipe = recipes.find(r => r.id == id);
    
    if (!recipe) {
        console.error('üîß Recipe not found for export with id:', id);
        showNotification('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel
    const exportData = [
        [`–†–ï–¶–ï–ü–¢ –ö–ê–®–ò "–ü–û–í–ê–† –ë–ò–ú"`],
        [''],
        ['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞:', recipe.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'],
        ['–ö–∞—Ç–µ–≥–æ—Ä–∏—è:', recipe.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'],
        ['–û–ø–∏—Å–∞–Ω–∏–µ:', recipe.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'],
        ['–û–±—â–∏–π –≤–µ—Å (1 –∫–≥):', `${recipe.totalWeight || 0} –≥`],
        ['–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (1 –∫–≥):', `${(recipe.totalCost || 0).toFixed(2)} ‚ÇΩ`],
        ['–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:', recipe.createdAt ? new Date(recipe.createdAt).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'],
        [''],
        ['–°–û–°–¢–ê–í –†–ï–¶–ï–ü–¢–ê (–Ω–∞ 1 –∫–≥):'],
        ['‚Ññ', '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≥)', '–¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ)', '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)']
    ];
    
    if (recipe.ingredients && recipe.ingredients.length > 0) {
        recipe.ingredients.forEach((ingredient, index) => {
            exportData.push([
                index + 1,
                ingredient.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç',
                `${ingredient.weight || 0} –≥`,
                `${(ingredient.price || 0).toFixed(2)} ‚ÇΩ`,
                `${(ingredient.cost || 0).toFixed(2)} ‚ÇΩ`
            ]);
        });
        
        exportData.push(['']);
        exportData.push(['–ò–¢–û–ì–û:', '', `${recipe.totalWeight || 0} –≥`, '', `${(recipe.totalCost || 0).toFixed(2)} ‚ÇΩ`]);
    } else {
        exportData.push(['–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã']);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∏—â–µ–≤–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    exportData.push(['']);
    exportData.push(['–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:']);
    exportData.push(['–¶–µ–Ω–∞ –∑–∞ 100–≥:', `${((recipe.totalCost || 0) / 10).toFixed(2)} ‚ÇΩ`]);
    exportData.push(['–†–∞—Å—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞ 10 –∫–≥:', `${((recipe.totalCost || 0) * 10).toFixed(2)} ‚ÇΩ`]);
    exportData.push(['–†–∞—Å—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞ 50 –∫–≥:', `${((recipe.totalCost || 0) * 50).toFixed(2)} ‚ÇΩ`]);
    exportData.push(['–†–∞—Å—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞ 100 –∫–≥:', `${((recipe.totalCost || 0) * 100).toFixed(2)} ‚ÇΩ`]);
    
    // –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
    const colWidths = [
        { wch: 5 },  // ‚Ññ
        { wch: 30 }, // –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
        { wch: 15 }, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
        { wch: 15 }, // –¶–µ–Ω–∞
        { wch: 15 }  // –°—Ç–æ–∏–º–æ—Å—Ç—å
    ];
    ws['!cols'] = colWidths;
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–†–µ—Ü–µ–ø—Ç');
    
    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const fileName = `recept-${recipe.name?.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '_') || 'recipe'}-${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification(`–†–µ—Ü–µ–ø—Ç "${recipe.name}" —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ Excel`, 'success');
    console.log('üîß Recipe exported successfully');
}

// –ü–û–õ–ù–´–ï –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ú–ò –ó–ê–î–ê–ù–ò–Ø–ú–ò

function viewProductionTask(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    document.getElementById('production-task-id').value = task.id;
    document.getElementById('production-recipe-select').value = task.recipeId;
    document.getElementById('production-batch-size').value = task.batchSize;
    document.getElementById('production-date').value = task.productionDate;
    document.getElementById('production-batch-number').value = task.batchNumber;
    document.getElementById('production-notes').value = task.notes || '';
    
    // –î–µ–ª–∞–µ–º –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
    const modal = document.getElementById('production-task-modal');
    const inputs = modal.querySelectorAll('input, select, textarea');
    inputs.forEach(input => input.readOnly = true);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = modal.querySelector('button[type="submit"]');
    if (saveBtn) saveBtn.style.display = 'none';
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('production-task-modal-title');
    if (title) title.textContent = `–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞–Ω–∏—è ${task.batchNumber}`;
    
    showModal('production-task-modal', true);
}

function editProductionTask(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è
    document.getElementById('production-task-id').value = task.id;
    document.getElementById('production-recipe-select').value = task.recipeId;
    document.getElementById('production-batch-size').value = task.batchSize;
    document.getElementById('production-date').value = task.productionDate;
    document.getElementById('production-batch-number').value = task.batchNumber;
    document.getElementById('production-notes').value = task.notes || '';
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const modal = document.getElementById('production-task-modal');
    const inputs = modal.querySelectorAll('input, select, textarea');
    inputs.forEach(input => input.readOnly = false);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = modal.querySelector('button[type="submit"]');
    if (saveBtn) saveBtn.style.display = 'inline-flex';
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('production-task-modal-title');
    if (title) title.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ ${task.batchNumber}`;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç—ã
    updateProductionCalculations();
    
    showModal('production-task-modal', true);
}

function deleteProductionTask(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ ${task.batchNumber || task.id}?`)) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        const index = productionTasks.findIndex(t => t.id === id);
        if (index !== -1) {
            productionTasks.splice(index, 1);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('productionTasks', JSON.stringify(productionTasks));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        loadProductionTasks();
        updateDashboardStats();
        
        showNotification('–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
    }
}

function changeTaskStatus(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    const statuses = [
        { value: 'draft', label: '–ß–µ—Ä–Ω–æ–≤–∏–∫' },
        { value: 'active', label: '–ê–∫—Ç–∏–≤–Ω–æ–µ' },
        { value: 'in-production', label: '–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ' },
        { value: 'completed', label: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' },
        { value: 'cancelled', label: '–û—Ç–º–µ–Ω–µ–Ω–æ' }
    ];
    
    // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
    const currentStatus = task.status || 'draft';
    const statusOptions = statuses.map(s => 
        `<option value="${s.value}" ${s.value === currentStatus ? 'selected' : ''}>${s.label}</option>`
    ).join('');
    
    const newStatus = prompt(
        `–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ${statuses.find(s => s.value === currentStatus)?.label}
        
–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞:
1 - –ß–µ—Ä–Ω–æ–≤–∏–∫
2 - –ê–∫—Ç–∏–≤–Ω–æ–µ  
3 - –í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ
4 - –ó–∞–≤–µ—Ä—à–µ–Ω–æ
5 - –û—Ç–º–µ–Ω–µ–Ω–æ`,
        currentStatus === 'draft' ? '1' : 
        currentStatus === 'active' ? '2' :
        currentStatus === 'in-production' ? '3' :
        currentStatus === 'completed' ? '4' : '5'
    );
    
    const statusMap = {
        '1': 'draft',
        '2': 'active', 
        '3': 'in-production',
        '4': 'completed',
        '5': 'cancelled'
    };
    
    if (newStatus && statusMap[newStatus]) {
        task.status = statusMap[newStatus];
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        localStorage.setItem('productionTasks', JSON.stringify(productionTasks));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        loadProductionTasks();
        
        const statusLabel = statuses.find(s => s.value === task.status)?.label;
        showNotification(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${statusLabel}`, 'success');
    }
}

function exportProductionTask(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ü–µ–ø—Ç –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
    const recipe = recipes.find(r => r.id === task.recipeId);
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel
    const exportData = [
        ['–ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–û–ï –ó–ê–î–ê–ù–ò–ï'],
        ['–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏:', task.batchNumber || task.id],
        ['–†–µ—Ü–µ–ø—Ç:', task.recipeName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'],
        ['–û–±—ä–µ–º –ø–∞—Ä—Ç–∏–∏:', `${task.batchSize} –∫–≥`],
        ['–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞:', task.productionDate ? new Date(task.productionDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'],
        ['–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:', `${(task.totalCost || 0).toFixed(2)} ‚ÇΩ`],
        ['–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:', `${(task.costPerKg || 0).toFixed(2)} ‚ÇΩ/–∫–≥`],
        ['–°—Ç–∞—Ç—É—Å:', getProductionStatus(task).text],
        [''],
        ['–°–û–°–¢–ê–í –†–ï–¶–ï–ü–¢–ê (–Ω–∞ 1 –∫–≥):']
    ];
    
    if (recipe && recipe.ingredients) {
        exportData.push(['–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≥)', '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)']);
        recipe.ingredients.forEach(ing => {
            exportData.push([
                ing.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç',
                `${ing.weight} –≥`,
                `${(ing.cost || 0).toFixed(2)} ‚ÇΩ`
            ]);
        });
        exportData.push(['']);
        exportData.push(['–û–ë–©–ò–ô –†–ê–°–ß–ï–¢ –ù–ê –ü–ê–†–¢–ò–Æ:']);
        exportData.push(['–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç', '–ù–∞ –ø–∞—Ä—Ç–∏—é (–∫–≥)', '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)']);
        recipe.ingredients.forEach(ing => {
            const totalWeight = (ing.weight / 1000) * task.batchSize;
            const totalCost = ing.cost * task.batchSize;
            exportData.push([
                ing.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç',
                `${totalWeight.toFixed(3)} –∫–≥`,
                `${totalCost.toFixed(2)} ‚ÇΩ`
            ]);
        });
    }
    
    if (task.notes) {
        exportData.push(['']);
        exportData.push(['–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:', task.notes]);
    }
    
    // –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ');
    
    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const fileName = `zadanie-${task.batchNumber || task.id}-${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification('–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ Excel', 'success');
}
function clearIngredientFilters() { loadIngredients(); }
function clearProductionFilters() { loadProductionTasks(); }
function filterIngredients() { /* –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ */ }

// –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ü–†–û–ò–ó–í–û–î–°–¢–í–ê
function generateBatchNumber() {
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
    
    // –ù–∞–π—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    const todayBatches = productionTasks.filter(task => 
        task.batchNumber && task.batchNumber.startsWith(dateStr)
    );
    
    let maxNumber = 0;
    todayBatches.forEach(task => {
        const numberMatch = task.batchNumber.match(/(\d+)$/);
        if (numberMatch) {
            maxNumber = Math.max(maxNumber, parseInt(numberMatch[1]));
        }
    });

    const newBatchNumber = dateStr + '-' + String(maxNumber + 1).padStart(3, '0');
    const batchNumberInput = document.getElementById('production-batch-number');
    if (batchNumberInput) {
        batchNumberInput.value = newBatchNumber;
    }
}

function updateProductionCalculations() {
    const recipeId = document.getElementById('production-recipe-select').value;
    const batchSize = parseFloat(document.getElementById('production-batch-size').value) || 0;

    if (!recipeId || batchSize <= 0) {
        return;
    }

    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe || !recipe.ingredients) return;

    // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
    let totalCost = 0;
    recipe.ingredients.forEach(recipeIng => {
        const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
        if (ingredient) {
            const neededWeight = (recipeIng.weight * batchSize) / 1000; // –≤ –∫–≥
            const ingredientCost = neededWeight * ingredient.price;
            totalCost += ingredientCost;
        }
    });

    showNotification(`–†–∞—Å—á–µ—Ç –¥–ª—è –ø–∞—Ä—Ç–∏–∏ ${batchSize} –∫–≥: ${totalCost.toFixed(2)} ‚ÇΩ`, 'info');
}

function saveProductionTask(event) {
    event.preventDefault();

    const recipeId = document.getElementById('production-recipe-select').value;
    const batchSize = parseFloat(document.getElementById('production-batch-size').value);
    let batchNumber = document.getElementById('production-batch-number').value;

    if (!recipeId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç');
        return;
    }

    if (!batchSize || batchSize <= 0) {
        alert('–£–∫–∞–∂–∏—Ç–µ –æ–±—ä–µ–º –ø–∞—Ä—Ç–∏–∏');
        return;
    }

    if (!batchNumber) {
        generateBatchNumber();
        batchNumber = document.getElementById('production-batch-number').value;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –ø–∞—Ä—Ç–∏–∏
    const existingBatch = productionTasks.find(task => task.batchNumber === batchNumber);
    if (existingBatch) {
        const confirmOverride = confirm(`–ü–∞—Ä—Ç–∏—è —Å –Ω–æ–º–µ—Ä–æ–º ${batchNumber} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä?`);
        if (confirmOverride) {
            generateBatchNumber();
            batchNumber = document.getElementById('production-batch-number').value;
        } else {
            return;
        }
    }

    const recipe = recipes.find(r => r.id === recipeId);
    
    // –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–∞—Ä—Ç–∏–∏
    let totalCost = 0;
    if (recipe && recipe.ingredients) {
        recipe.ingredients.forEach(recipeIng => {
            const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
            if (ingredient) {
                const neededWeight = (recipeIng.weight * batchSize) / 1000; // –≤ –∫–≥
                const ingredientCost = neededWeight * ingredient.price;
                totalCost += ingredientCost;
            }
        });
    }

    const taskData = {
        id: document.getElementById('production-task-id').value || Date.now().toString(),
        recipeId: recipeId,
        recipeName: recipe ? recipe.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç',
        batchSize: batchSize,
        batchNumber: batchNumber,
        productionDate: document.getElementById('production-date').value,
        totalCost: totalCost,
        costPerKg: totalCost / batchSize,
        status: 'in-production',
        createdAt: new Date().toISOString(),
        startedAt: new Date().toISOString()
    };

    // –°–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å–æ —Å–∫–ª–∞–¥–∞
    if (recipe && recipe.ingredients) {
        recipe.ingredients.forEach(recipeIng => {
            const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
            if (ingredient) {
                const neededWeight = (recipeIng.weight * batchSize) / 1000; // –≤ –∫–≥
                ingredient.stock = Math.max(0, ingredient.stock - neededWeight);
            }
        });
    }

    const existingIndex = productionTasks.findIndex(task => task.id === taskData.id);
    if (existingIndex >= 0) {
        productionTasks[existingIndex] = taskData;
    } else {
        productionTasks.push(taskData);
    }

    saveDataToStorage();
    hideModal('production-task-modal');
    loadProductionTasks();
    loadIngredients(); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
    updateDashboardStats();

    showNotification(`–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ ${batchNumber} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ! –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: ${totalCost.toFixed(2)} ‚ÇΩ`, 'success');
}

    </script>
</body>
</html>