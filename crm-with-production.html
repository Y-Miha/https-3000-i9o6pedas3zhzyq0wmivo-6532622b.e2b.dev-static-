<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM "–ü–æ–≤–∞—Ä –ë–∏–º" - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•ò</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .nav-item:hover {
            background-color: #f3f4f6;
            border-radius: 8px;
        }
        .table-row:hover {
            background-color: #f9fafb;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal {
            display: none;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.show {
            display: flex !important;
        }
        .modal.fixed {
            position: fixed;
        }
        .modal-container {
            max-height: 95vh;
            overflow-y: auto;
            margin: 2.5vh auto;
        }
        
        /* –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ */
        .badge-physical { @apply bg-blue-100 text-blue-800; }
        .badge-legal { @apply bg-purple-100 text-purple-800; }
        .badge-store { @apply bg-green-100 text-green-800; }
        .badge-wholesale { @apply bg-orange-100 text-orange-800; }
        .badge-company { @apply bg-gray-100 text-gray-800; }
        .badge-active { @apply bg-green-100 text-green-800; }
        .badge-inactive { @apply bg-red-100 text-red-800; }
        
        /* –°—Ç–∞—Ç—É—Å—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ */
        .status-available { @apply text-green-600; }
        .status-unavailable { @apply text-red-600; }
        
        /* –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã */
        .status-draft { @apply bg-gray-100 text-gray-800; }
        .status-active { @apply bg-blue-100 text-blue-800; }
        .status-in-production { @apply bg-yellow-100 text-yellow-800; }
        .status-completed { @apply bg-green-100 text-green-800; }
        .status-cancelled { @apply bg-red-100 text-red-800; }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ */
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #10b981;
            transition: width 0.3s ease;
        }
        
        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–µ–Ω—é */
        .nav-item.active {
            background-color: #fed7aa;
            color: #ea580c;
            border-radius: 8px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ */
        .ingredient-row {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
        }
        .ingredient-row:hover {
            border-color: #d97706;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* –ü–µ—á–∞—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { font-size: 12px; }
            .modal { position: static; background: white; display: block !important; }
            .modal-container { max-height: none; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- –®–∞–ø–∫–∞ -->
    <header class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-dog text-2xl text-orange-600 mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">CRM "–ü–æ–≤–∞—Ä –ë–∏–º" - –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h1>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="current-time"></span>
                </div>
            </div>
        </div>
    </header>

    <div class="flex min-h-screen">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="w-64 bg-white shadow-sm border-r no-print">
            <nav class="mt-5 px-2">
                <a href="#" onclick="showSection('dashboard')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                    <i class="fas fa-chart-bar text-gray-400 mr-3 text-lg"></i>
                    –î–∞—à–±–æ—Ä–¥
                </a>
                
                <a href="#" onclick="showSection('customers')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                    <i class="fas fa-users text-gray-400 mr-3 text-lg"></i>
                    –ö–ª–∏–µ–Ω—Ç—ã
                </a>
                
                <a href="#" onclick="showSection('products')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                    <i class="fas fa-box text-gray-400 mr-3 text-lg"></i>
                    –¢–æ–≤–∞—Ä—ã
                </a>
                
                <a href="#" onclick="showSection('orders')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                    <i class="fas fa-shopping-cart text-gray-400 mr-3 text-lg"></i>
                    –ó–∞–∫–∞–∑—ã
                </a>

                <!-- –ù–û–í–´–ï –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ï –ú–û–î–£–õ–ò -->
                <div class="mt-6 border-t pt-6">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
                        <i class="fas fa-industry mr-2"></i>
                        –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    </h3>
                    
                    <a href="#" onclick="showSection('ingredients')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-seedling text-gray-400 mr-3 text-lg"></i>
                        –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
                    </a>
                    
                    <a href="#" onclick="showSection('recipes')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-clipboard-list text-gray-400 mr-3 text-lg"></i>
                        –†–µ—Ü–µ–ø—Ç—ã
                    </a>
                    
                    <a href="#" onclick="showSection('production')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-cogs text-gray-400 mr-3 text-lg"></i>
                        –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    </a>
                    
                    <a href="#" onclick="showSection('packaging')" class="nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-boxes text-gray-400 mr-3 text-lg"></i>
                        –£–ø–∞–∫–æ–≤–∫–∞
                    </a>
                </div>

                <div class="mt-8">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
                        –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                    </h3>
                    
                    <button onclick="showSection('recipes'); showModal('recipe-modal')" 
                            class="w-full nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-plus-circle text-gray-400 mr-3 text-lg"></i>
                        –ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç
                    </button>
                    
                    <button onclick="showSection('production'); showModal('production-task-modal')" 
                            class="w-full nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-play-circle text-gray-400 mr-3 text-lg"></i>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    </button>
                    
                    <button onclick="showSection('customers'); showModal('customer-modal')" 
                            class="w-full nav-item group flex items-center px-2 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                        <i class="fas fa-user-plus text-gray-400 mr-3 text-lg"></i>
                        –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                    </button>
                </div>
            </nav>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="flex-1 relative z-0 overflow-y-auto focus:outline-none">
            <!-- –î–∞—à–±–æ—Ä–¥ -->
            <section id="dashboard-section" class="section">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-tachometer-alt text-orange-600 mr-3"></i>
                                –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∞—à–±–æ—Ä–¥
                            </h2>
                        </div>

                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-users text-2xl text-orange-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–ö–ª–∏–µ–Ω—Ç—ã</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="total-customers">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-clipboard-list text-2xl text-blue-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–†–µ—Ü–µ–ø—Ç—ã</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="total-recipes">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-cogs text-2xl text-green-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="active-production">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-seedling text-2xl text-purple-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="total-ingredients">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-ruble-sign text-2xl text-indigo-500"></i>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">–í—ã—Ä—É—á–∫–∞</dt>
                                                <dd class="text-lg font-medium text-gray-900" id="monthly-revenue">0 ‚ÇΩ</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É -->
                        <div class="bg-white shadow rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">
                                <i class="fas fa-bolt text-orange-600 mr-2"></i>
                                –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button onclick="showSection('recipes'); showModal('recipe-modal')"
                                        class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-orange-50 hover:border-orange-300 transition-colors">
                                    <i class="fas fa-plus-circle text-orange-600 text-2xl mb-2"></i>
                                    <span class="text-sm font-medium text-center">–°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç</span>
                                </button>
                                
                                <button onclick="showSection('production'); showModal('production-task-modal')"
                                        class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors">
                                    <i class="fas fa-play-circle text-blue-600 text-2xl mb-2"></i>
                                    <span class="text-sm font-medium text-center">–ó–∞–ø—É—Å–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</span>
                                </button>
                                
                                <button onclick="showSection('ingredients'); showModal('ingredient-modal')"
                                        class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition-colors">
                                    <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                                    <span class="text-sm font-medium text-center">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</span>
                                </button>
                                
                                <button onclick="showSection('packaging'); showModal('packaging-modal')"
                                        class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 transition-colors">
                                    <i class="fas fa-boxes text-purple-600 text-2xl mb-2"></i>
                                    <span class="text-sm font-medium text-center">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø–∞–∫–æ–≤–∫–æ–π</span>
                                </button>
                            </div>
                        </div>

                        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è -->
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">
                                <i class="fas fa-tasks text-blue-600 mr-2"></i>
                                –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
                            </h3>
                            <div id="active-production-tasks" class="space-y-4">
                                <div class="text-gray-500 text-center py-8">
                                    <i class="fas fa-clipboard-check text-4xl mb-3"></i>
                                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
                                    <button onclick="showSection('production'); showModal('production-task-modal')" 
                                            class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                                        <i class="fas fa-plus mr-2"></i>
                                        –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ú–û–î–£–õ–¨ –ò–ù–ì–†–ï–î–ò–ï–ù–¢–´ -->
            <section id="ingredients-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-seedling text-green-600 mr-3"></i>
                                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏
                            </h2>
                            <button onclick="showModal('ingredient-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                <i class="fas fa-plus mr-2"></i>
                                –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                            </button>
                        </div>

                        <!-- –§–∏–ª—å—Ç—Ä—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ -->
                        <div class="bg-white shadow rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü–æ–∏—Å–∫</label>
                                    <input type="text" id="ingredient-search" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞" onkeyup="filterIngredients()"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                    <select id="ingredient-category-filter" onchange="filterIngredients()"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                        <option value="–º—è—Å–æ">–ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞</option>
                                        <option value="—Ä—ã–±–∞">–†—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</option>
                                        <option value="–∫—Ä—É–ø—ã">–ö—Ä—É–ø—ã –∏ –∑–ª–∞–∫–∏</option>
                                        <option value="–æ–≤–æ—â–∏">–û–≤–æ—â–∏</option>
                                        <option value="–≤–∏—Ç–∞–º–∏–Ω—ã">–í–∏—Ç–∞–º–∏–Ω—ã –∏ –º–∏–Ω–µ—Ä–∞–ª—ã</option>
                                        <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–ª–∏—á–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                                    <select id="ingredient-availability-filter" onchange="filterIngredients()"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">–í—Å–µ</option>
                                        <option value="available">–ï—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ</option>
                                        <option value="low">–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è</option>
                                        <option value="unavailable">–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="clearIngredientFilters()" 
                                            class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –¶–µ–Ω–∞ –∑–∞ –∫–≥
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—Ç–∞—Ç—É—Å
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="ingredients-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ú–û–î–£–õ–¨ –†–ï–¶–ï–ü–¢–´ -->
            <section id="recipes-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-clipboard-list text-blue-600 mr-3"></i>
                                –ë–∞–∑–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∫–∞—à "–ü–æ–≤–∞—Ä –ë–∏–º"
                            </h2>
                            <button onclick="showModal('recipe-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>
                                –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç
                            </button>
                        </div>

                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤ -->
                        <div id="recipes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- –†–µ—Ü–µ–ø—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>

                        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                        <div id="recipes-empty" class="text-center py-12 hidden">
                            <i class="fas fa-clipboard-list text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤</h3>
                            <p class="text-gray-500 mb-6">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–µ—Ü–µ–ø—Ç –∫–∞—à–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</p>
                            <button onclick="showModal('recipe-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>
                                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ä–µ—Ü–µ–ø—Ç
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ú–û–î–£–õ–¨ –ü–†–û–ò–ó–í–û–î–°–¢–í–û -->
            <section id="production-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-cogs text-orange-600 mr-3"></i>
                                –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
                            </h2>
                            <button onclick="showModal('production-task-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                                <i class="fas fa-play-circle mr-2"></i>
                                –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                            </button>
                        </div>

                        <!-- –§–∏–ª—å—Ç—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π -->
                        <div class="bg-white shadow rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü–æ–∏—Å–∫</label>
                                    <input type="text" id="production-search" placeholder="–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ –∏–ª–∏ —Ä–µ—Ü–µ–ø—Ç" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                                    <select id="production-status-filter" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                        <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                                        <option value="active">–ê–∫—Ç–∏–≤–Ω–æ–µ</option>
                                        <option value="in-production">–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ</option>
                                        <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                                        <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–†–µ—Ü–µ–ø—Ç</label>
                                    <select id="production-recipe-filter" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="">–í—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã</option>
                                        <!-- –†–µ—Ü–µ–ø—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞</label>
                                    <input type="date" id="production-date-filter" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="clearProductionFilters()" 
                                            class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                        –°–±—Ä–æ—Å–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ü–∞—Ä—Ç–∏—è / –†–µ—Ü–µ–ø—Ç
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –û–±—ä–µ–º (–∫–≥)
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—Ç–∞—Ç—É—Å
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="production-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ú–û–î–£–õ–¨ –£–ü–ê–ö–û–í–ö–ê -->
            <section id="packaging-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-boxes text-purple-600 mr-3"></i>
                                –£–ø–∞–∫–æ–≤–∫–∞ –∏ —Ä–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                            </h2>
                            <button onclick="showModal('packaging-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">
                                <i class="fas fa-plus mr-2"></i>
                                –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                            </button>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ —É–ø–∞–∫–æ–≤–æ—á–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ú–∞—Ç–µ—Ä–∏–∞–ª
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –¢–∏–ø
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –û—Å—Ç–∞—Ç–æ–∫
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="packaging-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- –°–ï–ö–¶–ò–Ø –ö–õ–ò–ï–ù–¢–û–í -->
            <section id="customers-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏ -->
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-users text-blue-600 mr-3"></i>
                                –ö–ª–∏–µ–Ω—Ç—ã <span id="customers-count" class="text-sm font-normal text-gray-500">(0)</span>
                            </h2>
                            <div class="flex space-x-3">
                                <button onclick="showModal('customer-types-modal')" 
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-tags mr-2"></i>
                                    –¢–∏–ø—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
                                </button>
                                <button onclick="exportCustomersToExcel()" 
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-download mr-2"></i>
                                    Excel
                                </button>
                                <button onclick="printCustomers()" 
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-print mr-2"></i>
                                    –ü–µ—á–∞—Ç—å
                                </button>
                                <button onclick="showModal('customer-modal')" 
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                    <i class="fas fa-plus mr-2"></i>
                                    –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                                </button>
                            </div>
                        </div>

                        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
                        <div class="bg-white shadow rounded-lg mb-6 p-4">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <!-- –ü–æ–∏—Å–∫ -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏</label>
                                    <input type="text" id="customer-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞..." 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           onkeyup="filterCustomers()">
                                </div>
                                
                                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞</label>
                                    <select id="customer-type-filter" onchange="filterCustomers()" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                    </select>
                                </div>
                                
                                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                                    <select id="customer-status-filter" onchange="filterCustomers()" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                                        <option value="inactive">–ù–µ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                                    </select>
                                </div>
                                
                                <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
                                <div class="flex items-end">
                                    <button onclick="resetCustomerFilters()" 
                                            class="w-full px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        <i class="fas fa-eraser mr-2"></i>
                                        –°–±—Ä–æ—Å
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                            onclick="sortCustomers('name')">
                                            <div class="flex items-center">
                                                –ö–ª–∏–µ–Ω—Ç
                                                <i class="fas fa-sort ml-1 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –¢–∏–ø
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ö–æ–Ω—Ç–∞–∫—Ç—ã
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ó–∞–∫–∞–∑—ã
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                            onclick="sortCustomers('status')">
                                            <div class="flex items-center">
                                                –°—Ç–∞—Ç—É—Å
                                                <i class="fas fa-sort ml-1 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="customers-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>

                        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                        <div id="customers-pagination" class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-4 rounded-lg">
                            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –°–ï–ö–¶–ò–Ø –¢–û–í–ê–†–û–í -->
            <section id="products-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ -->
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-box text-green-600 mr-3"></i>
                                –¢–æ–≤–∞—Ä—ã <span id="products-count" class="text-sm font-normal text-gray-500">(0)</span>
                            </h2>
                            <div class="flex space-x-3">
                                <button onclick="showModal('product-units-modal')" 
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-ruler mr-2"></i>
                                    –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
                                </button>
                                <button onclick="showModal('product-categories-modal')" 
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-tags mr-2"></i>
                                    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
                                </button>
                                <button onclick="importProductsFromExcel()" 
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-upload mr-2"></i>
                                    –ò–º–ø–æ—Ä—Ç
                                </button>
                                <button onclick="exportProductsToExcel()" 
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-download mr-2"></i>
                                    Excel
                                </button>
                                <button onclick="printProducts()" 
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-print mr-2"></i>
                                    –ü–µ—á–∞—Ç—å
                                </button>
                                <button onclick="showProductModal()" 
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                    <i class="fas fa-plus mr-2"></i>
                                    –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                                </button>
                            </div>
                        </div>

                        <!-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                        <div id="products-alerts" class="mb-6">
                            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–∞—Ö –∏ —Å—Ä–æ–∫–∞—Ö –≥–æ–¥–Ω–æ—Å—Ç–∏ -->
                        </div>

                        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
                        <div class="bg-white shadow rounded-lg mb-6 p-4">
                            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                                <!-- –ü–æ–∏—Å–∫ -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü–æ–∏—Å–∫</label>
                                    <input type="text" id="product-search" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏–∫—É–ª, –ø–∞—Ä—Ç–∏—è..." 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                           onkeyup="filterProducts()">
                                </div>
                                
                                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                    <select id="product-category-filter" onchange="filterProducts()" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                    </select>
                                </div>
                                
                                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                                    <select id="product-status-filter" onchange="filterProducts()" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                                        <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                                    </select>
                                </div>
                                
                                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–û—Å—Ç–∞—Ç–∫–∏</label>
                                    <select id="product-stock-filter" onchange="filterProducts()" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                                        <option value="in-stock">–í –Ω–∞–ª–∏—á–∏–∏</option>
                                        <option value="low-stock">–ù–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞</option>
                                        <option value="zero-stock">–ù—É–ª–µ–≤–æ–π –æ—Å—Ç–∞—Ç–æ–∫</option>
                                        <option value="expired">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
                                        <option value="expiring">–ò—Å—Ç–µ–∫–∞—é—â–∏–µ</option>
                                    </select>
                                </div>
                                
                                <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
                                <div class="flex items-end">
                                    <button onclick="resetProductFilters()" 
                                            class="w-full px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        <i class="fas fa-eraser mr-2"></i>
                                        –°–±—Ä–æ—Å
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                            onclick="sortProducts('name')">
                                            <div class="flex items-center">
                                                –¢–æ–≤–∞—Ä
                                                <i class="fas fa-sort ml-1 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ê—Ä—Ç–∏–∫—É–ª
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                            onclick="sortProducts('costPrice')">
                                            <div class="flex items-center">
                                                –¶–µ–Ω—ã
                                                <i class="fas fa-sort ml-1 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                            onclick="sortProducts('totalStock')">
                                            <div class="flex items-center">
                                                –û—Å—Ç–∞—Ç–∫–∏
                                                <i class="fas fa-sort ml-1 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—Ä–æ–∫–∏
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                            onclick="sortProducts('status')">
                                            <div class="flex items-center">
                                                –°—Ç–∞—Ç—É—Å
                                                <i class="fas fa-sort ml-1 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="products-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>

                        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                        <div id="products-pagination" class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-4 rounded-lg">
                            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- –°–ï–ö–¶–ò–Ø –ó–ê–ö–ê–ó–û–í -->
            <section id="orders-section" class="section hidden">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-shopping-cart text-orange-600 mr-3"></i>
                                –ó–∞–∫–∞–∑—ã
                            </h2>
                            <button onclick="showModal('order-modal')" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                                <i class="fas fa-plus mr-2"></i>
                                –î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤ -->
                        <div class="bg-white shadow rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ‚Ññ –ó–∞–∫–∞–∑–∞
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ö–ª–∏–µ–Ω—Ç
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–∞—Ç–∞
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—É–º–º–∞
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—Ç–∞—Ç—É—Å
                                        </th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table" class="bg-white divide-y divide-gray-200">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ -->
    <div id="ingredient-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-seedling text-green-600 mr-2"></i>
                    <span id="ingredient-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</span>
                </h3>
                <button onclick="hideModal('ingredient-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="ingredient-form" onsubmit="saveIngredient(event)">
                <input type="hidden" id="ingredient-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ *</label>
                        <input type="text" id="ingredient-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                        <select id="ingredient-category" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <option value="–º—è—Å–æ">–ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞</option>
                            <option value="—Ä—ã–±–∞">–†—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</option>
                            <option value="–∫—Ä—É–ø—ã">–ö—Ä—É–ø—ã –∏ –∑–ª–∞–∫–∏</option>
                            <option value="–æ–≤–æ—â–∏">–û–≤–æ—â–∏</option>
                            <option value="–≤–∏—Ç–∞–º–∏–Ω—ã">–í–∏—Ç–∞–º–∏–Ω—ã –∏ –º–∏–Ω–µ—Ä–∞–ª—ã</option>
                            <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ (–∫–≥) *</label>
                        <input type="number" id="ingredient-stock" step="0.01" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ) *</label>
                        <input type="number" id="ingredient-price" step="0.01" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–∫–≥)</label>
                        <input type="number" id="ingredient-min-stock" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                        <input type="text" id="ingredient-supplier"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                </div>

                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="ingredient-description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                </div>

                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideModal('ingredient-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ—Ü–µ–ø—Ç–∞ -->
    <div id="recipe-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
                    <span id="recipe-modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç</span>
                </h3>
                <button onclick="hideModal('recipe-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="recipe-form" onsubmit="saveRecipe(event)">
                <input type="hidden" id="recipe-id">
                
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Ü–µ–ø—Ç–µ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ *</label>
                        <input type="text" id="recipe-name" required placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—à–∞ '–ì–æ–≤—è–¥–∏–Ω–∞'"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–∞—à–∏ *</label>
                        <div class="flex">
                            <select id="recipe-category" required 
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="–≥–æ–≤—è–¥–∏–Ω–∞">–ì–æ–≤—è–¥–∏–Ω–∞</option>
                                <option value="–∫—É—Ä–∏—Ü–∞">–ö—É—Ä–∏—Ü–∞</option>
                                <option value="–ª–æ—Å–æ—Å—å">–õ–æ—Å–æ—Å—å</option>
                                <option value="–ª–∞–π—Ç">–õ–∞–π—Ç (–¥–∏–µ—Ç–∏—á–µ—Å–∫–∞—è)</option>
                            </select>
                            <button type="button" onclick="addNewCategory()" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é"
                                    class="px-3 py-2 bg-green-600 text-white hover:bg-green-700">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button type="button" onclick="manageCategoriesModal()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏"
                                    class="px-3 py-2 bg-orange-600 text-white rounded-r-lg hover:bg-orange-700">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <i class="fas fa-plus text-green-600"></i> –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, <i class="fas fa-cog text-orange-600"></i> –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</p>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞</label>
                    <textarea id="recipe-description" rows="2" 
                              placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π —Ä–µ—Ü–µ–ø—Ç–∞"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>

                <!-- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞ -->
                <div class="border border-gray-300 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-md font-medium text-gray-900">
                            <i class="fas fa-flask text-blue-600 mr-2"></i>
                            –°–æ—Å—Ç–∞–≤ —Ä–µ—Ü–µ–ø—Ç–∞ (–Ω–∞ 1 –∫–≥)
                        </h4>
                        <button type="button" onclick="addIngredientToRecipe()" 
                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-plus mr-1"></i>
                            –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                        </button>
                    </div>

                    <div id="recipe-ingredients" class="space-y-3">
                        <!-- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Ä–µ—Ü–µ–ø—Ç–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>

                    <!-- –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="mt-4 pt-4 border-t border-gray-200 bg-gray-50 p-3 rounded-md">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-600">–û–±—â–∏–π –≤–µ—Å:</span>
                                <span id="recipe-total-weight" class="ml-2 font-bold text-gray-900">0 –≥</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                                <span id="recipe-total-cost" class="ml-2 font-bold text-green-600">0 ‚ÇΩ</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">–¶–µ–Ω–∞ –∑–∞ 1 –∫–≥:</span>
                                <span id="recipe-cost-per-kg" class="ml-2 font-bold text-blue-600">0 ‚ÇΩ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideModal('recipe-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ -->
    <div id="categories-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-tags text-orange-600 mr-2"></i>
                    <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∫–∞—à</span>
                </h3>
                <button onclick="hideModal('categories-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
                <div id="categories-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                <div class="flex">
                    <input type="text" id="new-category-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–Ω–¥–µ–π–∫–∞)"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="addCategoryFromModal()" 
                            class="px-3 py-2 bg-green-600 text-white rounded-r-lg hover:bg-green-700">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button onclick="hideModal('categories-modal')" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
    <div id="production-task-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-play-circle text-orange-600 mr-2"></i>
                    <span id="production-task-modal-title">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</span>
                </h3>
                <button onclick="hideModal('production-task-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="production-task-form" onsubmit="saveProductionTask(event)">
                <input type="hidden" id="production-task-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç *</label>
                        <select id="production-recipe-select" required onchange="updateProductionCalculations()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç –∏–∑ –±–∞–∑—ã</option>
                            <!-- –†–µ—Ü–µ–ø—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–û–±—ä–µ–º –ø–∞—Ä—Ç–∏–∏ (–∫–≥) *</label>
                        <input type="number" id="production-batch-size" step="0.1" min="0.1" required onchange="updateProductionCalculations()"
                               placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 50"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ *</label>
                        <input type="date" id="production-date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏</label>
                        <div class="flex">
                            <input type="text" id="production-batch-number" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <button type="button" onclick="generateBatchNumber()" 
                                    class="px-3 py-2 bg-orange-600 text-white rounded-r-lg hover:bg-orange-700">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>
                    </div>
                </div>

                <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –∑–∞–¥–∞–Ω–∏—é</label>
                    <textarea id="production-notes" rows="3" 
                              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideModal('production-task-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md">
                        <i class="fas fa-play mr-2"></i>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø–∞–∫–æ–≤–æ—á–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
    <div id="packaging-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-boxes text-purple-600 mr-2"></i>
                    <span id="packaging-modal-title">–î–æ–±–∞–≤–∏—Ç—å —É–ø–∞–∫–æ–≤–æ—á–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª</span>
                </h3>
                <button onclick="hideModal('packaging-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="packaging-form" onsubmit="savePackaging(event)">
                <input type="hidden" id="packaging-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                        <input type="text" id="packaging-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                        <select id="packaging-type" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="–ø–∞–∫–µ—Ç—ã">–ü–∞–∫–µ—Ç—ã</option>
                            <option value="–∫–æ—Ä–æ–±–∫–∏">–ö–æ—Ä–æ–±–∫–∏</option>
                            <option value="—ç—Ç–∏–∫–µ—Ç–∫–∏">–≠—Ç–∏–∫–µ—Ç–∫–∏</option>
                            <option value="–ø–ª–µ–Ω–∫–∞">–ü–ª–µ–Ω–∫–∞</option>
                            <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–û—Å—Ç–∞—Ç–æ–∫ (—à—Ç) *</label>
                        <input type="number" id="packaging-stock" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (‚ÇΩ) *</label>
                        <input type="number" id="packaging-price" step="0.01" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                    <button type="button" onclick="hideModal('packaging-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –î–õ–Ø –ö–õ–ò–ï–ù–¢–û–í, –¢–û–í–ê–†–û–í –ò –ó–ê–ö–ê–ó–û–í -->

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–ª–∏–µ–Ω—Ç–∞ -->
    <div id="customer-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-users text-blue-600 mr-2"></i>
                    <span id="customer-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</span>
                </h3>
                <button onclick="hideModal('customer-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="saveCustomer(event)">
                <input type="hidden" id="customer-id" name="id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="customer-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <select id="customer-type" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="physical">–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</option>
                            <option value="legal">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</option>
                            <option value="store">–ú–∞–≥–∞–∑–∏–Ω</option>
                            <option value="wholesale">–û–ø—Ç–æ–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="customer-phone" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="customer-email" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                        <select id="customer-status" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                            <option value="inactive">–ù–µ –∞–∫—Ç–∏–≤–Ω—ã–π</option>
                        </select>
                    </div>
                    <div></div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å</label>
                    <textarea id="customer-address" rows="2" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea id="customer-notes" rows="3" maxlength="1000" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <p class="text-xs text-gray-500 mt-1">–ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤</p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal('customer-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div id="customer-types-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-tags text-blue-600 mr-2"></i>
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
                </h3>
                <button onclick="hideModal('customer-types-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-sm font-medium text-gray-900 mb-3">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø</h4>
                <div class="flex space-x-2">
                    <input type="text" id="new-customer-type" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞..." maxlength="50"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="addCustomerType()" 
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∏–ø–æ–≤ -->
            <div>
                <h4 class="text-sm font-medium text-gray-900 mb-3">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã</h4>
                <div id="customer-types-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="hideModal('customer-types-modal')" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –¢–û–í–ê–†–ê -->
    <div id="product-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-box text-green-600 mr-2"></i>
                    <span id="product-modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</span>
                </h3>
                <button onclick="hideModal('product-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form onsubmit="saveProduct(event)" class="space-y-6">
                <input type="hidden" id="product-id" name="id">
                
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                            <input type="text" id="product-name" required maxlength="120" minlength="2"
                                   oninput="generateProductSKU()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">–û—Ç 2 –¥–æ 120 —Å–∏–º–≤–æ–ª–æ–≤</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ê—Ä—Ç–∏–∫—É–ª/SKU</label>
                            <input type="text" id="product-sku" readonly 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700">
                            <p class="text-xs text-gray-500 mt-1">–ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–®—Ç—Ä–∏—Ö-–∫–æ–¥</label>
                            <input type="text" id="product-barcode" maxlength="50"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è *</label>
                            <div class="flex">
                                <select id="product-unit" required 
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É</option>
                                </select>
                                <button type="button" onclick="showProductUnitModal()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è"
                                        class="px-3 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                            <div class="flex">
                                <select id="product-category" required 
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                </select>
                                <button type="button" onclick="showProductCategoryModal()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏"
                                        class="px-3 py-2 bg-orange-600 text-white rounded-r-md hover:bg-orange-700">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">–¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ) *</label>
                            <input type="number" id="product-cost-price" step="0.01" min="0.01" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                   onchange="calculateMargin()">
                            <p class="text-xs text-gray-500 mt-1">–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏/–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚ÇΩ) *</label>
                            <input type="number" id="product-sale-price" step="0.01" min="0.01" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                   onchange="calculateMargin()">
                            <p class="text-xs text-gray-500 mt-1">–¶–µ–Ω–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ú–∞—Ä–∂–∞ (%)</label>
                            <input type="number" id="product-margin" step="0.01" readonly 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700">
                            <p class="text-xs text-gray-500 mt-1">–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
                        </div>
                    </div>
                </div>

                <!-- –°—Ä–æ–∫–∏ –∏ –ø–∞—Ä—Ç–∏–∏ -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">–°—Ä–æ–∫–∏ –∏ –ø–∞—Ä—Ç–∏–∏</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ (–¥–Ω–µ–π)</label>
                            <input type="number" id="product-shelf-life" min="1" max="3650" value="365"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–í—Ä–µ–º—è –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–¥–Ω–µ–π)</label>
                            <input type="number" id="product-lead-time" min="0" max="365" value="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input type="number" id="product-min-stock" min="0" value="10"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                </div>

                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                            <select id="product-status" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                                <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
                            </select>
                        </div>
                        <div></div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                        <textarea id="product-notes" rows="3" maxlength="1000"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">–ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤</p>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ -->
                <div id="product-photo-preview" class="hidden">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h4>
                    <div class="flex justify-center">
                        <img id="product-photo-img" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="max-w-xs max-h-48 rounded-lg border border-gray-300">
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                    <button type="button" onclick="hideModal('product-modal')" 
                            class="px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ï–î–ò–ù–ò–¶–ê–ú–ò –ò–ó–ú–ï–†–ï–ù–ò–Ø -->
    <div id="product-units-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-ruler text-green-600 mr-2"></i>
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è
                </h3>
                <button onclick="hideModal('product-units-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –µ–¥–∏–Ω–∏—Ü—ã -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-sm font-medium text-gray-900 mb-3">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <input type="text" id="new-unit-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." maxlength="50"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <input type="text" id="new-unit-code" placeholder="–ö–æ–¥ (–ö–ì, –®–¢)..." maxlength="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <button onclick="addProductUnit()" 
                                class="w-full px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">
                            <i class="fas fa-plus mr-2"></i>
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –µ–¥–∏–Ω–∏—Ü -->
            <div>
                <h4 class="text-sm font-medium text-gray-900 mb-3">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</h4>
                <div id="product-units-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="hideModal('product-units-modal')" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò –¢–û–í–ê–†–û–í -->
    <div id="product-categories-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-tags text-green-600 mr-2"></i>
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤
                </h3>
                <button onclick="hideModal('product-categories-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-sm font-medium text-gray-900 mb-3">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div class="md:col-span-2">
                        <input type="text" id="new-category-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..." maxlength="50"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <select id="new-category-color" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="#10B981">üü¢ –ó–µ–ª–µ–Ω—ã–π</option>
                            <option value="#F59E0B">üü° –û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
                            <option value="#8B5CF6">üü£ –§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
                            <option value="#3B82F6">üîµ –°–∏–Ω–∏–π</option>
                            <option value="#EF4444">üî¥ –ö—Ä–∞—Å–Ω—ã–π</option>
                            <option value="#6B7280">‚ö´ –°–µ—Ä—ã–π</option>
                            <option value="#F97316">üü† –û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
                            <option value="#84CC16">üü¢ –õ–∞–π–º</option>
                        </select>
                    </div>
                    <div>
                        <button onclick="addProductCategory()" 
                                class="w-full px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">
                            <i class="fas fa-plus mr-2"></i>
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
            <div>
                <h4 class="text-sm font-medium text-gray-900 mb-3">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
                <div id="product-categories-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-60 overflow-y-auto">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="hideModal('product-categories-modal')" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫–∞–∑–∞ -->
    <div id="order-modal" class="modal fixed inset-0 z-50 items-center justify-center">
        <div class="modal-container bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-shopping-cart text-orange-600 mr-2"></i>
                    <span id="order-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</span>
                </h3>
                <button onclick="hideModal('order-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="saveOrder(event)">
                <input type="hidden" id="order-id" name="id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</label>
                        <input type="text" id="order-number" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–ö–ª–∏–µ–Ω—Ç</label>
                        <select id="order-customer" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</label>
                        <input type="date" id="order-date" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                        <select id="order-status" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="new">–ù–æ–≤—ã–π</option>
                            <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
                            <option value="production">–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ</option>
                            <option value="ready">–ì–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</option>
                            <option value="shipped">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
                            <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–û–±—â–∞—è —Å—É–º–º–∞ (‚ÇΩ)</label>
                        <input type="number" id="order-total" step="0.01" min="0" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea id="order-notes" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal('order-modal')" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—Å—Ç—Ä–æ–µ–Ω –≤ HTML -->
    <script>
// JavaScript —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è CRM "–ü–æ–≤–∞—Ä –ë–∏–º" - –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
let ingredients = [];
let recipes = [];
let productionTasks = [];
let packagingMaterials = [];
let customers = [];
let products = [];
let orders = [];
let customerTypes = [];

// –ù–æ–≤—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –º–æ–¥—É–ª—è
let productUnits = [];
let productCategories = [];
let productBatches = [];
let inventoryMovements = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadSampleData();
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    showSection('dashboard');
    updateDashboardStats();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    updateCategorySelect();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥—É–ª—å —Ç–æ–≤–∞—Ä–æ–≤
    initProductsModule();
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
function updateCurrentTime() {
    const now = new Date();
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = now.toLocaleString('ru-RU');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞–º–∏
function showSection(sectionName) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
        targetSection.classList.remove('hidden');
        targetSection.classList.add('fade-in');
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–µ–Ω—é
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    const activeMenuItem = document.querySelector(`[onclick*="${sectionName}"]`);
    if (activeMenuItem) {
        activeMenuItem.classList.add('active');
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–∫—Ü–∏–∏
    switch (sectionName) {
        case 'customers':
            loadCustomers();
            break;
        case 'products':
            loadProducts();
            break;
        case 'orders':
            loadOrders();
            break;
        case 'ingredients':
            loadIngredients();
            break;
        case 'recipes':
            loadRecipes();
            break;
        case 'production':
            loadProductionTasks();
            break;
        case 'packaging':
            loadPackagingMaterials();
            break;
        case 'dashboard':
            updateDashboardStats();
            break;
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
function showModal(modalId, skipReset = false) {
    console.log('üîß showModal called:', modalId, 'skipReset:', skipReset);
    
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        
        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
        if (!skipReset) {
            const form = modal.querySelector('form');
            if (form) {
                console.log('üîß Resetting form for modal:', modalId);
                form.reset();
                // –û—á–∏—Å—Ç–∫–∞ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π ID
                const idField = form.querySelector('input[type="hidden"]');
                if (idField) idField.value = '';
            }
        }

        // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        if (modalId === 'customer-modal' && !skipReset) {
            // –°–±—Ä–æ—Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            const title = document.getElementById('customer-modal-title');
            if (title) title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Å–µ–ª–µ–∫—Ç
            loadCustomerTypesToSelect();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const statusSelect = document.getElementById('customer-status');
            if (statusSelect) statusSelect.value = 'active';
        }
        
        if (modalId === 'customer-types-modal') {
            loadCustomerTypesList();
        }
        
        if (modalId === 'recipe-modal' && !skipReset) {
            console.log('üîß Clearing recipe ingredients for recipe modal');
            clearRecipeIngredients();
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            addIngredientToRecipe();
            
            // –°–±—Ä–æ—Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
            const title = document.getElementById('recipe-modal-title');
            if (title) title.textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const saveBtn = modal.querySelector('button[type="submit"]');
            if (saveBtn) saveBtn.style.display = 'inline-flex';
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è
            const inputs = modal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => input.readOnly = false);
        }
        if (modalId === 'ingredient-modal' && !skipReset) {
            console.log('üîß Opening ingredient modal - this may affect recipe form!');
        }
        if (modalId === 'production-task-modal') {
            loadRecipesForProduction();
            setDefaultProductionDate();
        }
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
    }
}

// –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò
function saveDataToStorage() {
    try {
        localStorage.setItem('povoarBimIngredients', JSON.stringify(ingredients));
        localStorage.setItem('povoarBimRecipes', JSON.stringify(recipes));
        localStorage.setItem('povoarBimProductionTasks', JSON.stringify(productionTasks));
        localStorage.setItem('povoarBimPackagingMaterials', JSON.stringify(packagingMaterials));
        localStorage.setItem('povoarBimCustomers', JSON.stringify(customers));
        localStorage.setItem('povoarBimProducts', JSON.stringify(products));
        localStorage.setItem('povoarBimOrders', JSON.stringify(orders));
        localStorage.setItem('povoarBimCustomerTypes', JSON.stringify(customerTypes));
        localStorage.setItem('povoarBimProductUnits', JSON.stringify(productUnits));
        localStorage.setItem('povoarBimProductCategories', JSON.stringify(productCategories));
        localStorage.setItem('povoarBimProductBatches', JSON.stringify(productBatches));
        localStorage.setItem('povoarBimInventoryMovements', JSON.stringify(inventoryMovements));
    } catch (e) {
        console.error('Error saving to localStorage:', e);
    }
}

function loadDataFromStorage() {
    try {
        const storedIngredients = localStorage.getItem('povoarBimIngredients');
        const storedRecipes = localStorage.getItem('povoarBimRecipes');
        const storedTasks = localStorage.getItem('povoarBimProductionTasks');
        const storedPackaging = localStorage.getItem('povoarBimPackagingMaterials');
        const storedCustomers = localStorage.getItem('povoarBimCustomers');
        const storedProducts = localStorage.getItem('povoarBimProducts');
        const storedOrders = localStorage.getItem('povoarBimOrders');
        const storedCustomerTypes = localStorage.getItem('povoarBimCustomerTypes');
        const storedProductUnits = localStorage.getItem('povoarBimProductUnits');
        const storedProductCategories = localStorage.getItem('povoarBimProductCategories');
        const storedProductBatches = localStorage.getItem('povoarBimProductBatches');
        const storedInventoryMovements = localStorage.getItem('povoarBimInventoryMovements');

        if (storedIngredients) ingredients = JSON.parse(storedIngredients);
        if (storedRecipes) recipes = JSON.parse(storedRecipes);
        if (storedTasks) productionTasks = JSON.parse(storedTasks);
        if (storedPackaging) packagingMaterials = JSON.parse(storedPackaging);
        if (storedCustomers) customers = JSON.parse(storedCustomers);
        if (storedProducts) products = JSON.parse(storedProducts);
        if (storedOrders) orders = JSON.parse(storedOrders);
        if (storedCustomerTypes) customerTypes = JSON.parse(storedCustomerTypes);
        if (storedProductUnits) productUnits = JSON.parse(storedProductUnits);
        if (storedProductCategories) productCategories = JSON.parse(storedProductCategories);
        if (storedProductBatches) productBatches = JSON.parse(storedProductBatches);
        if (storedInventoryMovements) inventoryMovements = JSON.parse(storedInventoryMovements);
    } catch (e) {
        console.error('Error loading from localStorage:', e);
    }
}

function loadSampleData() {
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
    loadDataFromStorage();

    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã
    if (ingredients.length === 0) {
        ingredients = [
            {
                id: '1',
                name: '–ì–æ–≤—è–¥–∏–Ω–∞ (—Ñ–∞—Ä—à)',
                category: '–º—è—Å–æ',
                stock: 25.5,
                price: 450,
                minStock: 5,
                supplier: '–ú—è—Å–æ–∫–æ–º–±–∏–Ω–∞—Ç "–ü—Ä–µ–º–∏—É–º"',
                description: '–°–≤–µ–∂–∏–π –≥–æ–≤—è–∂–∏–π —Ñ–∞—Ä—à –≤—ã—Å—à–µ–≥–æ —Å–æ—Ä—Ç–∞',
                createdAt: new Date().toISOString()
            },
            {
                id: '2',
                name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ (—Ä—É–±–ª–µ–Ω–∞—è)',
                category: '–º—è—Å–æ',
                stock: 18.2,
                price: 320,
                minStock: 3,
                supplier: '–ü—Ç–∏—Ü–µ—Ñ–∞–±—Ä–∏–∫–∞ "–ó–¥–æ—Ä–æ–≤—å–µ"',
                description: '–î–∏–µ—Ç–∏—á–µ—Å–∫–æ–µ –∫—É—Ä–∏–Ω–æ–µ –º—è—Å–æ –±–µ–∑ –∫–æ–∂–∏',
                createdAt: new Date().toISOString()
            },
            {
                id: '3',
                name: '–§–∏–ª–µ –ª–æ—Å–æ—Å—è',
                category: '—Ä—ã–±–∞',
                stock: 12.8,
                price: 850,
                minStock: 2,
                supplier: '–†—ã–±–Ω—ã–π –¥–æ–º "–û–∫–µ–∞–Ω"',
                description: '–°–≤–µ–∂–µ–µ —Ñ–∏–ª–µ –∞—Ç–ª–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ—Å–æ—Å—è',
                createdAt: new Date().toISOString()
            },
            {
                id: '4',
                name: '–†–∏—Å –±—É—Ä—ã–π',
                category: '–∫—Ä—É–ø—ã',
                stock: 45.0,
                price: 80,
                minStock: 10,
                supplier: '–û–û–û "–ó–¥–æ—Ä–æ–≤—ã–µ –∑–ª–∞–∫–∏"',
                description: '–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π –±—É—Ä—ã–π —Ä–∏—Å, –±–æ–≥–∞—Ç—ã–π –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π',
                createdAt: new Date().toISOString()
            },
            {
                id: '5',
                name: '–ú–æ—Ä–∫–æ–≤—å —Å—É—à–µ–Ω–∞—è',
                category: '–æ–≤–æ—â–∏',
                stock: 8.5,
                price: 120,
                minStock: 2,
                supplier: '–≠–∫–æ-–ü—Ä–æ–¥—É–∫—Ç',
                description: '–ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Å—É—à–µ–Ω–∞—è –º–æ—Ä–∫–æ–≤—å –±–µ–∑ –¥–æ–±–∞–≤–æ–∫',
                createdAt: new Date().toISOString()
            },
            {
                id: '6',
                name: '–í–∏—Ç–∞–º–∏–Ω–Ω–æ-–º–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å',
                category: '–≤–∏—Ç–∞–º–∏–Ω—ã',
                stock: 3.2,
                price: 1200,
                minStock: 0.5,
                supplier: '–í–µ—Ç–§–∞—Ä–º',
                description: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤ –¥–ª—è —Å–æ–±–∞–∫',
                createdAt: new Date().toISOString()
            }
        ];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
    if (customers.length === 0) {
        customers = [
            {
                id: '1',
                name: '–ú–∞–≥–∞–∑–∏–Ω "–õ—É—á—à–∏–π –î—Ä—É–≥"',
                type: 'store',
                status: 'active',
                phone: '+7 (495) 123-45-67',
                email: 'zakaz@bestfriend.ru',
                address: '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ñ–∏–≤–æ—Ç–Ω—ã—Ö, –¥. 15',
                notes: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä, —Ä–∞–±–æ—Ç–∞–µ–º —Å 2023 –≥–æ–¥–∞. –ó–∞–∫–∞–∑—ã–≤–∞–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –≥–æ–≤—è–¥–∏–Ω—É –∏ –∫—É—Ä–∏—Ü—É.',
                createdAt: new Date().toISOString()
            },
            {
                id: '2',
                name: '–û–û–û "–ü–µ—Ç–ö–æ—Ä–º"',
                type: 'wholesale',
                status: 'active',
                phone: '+7 (812) 987-65-43',
                email: 'opt@petkorm.ru',
                address: '–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ø—Ä. –ö–æ—Ä–º–æ–≤–æ–π, –¥. 22',
                notes: '–û–ø—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç. –ë–æ–ª—å—à–∏–µ –∑–∞–∫–∞–∑—ã —Ä–∞–∑ –≤ –º–µ—Å—è—Ü. –¢—Ä–µ–±—É–µ—Ç —Å–∫–∏–¥–∫–∏.',
                createdAt: new Date().toISOString()
            },
            {
                id: '3',
                name: '–ò–≤–∞–Ω–æ–≤ –°–µ—Ä–≥–µ–π –ü–µ—Ç—Ä–æ–≤–∏—á',
                type: 'physical',
                status: 'inactive',
                phone: '+7 (903) 555-12-34',
                email: 'ivanov.sp@mail.ru',
                address: '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –°–æ–±–∞—á—å—è, –¥. 8, –∫–≤. 42',
                notes: '–ü–æ–∫—É–ø–∞–ª –¥–ª—è —â–µ–Ω–∫–∞ –ª–∞–±—Ä–∞–¥–æ—Ä–∞. –î–∞–≤–Ω–æ –Ω–µ –∑–∞–∫–∞–∑—ã–≤–∞–ª.',
                createdAt: new Date().toISOString()
            }
        ];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤  
    if (products.length === 0) {
        products = [
            {
                id: '1',
                name: '–ö–∞—à–∞ "–ì–æ–≤—è–¥–∏–Ω–∞" 300–≥',
                sku: 'PB-BEEF-300',
                price: 280,
                stock: 150,
                weight: 300,
                description: '–ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è –∫–∞—à–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —Å –≥–æ–≤—è–¥–∏–Ω–æ–π –¥–ª—è —Å–æ–±–∞–∫ –≤—Å–µ—Ö –ø–æ—Ä–æ–¥',
                createdAt: new Date().toISOString()
            },
            {
                id: '2', 
                name: '–ö–∞—à–∞ "–ö—É—Ä–∏—Ü–∞" 300–≥',
                sku: 'PB-CHICK-300',
                price: 250,
                stock: 200,
                weight: 300,
                description: '–î–∏–µ—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—à–∞ —Å –∫—É—Ä–∏–Ω—ã–º –º—è—Å–æ–º –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è',
                createdAt: new Date().toISOString()
            },
            {
                id: '3',
                name: '–ö–∞—à–∞ "–õ–æ—Å–æ—Å—å" 300–≥',
                sku: 'PB-SALMON-300',
                price: 380,
                stock: 80,
                weight: 300,
                description: '–ü—Ä–µ–º–∏—É–º –∫–∞—à–∞ —Å –ª–æ—Å–æ—Å–µ–º, –±–æ–≥–∞—Ç–∞—è –æ–º–µ–≥–∞-3 –∫–∏—Å–ª–æ—Ç–∞–º–∏',
                createdAt: new Date().toISOString()
            },
            {
                id: '4',
                name: '–ö–∞—à–∞ "–õ–∞–π—Ç" 250–≥',
                sku: 'PB-LIGHT-250',
                price: 220,
                stock: 120,
                weight: 250,
                description: '–û–±–ª–µ–≥—á–µ–Ω–Ω–∞—è –∫–∞—à–∞ –¥–ª—è —Å–æ–±–∞–∫ —Å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º –≤–µ—Å–æ–º',
                createdAt: new Date().toISOString()
            }
        ];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤
    if (orders.length === 0) {
        orders = [
            {
                id: '1',
                number: 'ORD-2024-001',
                customerId: '1',
                date: '2024-01-15',
                status: 'delivered',
                total: 8400,
                notes: '–î–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º –¥–æ –º–∞–≥–∞–∑–∏–Ω–∞',
                createdAt: new Date().toISOString()
            },
            {
                id: '2',
                number: 'ORD-2024-002', 
                customerId: '2',
                date: '2024-01-18',
                status: 'production',
                total: 15600,
                notes: '–û–ø—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ –Ω–∞ —Å–∫–ª–∞–¥ –≤ –°–ü–±',
                createdAt: new Date().toISOString()
            },
            {
                id: '3',
                number: 'ORD-2024-003',
                customerId: '3', 
                date: '2024-01-20',
                status: 'confirmed',
                total: 1120,
                notes: '–°–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏',
                createdAt: new Date().toISOString()
            }
        ];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤
    if (customerTypes.length === 0) {
        customerTypes = [
            { id: 'physical', name: '–§–∏–∑. –ª–∏—Ü–æ', removable: false },
            { id: 'legal', name: '–Æ—Ä. –ª–∏—Ü–æ', removable: false },
            { id: 'store', name: '–ú–∞–≥–∞–∑–∏–Ω', removable: false },
            { id: 'wholesale', name: '–û–ø—Ç–æ–≤—ã–π', removable: false }
        ];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è
    if (productUnits.length === 0) {
        productUnits = [
            { id: 'kg', name: '–ö–∏–ª–æ–≥—Ä–∞–º–º—ã', symbol: '–ö–ì', isDefault: false, removable: false },
            { id: 'pcs', name: '–®—Ç—É–∫–∏', symbol: '–®–¢', isDefault: true, removable: false },
            { id: 'l', name: '–õ–∏—Ç—Ä—ã', symbol: '–õ', isDefault: false, removable: false },
            { id: 'box', name: '–ö–æ—Ä–æ–±–∫–∞', symbol: '–ö–û–†', isDefault: false, removable: false },
            { id: 'pack', name: '–£–ø–∞–∫–æ–≤–∫–∞', symbol: '–£–ü', isDefault: false, removable: false },
            { id: 'bag', name: '–ú–µ—à–æ–∫', symbol: '–ú–ï–®', isDefault: false, removable: false }
        ];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤
    if (productCategories.length === 0) {
        productCategories = [
            { id: 'finished', name: '–ì–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', prefix: '–ì–¢–í', color: '#10B981', isDefault: true, removable: false },
            { id: 'raw', name: '–°—ã—Ä—å—ë', prefix: '–°–´–†', color: '#F59E0B', isDefault: false, removable: false },
            { id: 'additives', name: '–î–æ–±–∞–≤–∫–∏', prefix: '–î–û–ë', color: '#8B5CF6', isDefault: false, removable: false },
            { id: 'packaging', name: '–¢–∞—Ä–∞', prefix: '–¢–ê–†', color: '#3B82F6', isDefault: false, removable: false },
            { id: 'materials', name: '–£–ø–∞–∫–æ–≤–∫–∞', prefix: '–£–ü–ö', color: '#EF4444', isDefault: false, removable: false },
            { id: 'supplies', name: '–†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã', prefix: '–†–°–•', color: '#6B7280', isDefault: false, removable: false },
            { id: 'equipment', name: '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', prefix: '–û–ë–†', color: '#F97316', isDefault: false, removable: false },
            { id: 'inventory', name: '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å', prefix: '–ò–ù–í', color: '#84CC16', isDefault: false, removable: false }
        ];
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
    if (products.length > 0) {
        products = products.map(product => ({
            ...product,
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            sku: product.sku || `SKU-${Date.now()}`,
            barcode: product.barcode || '',
            unitId: product.unitId || 'pcs',
            categoryId: product.categoryId || 'finished',
            costPrice: product.costPrice || 0,
            salePrice: product.price || product.salePrice || 0, // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
            margin: product.margin || 0,
            shelfLifeDays: product.shelfLifeDays || 365,
            manufacturingLeadTime: product.manufacturingLeadTime || 1,
            minStock: product.minStock || 10,
            photo: product.photo || '',
            notes: product.notes || product.description || '', // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
            status: product.status || 'active',
            updatedAt: new Date().toISOString()
        }));
    }

    saveDataToStorage();
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –î–ê–®–ë–û–†–î–ê
function updateDashboardStats() {
    const totalCustomersEl = document.getElementById('total-customers');
    const totalRecipesEl = document.getElementById('total-recipes');
    const activeProductionEl = document.getElementById('active-production');
    const totalIngredientsEl = document.getElementById('total-ingredients');
    
    if (totalCustomersEl) totalCustomersEl.textContent = customers.length;
    if (totalRecipesEl) totalRecipesEl.textContent = recipes.length;
    if (activeProductionEl) {
        activeProductionEl.textContent = productionTasks.filter(task => 
            task.status === 'in-production' || task.status === 'active'
        ).length;
    }
    if (totalIngredientsEl) totalIngredientsEl.textContent = ingredients.length;
}

// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–ì–†–ï–î–ò–ï–ù–¢–ê–ú–ò
function saveIngredient(event) {
    event.preventDefault();

    const formData = {
        id: document.getElementById('ingredient-id').value || Date.now().toString(),
        name: document.getElementById('ingredient-name').value,
        category: document.getElementById('ingredient-category').value,
        stock: parseFloat(document.getElementById('ingredient-stock').value),
        price: parseFloat(document.getElementById('ingredient-price').value),
        minStock: parseFloat(document.getElementById('ingredient-min-stock').value) || 0,
        supplier: document.getElementById('ingredient-supplier').value,
        description: document.getElementById('ingredient-description').value,
        createdAt: new Date().toISOString()
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
    const existingIndex = ingredients.findIndex(ing => ing.id === formData.id);
    if (existingIndex >= 0) {
        ingredients[existingIndex] = formData;
    } else {
        ingredients.push(formData);
    }

    saveDataToStorage();
    hideModal('ingredient-modal');
    loadIngredients();
    updateDashboardStats();

    showNotification('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
}

function loadIngredients() {
    const tbody = document.getElementById('ingredients-table');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (ingredients.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-seedling text-4xl mb-3"></i>
                    <p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</p>
                    <button onclick="showModal('ingredient-modal')" 
                            class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>
                        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    ingredients.forEach(ingredient => {
        const status = getIngredientStatus(ingredient);
        const row = `
            <tr class="table-row">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${ingredient.name}</div>
                    <div class="text-sm text-gray-500">${ingredient.description || ''}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        ${ingredient.category}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${ingredient.stock} –∫–≥</div>
                    ${ingredient.minStock > 0 ? `<div class="text-xs text-gray-500">–ú–∏–Ω: ${ingredient.minStock} –∫–≥</div>` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${ingredient.price.toFixed(2)} ‚ÇΩ
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center ${status.class}">
                        <i class="fas ${status.icon} mr-1"></i>
                        ${status.text}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editIngredient('${ingredient.id}')" 
                            class="text-blue-600 hover:text-blue-900 mr-3">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteIngredient('${ingredient.id}')" 
                            class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function getIngredientStatus(ingredient) {
    if (ingredient.stock <= 0) {
        return {
            class: 'status-unavailable',
            icon: 'fa-times-circle',
            text: '–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ'
        };
    } else if (ingredient.minStock > 0 && ingredient.stock <= ingredient.minStock) {
        return {
            class: 'text-yellow-600',
            icon: 'fa-exclamation-triangle',
            text: '–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è'
        };
    } else {
        return {
            class: 'status-available',
            icon: 'fa-check-circle',
            text: '–ï—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ'
        };
    }
}

function editIngredient(id) {
    const ingredient = ingredients.find(ing => ing.id === id);
    if (!ingredient) return;

    document.getElementById('ingredient-id').value = ingredient.id;
    document.getElementById('ingredient-name').value = ingredient.name;
    document.getElementById('ingredient-category').value = ingredient.category;
    document.getElementById('ingredient-stock').value = ingredient.stock;
    document.getElementById('ingredient-price').value = ingredient.price;
    document.getElementById('ingredient-min-stock').value = ingredient.minStock;
    document.getElementById('ingredient-supplier').value = ingredient.supplier || '';
    document.getElementById('ingredient-description').value = ingredient.description || '';

    document.getElementById('ingredient-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç';
    showModal('ingredient-modal');
}

function deleteIngredient(id) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç?')) {
        ingredients = ingredients.filter(ing => ing.id !== id);
        saveDataToStorage();
        loadIngredients();
        updateDashboardStats();
        showNotification('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω', 'success');
    }
}

// –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–¶–ï–ü–¢–ê–ú–ò  
function loadRecipes() {
    const grid = document.getElementById('recipes-grid');
    const empty = document.getElementById('recipes-empty');

    if (!grid || !empty) return;

    if (recipes.length === 0) {
        grid.style.display = 'none';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    grid.style.display = 'grid';
    grid.innerHTML = '';

    recipes.forEach(recipe => {
        const card = `
            <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">${recipe.name}</h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${recipe.category}
                        </span>
                    </div>

                    <p class="text-sm text-gray-600 mb-4">${recipe.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>

                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤:</span>
                            <span class="font-medium">${recipe.ingredients ? recipe.ingredients.length : 0}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">–û–±—â–∏–π –≤–µ—Å:</span>
                            <span class="font-medium">${recipe.totalWeight || 0} –≥</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                            <span class="font-medium text-green-600">${(recipe.totalCost || 0).toFixed(2)} ‚ÇΩ</span>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button onclick="viewRecipe('${recipe.id}')" 
                                class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                            <i class="fas fa-eye mr-1"></i>
                            –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        <div class="space-x-2">
                            <button onclick="editRecipe('${recipe.id}')" 
                                    class="text-orange-600 hover:text-orange-900 text-sm" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="exportRecipeToExcel('${recipe.id}')" 
                                    class="text-green-600 hover:text-green-900 text-sm" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel">
                                <i class="fas fa-file-excel"></i>
                            </button>
                            <button onclick="deleteRecipe('${recipe.id}')" 
                                    class="text-red-600 hover:text-red-900 text-sm" title="–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        grid.innerHTML += card;
    });
}

// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ò–ó–í–û–î–°–¢–í–û–ú
function loadProductionTasks() {
    const tbody = document.getElementById('production-table');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (productionTasks.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-cogs text-4xl mb-3"></i>
                    <p>–ù–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
                    <button onclick="showModal('production-task-modal')" 
                            class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                        <i class="fas fa-plus mr-2"></i>
                        –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    productionTasks.forEach(task => {
        const status = getProductionStatus(task);
        const row = `
            <tr class="table-row">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${task.batchNumber || task.id}</div>
                    <div class="text-sm text-gray-500">${task.recipeName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${task.batchSize || 0} –∫–≥
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${task.productionDate ? new Date(task.productionDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${(task.totalCost || 0).toFixed(2)} ‚ÇΩ</div>
                    <div class="text-xs text-gray-500">${(task.costPerKg || 0).toFixed(2)} ‚ÇΩ/–∫–≥</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${status.class}">
                        ${status.text}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                    <button onclick="viewProductionTask('${task.id}')" 
                            class="text-blue-600 hover:text-blue-900" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞–Ω–∏—è">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="editProductionTask('${task.id}')" 
                            class="text-green-600 hover:text-green-900" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="changeTaskStatus('${task.id}')" 
                            class="text-orange-600 hover:text-orange-900" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button onclick="deleteProductionTask('${task.id}')" 
                            class="text-red-600 hover:text-red-900" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button onclick="exportProductionTask('${task.id}')" 
                            class="text-purple-600 hover:text-purple-900" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function getProductionStatus(task) {
    switch (task.status) {
        case 'draft':
            return { class: 'status-draft', text: '–ß–µ—Ä–Ω–æ–≤–∏–∫' };
        case 'active':
            return { class: 'status-active', text: '–ê–∫—Ç–∏–≤–Ω–æ–µ' };
        case 'in-production':
            return { class: 'status-in-production', text: '–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ' };
        case 'completed':
            return { class: 'status-completed', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' };
        case 'cancelled':
            return { class: 'status-cancelled', text: '–û—Ç–º–µ–Ω–µ–Ω–æ' };
        default:
            return { class: 'status-draft', text: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
    }
}

function loadRecipesForProduction() {
    const select = document.getElementById('production-recipe-select');
    if (!select) return;

    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç –∏–∑ –±–∞–∑—ã</option>';
    
    recipes.forEach(recipe => {
        const option = `<option value="${recipe.id}">${recipe.name} (${recipe.category})</option>`;
        select.innerHTML += option;
    });
}

function setDefaultProductionDate() {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('production-date');
    if (dateInput) {
        dateInput.value = today;
    }
}

// –ö–û–ù–°–¢–†–£–ö–¢–û–† –†–ï–¶–ï–ü–¢–û–í
function clearRecipeIngredients() {
    const container = document.getElementById('recipe-ingredients');
    if (container) {
        container.innerHTML = '';
    }
    updateRecipeCalculations();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
    setTimeout(() => {
        addIngredientToRecipe();
    }, 100);
}

function addIngredientToRecipe() {
    console.log('üîß addIngredientToRecipe called, ingredients count:', ingredients.length);
    
    if (ingredients.length === 0) {
        // –í–º–µ—Å—Ç–æ alert –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
        if (confirm('–£ –≤–∞—Å –Ω–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ. –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç?')) {
            showModal('ingredient-modal');
            return;
        } else {
            return;
        }
    }

    const ingredientsContainer = document.getElementById('recipe-ingredients');
    
    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FIX: –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫
    const existingRows = ingredientsContainer.querySelectorAll('.ingredient-row');
    const savedData = [];
    
    console.log('üîß Existing rows count:', existingRows.length);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
    existingRows.forEach((row, index) => {
        const select = row.querySelector('.ingredient-select');
        const weightInput = row.querySelector('.ingredient-weight');
        const costSpan = row.querySelector('.ingredient-cost');
        
        const data = {
            ingredientId: select ? select.value : '',
            weight: weightInput ? weightInput.value : '',
            cost: costSpan ? costSpan.textContent : '0 ‚ÇΩ'
        };
        
        savedData.push(data);
        console.log(`üîß SAVED row ${index}:`, data);
    });

    const ingredientId = `recipe-ingredient-${Date.now()}`;

    const ingredientRow = `
        <div class="ingredient-row" data-id="${ingredientId}">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <select class="ingredient-select w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            onchange="updateRecipeCalculations()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</option>
                        ${ingredients.map(ing => `
                            <option value="${ing.id}" data-price="${ing.price}" data-stock="${ing.stock}">
                                ${ing.name} (${ing.stock} –∫–≥ –Ω–∞ —Å–∫–ª–∞–¥–µ, ${ing.price} ‚ÇΩ/–∫–≥)
                            </option>
                        `).join('')}
                    </select>
                </div>
                <div class="w-32">
                    <input type="number" step="0.1" min="0" placeholder="–í–µ—Å (–≥)" 
                           class="ingredient-weight w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onchange="updateRecipeCalculations()">
                </div>
                <div class="w-24 text-sm text-gray-600 text-center">
                    <span class="ingredient-cost">0 ‚ÇΩ</span>
                </div>
                <button type="button" onclick="removeIngredientFromRecipe('${ingredientId}')" 
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;

    if (ingredientsContainer) {
        ingredientsContainer.innerHTML += ingredientRow;
        
        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FIX: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const newRows = ingredientsContainer.querySelectorAll('.ingredient-row');
        console.log('üîß New rows count after adding:', newRows.length);
        
        savedData.forEach((data, index) => {
            if (newRows[index]) {
                const select = newRows[index].querySelector('.ingredient-select');
                const weightInput = newRows[index].querySelector('.ingredient-weight');
                const costSpan = newRows[index].querySelector('.ingredient-cost');
                
                if (select && data.ingredientId) {
                    select.value = data.ingredientId;
                    console.log(`üîß RESTORED select ${index}:`, data.ingredientId);
                }
                if (weightInput && data.weight) {
                    weightInput.value = data.weight;
                    console.log(`üîß RESTORED weight ${index}:`, data.weight);
                }
                if (costSpan && data.cost) {
                    costSpan.textContent = data.cost;
                    console.log(`üîß RESTORED cost ${index}:`, data.cost);
                }
            }
        });
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        setTimeout(() => updateRecipeCalculations(), 100);
        console.log('üîß ‚úÖ DATA RESTORATION COMPLETED');
    }
}

function removeIngredientFromRecipe(ingredientId) {
    const element = document.querySelector(`[data-id="${ingredientId}"]`);
    if (element) {
        element.remove();
        updateRecipeCalculations();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
function addRecipeIngredient(ingredientId, weight) {
    const ingredientsContainer = document.getElementById('recipe-ingredients');
    const rowId = `recipe-ingredient-${Date.now()}`;

    const ingredientRow = `
        <div class="ingredient-row" data-id="${rowId}">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <select class="ingredient-select w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            onchange="updateRecipeCalculations()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</option>
                        ${ingredients.map(ing => `
                            <option value="${ing.id}" data-price="${ing.price}" data-stock="${ing.stock}" 
                                    ${ing.id === ingredientId ? 'selected' : ''}>
                                ${ing.name} (${ing.stock} –∫–≥ –Ω–∞ —Å–∫–ª–∞–¥–µ, ${ing.price} ‚ÇΩ/–∫–≥)
                            </option>
                        `).join('')}
                    </select>
                </div>
                <div class="w-32">
                    <input type="number" step="0.1" min="0" placeholder="–í–µ—Å (–≥)" 
                           class="ingredient-weight w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                           value="${weight || ''}"
                           onchange="updateRecipeCalculations()">
                </div>
                <div class="w-24 text-sm text-gray-600 text-center">
                    <span class="ingredient-cost">0 ‚ÇΩ</span>
                </div>
                <button type="button" onclick="removeIngredientFromRecipe('${rowId}')" 
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;

    if (ingredientsContainer) {
        ingredientsContainer.innerHTML += ingredientRow;
    }
}

function updateRecipeCalculations() {
    const ingredientRows = document.querySelectorAll('.ingredient-row');
    let totalWeight = 0;
    let totalCost = 0;

    ingredientRows.forEach(row => {
        const select = row.querySelector('.ingredient-select');
        const weightInput = row.querySelector('.ingredient-weight');
        const costSpan = row.querySelector('.ingredient-cost');

        const selectedOption = select.selectedOptions[0];
        const weight = parseFloat(weightInput.value) || 0;

        if (selectedOption && selectedOption.value && weight > 0) {
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const cost = (weight / 1000) * price; // –≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö, —Ü–µ–Ω–∞ –∑–∞ –∫–≥

            costSpan.textContent = cost.toFixed(2) + ' ‚ÇΩ';
            totalWeight += weight;
            totalCost += cost;
        } else {
            costSpan.textContent = '0 ‚ÇΩ';
        }
    });

    const totalWeightEl = document.getElementById('recipe-total-weight');
    const totalCostEl = document.getElementById('recipe-total-cost');
    const costPerKgEl = document.getElementById('recipe-cost-per-kg');

    if (totalWeightEl) totalWeightEl.textContent = totalWeight + ' –≥';
    if (totalCostEl) totalCostEl.textContent = totalCost.toFixed(2) + ' ‚ÇΩ';
    if (costPerKgEl) costPerKgEl.textContent = totalCost.toFixed(2) + ' ‚ÇΩ';
}

function saveRecipe(event) {
    event.preventDefault();

    const recipeIngredients = getRecipeIngredients();
    if (recipeIngredients.length === 0) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –≤ —Ä–µ—Ü–µ–ø—Ç');
        return;
    }

    const formData = {
        id: document.getElementById('recipe-id').value || Date.now().toString(),
        name: document.getElementById('recipe-name').value,
        category: document.getElementById('recipe-category').value,
        description: document.getElementById('recipe-description').value,
        ingredients: recipeIngredients,
        totalWeight: calculateRecipeTotalWeight(recipeIngredients),
        totalCost: calculateRecipeTotalCost(recipeIngredients),
        createdAt: new Date().toISOString()
    };

    const existingIndex = recipes.findIndex(recipe => recipe.id === formData.id);
    if (existingIndex >= 0) {
        recipes[existingIndex] = formData;
    } else {
        recipes.push(formData);
    }

    saveDataToStorage();
    hideModal('recipe-modal');
    loadRecipes();
    updateDashboardStats();

    showNotification('–†–µ—Ü–µ–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
}

function getRecipeIngredients() {
    const ingredientRows = document.querySelectorAll('.ingredient-row');
    const recipeIngredients = [];

    ingredientRows.forEach(row => {
        const select = row.querySelector('.ingredient-select');
        const weightInput = row.querySelector('.ingredient-weight');

        const ingredientId = select.value;
        const weight = parseFloat(weightInput.value) || 0;

        if (ingredientId && weight > 0) {
            const ingredient = ingredients.find(ing => ing.id === ingredientId);
            if (ingredient) {
                recipeIngredients.push({
                    ingredientId: ingredientId,
                    name: ingredient.name,
                    weight: weight,
                    price: ingredient.price,
                    cost: (weight / 1000) * ingredient.price
                });
            }
        }
    });

    return recipeIngredients;
}

function calculateRecipeTotalWeight(ingredients) {
    return ingredients.reduce((total, ing) => total + ing.weight, 0);
}

function calculateRecipeTotalCost(ingredients) {
    return ingredients.reduce((total, ing) => total + ing.cost, 0);
}

// –£–ü–ê–ö–û–í–û–ß–ù–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´
function loadPackagingMaterials() {
    const tbody = document.getElementById('packaging-table');
    if (!tbody) return;

    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                <i class="fas fa-boxes text-4xl mb-3"></i>
                <p>–§—É–Ω–∫—Ü–∏—è —É–ø–∞–∫–æ–≤–æ—á–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
            </td>
        </tr>
    `;
}

function savePackaging(event) {
    event.preventDefault();
    showNotification('–§—É–Ω–∫—Ü–∏—è —É–ø–∞–∫–æ–≤–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    hideModal('packaging-modal');
}

// –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
    
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    notification.className += ` ${bgColor} text-white`;
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle mr-3"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // –°–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏
function viewRecipe(id) {
    console.log('üîß viewRecipe called with id:', id);
    
    const recipes = JSON.parse(localStorage.getItem('povoarBimRecipes')) || [];
    console.log('üîß Found recipes:', recipes.length);
    
    const recipe = recipes.find(r => r.id == id);
    console.log('üîß Found recipe:', recipe);
    
    if (!recipe) {
        console.error('üîß Recipe not found with id:', id);
        showNotification('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
    document.getElementById('recipe-name').value = recipe.name;
    document.getElementById('recipe-category').value = recipe.category;
    document.getElementById('recipe-description').value = recipe.description || '';
    
    // –û—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Ä–µ—Ü–µ–ø—Ç–∞
    clearRecipeIngredients();
    
    console.log('üîß Recipe ingredients:', recipe.ingredients);
    
    if (recipe.ingredients && recipe.ingredients.length > 0) {
        recipe.ingredients.forEach((ingredient, index) => {
            console.log(`üîß Adding ingredient ${index}:`, ingredient);
            const ingredientId = ingredient.ingredientId || ingredient.id;
            addRecipeIngredient(ingredientId, ingredient.weight);
        });
    }
    
    // –î–µ–ª–∞–µ–º –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
    const modal = document.getElementById('recipe-modal');
    const inputs = modal.querySelectorAll('input, select, textarea');
    inputs.forEach(input => input.readOnly = true);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = modal.querySelector('button[type="submit"]');
    if (saveBtn) saveBtn.style.display = 'none';
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('recipe-modal-title');
    if (title) title.textContent = `–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ—Ü–µ–ø—Ç–∞: ${recipe.name}`;
    
    console.log('üîß Opening recipe modal for viewing');
    showModal('recipe-modal', true);
}

function editRecipe(id) {
    console.log('üîß editRecipe called with id:', id);
    
    const recipes = JSON.parse(localStorage.getItem('povoarBimRecipes')) || [];
    console.log('üîß Found recipes:', recipes.length);
    
    const recipe = recipes.find(r => r.id == id);
    console.log('üîß Found recipe for editing:', recipe);
    
    if (!recipe) {
        console.error('üîß Recipe not found for editing with id:', id);
        showNotification('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ —Ä–µ—Ü–µ–ø—Ç–∞
    document.getElementById('recipe-id').value = recipe.id;
    document.getElementById('recipe-name').value = recipe.name;
    document.getElementById('recipe-category').value = recipe.category;
    document.getElementById('recipe-description').value = recipe.description || '';
    
    // –û—á–∏—Å—Ç–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
    clearRecipeIngredients();
    
    console.log('üîß Recipe ingredients for editing:', recipe.ingredients);
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Ä–µ—Ü–µ–ø—Ç–∞
    if (recipe.ingredients && recipe.ingredients.length > 0) {
        recipe.ingredients.forEach((ingredient, index) => {
            console.log(`üîß Adding ingredient ${index} for editing:`, ingredient);
            const ingredientId = ingredient.ingredientId || ingredient.id;
            addRecipeIngredient(ingredientId, ingredient.weight);
        });
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const modal = document.getElementById('recipe-modal');
    const inputs = modal.querySelectorAll('input, select, textarea');
    inputs.forEach(input => input.readOnly = false);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = modal.querySelector('button[type="submit"]');
    if (saveBtn) saveBtn.style.display = 'inline-flex';
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('recipe-modal-title');
    if (title) title.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç: ${recipe.name}`;
    
    console.log('üîß Opening recipe modal for editing');
    updateRecipeCalculations();
    showModal('recipe-modal', true);
}

function deleteRecipe(id) {
    console.log('üîß deleteRecipe called with id:', id);
    
    const recipes = JSON.parse(localStorage.getItem('povoarBimRecipes')) || [];
    const recipe = recipes.find(r => r.id == id);
    
    if (!recipe) {
        console.error('üîß Recipe not found for deletion with id:', id);
        showNotification('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç "${recipe.name}"?`)) {
        console.log('üîß Deleting recipe:', recipe.name);
        
        let updatedRecipes = recipes.filter(r => r.id != id);
        localStorage.setItem('povoarBimRecipes', JSON.stringify(updatedRecipes));
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ recipes
        window.recipes = updatedRecipes;
        
        loadRecipes();
        updateDashboardStats();
        showNotification(`–†–µ—Ü–µ–ø—Ç "${recipe.name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`, 'success');
        
        console.log('üîß Recipe deleted successfully');
    }
}

// –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò –†–ï–¶–ï–ü–¢–û–í
let customCategories = JSON.parse(localStorage.getItem('povoarBimCategories')) || [];

function getDefaultCategories() {
    return [
        { value: '–≥–æ–≤—è–¥–∏–Ω–∞', name: '–ì–æ–≤—è–¥–∏–Ω–∞', default: true },
        { value: '–∫—É—Ä–∏—Ü–∞', name: '–ö—É—Ä–∏—Ü–∞', default: true },
        { value: '–ª–æ—Å–æ—Å—å', name: '–õ–æ—Å–æ—Å—å', default: true },
        { value: '–ª–∞–π—Ç', name: '–õ–∞–π—Ç (–¥–∏–µ—Ç–∏—á–µ—Å–∫–∞—è)', default: true }
    ];
}

function getAllCategories() {
    const defaultCategories = getDefaultCategories();
    const allCategories = [...defaultCategories, ...customCategories];
    return allCategories;
}

function saveCategoriesState() {
    localStorage.setItem('povoarBimCategories', JSON.stringify(customCategories));
}

function updateCategorySelect() {
    const categorySelect = document.getElementById('recipe-category');
    if (!categorySelect) return;
    
    const selectedValue = categorySelect.value;
    const categories = getAllCategories();
    
    // –û—á–∏—â–∞–µ–º select –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π –æ–ø—Ü–∏–∏
    categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.value;
        option.textContent = cat.name;
        categorySelect.appendChild(option);
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if (selectedValue) {
        categorySelect.value = selectedValue;
    }
}

function addNewCategory() {
    const categoryName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞—à–∏:');
    
    if (categoryName && categoryName.trim()) {
        const cleanName = categoryName.trim().toLowerCase();
        const displayName = categoryName.trim();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—â–µ –Ω–µ—Ç
        const allCategories = getAllCategories();
        const exists = allCategories.some(cat => cat.value === cleanName);
        
        if (exists) {
            showNotification('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        customCategories.push({
            value: cleanName,
            name: displayName,
            default: false
        });
        
        saveCategoriesState();
        updateCategorySelect();
        
        // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        const categorySelect = document.getElementById('recipe-category');
        categorySelect.value = cleanName;
        
        showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${displayName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
    }
}

function manageCategoriesModal() {
    loadCategoriesList();
    showModal('categories-modal');
}

function loadCategoriesList() {
    const categoriesList = document.getElementById('categories-list');
    if (!categoriesList) return;
    
    const allCategories = getAllCategories();
    
    categoriesList.innerHTML = '';
    
    allCategories.forEach(category => {
        const categoryItem = document.createElement('div');
        categoryItem.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md';
        
        const canDelete = !category.default; // –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ
        
        categoryItem.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${category.default ? 'fa-tag' : 'fa-user-tag'} text-blue-600 mr-2"></i>
                <span class="text-sm font-medium">${category.name}</span>
                ${category.default ? '<span class="ml-2 text-xs text-gray-500">(–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</span>' : ''}
            </div>
            <div>
                ${canDelete ? `
                    <button onclick="deleteCategory('${category.value}')" 
                            class="text-red-600 hover:text-red-900 text-sm" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <span class="text-xs text-gray-400">—Å–∏—Å—Ç–µ–º–Ω–∞—è</span>
                `}
            </div>
        `;
        
        categoriesList.appendChild(categoryItem);
    });
}

function addCategoryFromModal() {
    const input = document.getElementById('new-category-name');
    const categoryName = input.value.trim();
    
    if (!categoryName) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'warning');
        return;
    }
    
    const cleanName = categoryName.toLowerCase();
    const allCategories = getAllCategories();
    const exists = allCategories.some(cat => cat.value === cleanName);
    
    if (exists) {
        showNotification('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    customCategories.push({
        value: cleanName,
        name: categoryName,
        default: false
    });
    
    saveCategoriesState();
    updateCategorySelect();
    loadCategoriesList();
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    input.value = '';
    
    showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${categoryName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
}

function deleteCategory(categoryValue) {
    const category = customCategories.find(cat => cat.value === categoryValue);
    if (!category) return;
    
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category.name}"?`)) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        customCategories = customCategories.filter(cat => cat.value !== categoryValue);
        
        saveCategoriesState();
        updateCategorySelect();
        loadCategoriesList();
        
        showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${category.name}" —É–¥–∞–ª–µ–Ω–∞`, 'success');
    }
}

// –§–£–ù–ö–¶–ò–Ø –≠–ö–°–ü–û–†–¢–ê –†–ï–¶–ï–ü–¢–ê –í EXCEL
function exportRecipeToExcel(id) {
    console.log('üîß exportRecipeToExcel called with id:', id);
    
    const recipes = JSON.parse(localStorage.getItem('povoarBimRecipes')) || [];
    const recipe = recipes.find(r => r.id == id);
    
    if (!recipe) {
        console.error('üîß Recipe not found for export with id:', id);
        showNotification('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel
    const exportData = [
        [`–†–ï–¶–ï–ü–¢ –ö–ê–®–ò "–ü–û–í–ê–† –ë–ò–ú"`],
        [''],
        ['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞:', recipe.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'],
        ['–ö–∞—Ç–µ–≥–æ—Ä–∏—è:', recipe.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'],
        ['–û–ø–∏—Å–∞–Ω–∏–µ:', recipe.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'],
        ['–û–±—â–∏–π –≤–µ—Å (1 –∫–≥):', `${recipe.totalWeight || 0} –≥`],
        ['–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (1 –∫–≥):', `${(recipe.totalCost || 0).toFixed(2)} ‚ÇΩ`],
        ['–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:', recipe.createdAt ? new Date(recipe.createdAt).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'],
        [''],
        ['–°–û–°–¢–ê–í –†–ï–¶–ï–ü–¢–ê (–Ω–∞ 1 –∫–≥):'],
        ['‚Ññ', '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≥)', '–¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ)', '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)']
    ];
    
    if (recipe.ingredients && recipe.ingredients.length > 0) {
        recipe.ingredients.forEach((ingredient, index) => {
            exportData.push([
                index + 1,
                ingredient.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç',
                `${ingredient.weight || 0} –≥`,
                `${(ingredient.price || 0).toFixed(2)} ‚ÇΩ`,
                `${(ingredient.cost || 0).toFixed(2)} ‚ÇΩ`
            ]);
        });
        
        exportData.push(['']);
        exportData.push(['–ò–¢–û–ì–û:', '', `${recipe.totalWeight || 0} –≥`, '', `${(recipe.totalCost || 0).toFixed(2)} ‚ÇΩ`]);
    } else {
        exportData.push(['–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã']);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∏—â–µ–≤–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    exportData.push(['']);
    exportData.push(['–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:']);
    exportData.push(['–¶–µ–Ω–∞ –∑–∞ 100–≥:', `${((recipe.totalCost || 0) / 10).toFixed(2)} ‚ÇΩ`]);
    exportData.push(['–†–∞—Å—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞ 10 –∫–≥:', `${((recipe.totalCost || 0) * 10).toFixed(2)} ‚ÇΩ`]);
    exportData.push(['–†–∞—Å—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞ 50 –∫–≥:', `${((recipe.totalCost || 0) * 50).toFixed(2)} ‚ÇΩ`]);
    exportData.push(['–†–∞—Å—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞ 100 –∫–≥:', `${((recipe.totalCost || 0) * 100).toFixed(2)} ‚ÇΩ`]);
    
    // –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
    const colWidths = [
        { wch: 5 },  // ‚Ññ
        { wch: 30 }, // –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
        { wch: 15 }, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
        { wch: 15 }, // –¶–µ–Ω–∞
        { wch: 15 }  // –°—Ç–æ–∏–º–æ—Å—Ç—å
    ];
    ws['!cols'] = colWidths;
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–†–µ—Ü–µ–ø—Ç');
    
    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const fileName = `recept-${recipe.name?.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '_') || 'recipe'}-${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification(`–†–µ—Ü–µ–ø—Ç "${recipe.name}" —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ Excel`, 'success');
    console.log('üîß Recipe exported successfully');
}

// –ü–û–õ–ù–´–ï –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ú–ò –ó–ê–î–ê–ù–ò–Ø–ú–ò

function viewProductionTask(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    document.getElementById('production-task-id').value = task.id;
    document.getElementById('production-recipe-select').value = task.recipeId;
    document.getElementById('production-batch-size').value = task.batchSize;
    document.getElementById('production-date').value = task.productionDate;
    document.getElementById('production-batch-number').value = task.batchNumber;
    document.getElementById('production-notes').value = task.notes || '';
    
    // –î–µ–ª–∞–µ–º –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
    const modal = document.getElementById('production-task-modal');
    const inputs = modal.querySelectorAll('input, select, textarea');
    inputs.forEach(input => input.readOnly = true);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = modal.querySelector('button[type="submit"]');
    if (saveBtn) saveBtn.style.display = 'none';
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('production-task-modal-title');
    if (title) title.textContent = `–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞–Ω–∏—è ${task.batchNumber}`;
    
    showModal('production-task-modal', true);
}

function editProductionTask(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è
    document.getElementById('production-task-id').value = task.id;
    document.getElementById('production-recipe-select').value = task.recipeId;
    document.getElementById('production-batch-size').value = task.batchSize;
    document.getElementById('production-date').value = task.productionDate;
    document.getElementById('production-batch-number').value = task.batchNumber;
    document.getElementById('production-notes').value = task.notes || '';
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const modal = document.getElementById('production-task-modal');
    const inputs = modal.querySelectorAll('input, select, textarea');
    inputs.forEach(input => input.readOnly = false);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveBtn = modal.querySelector('button[type="submit"]');
    if (saveBtn) saveBtn.style.display = 'inline-flex';
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('production-task-modal-title');
    if (title) title.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ ${task.batchNumber}`;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç—ã
    updateProductionCalculations();
    
    showModal('production-task-modal', true);
}

function deleteProductionTask(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ ${task.batchNumber || task.id}?`)) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        const index = productionTasks.findIndex(t => t.id === id);
        if (index !== -1) {
            productionTasks.splice(index, 1);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('productionTasks', JSON.stringify(productionTasks));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        loadProductionTasks();
        updateDashboardStats();
        
        showNotification('–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
    }
}

function changeTaskStatus(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    const statuses = [
        { value: 'draft', label: '–ß–µ—Ä–Ω–æ–≤–∏–∫' },
        { value: 'active', label: '–ê–∫—Ç–∏–≤–Ω–æ–µ' },
        { value: 'in-production', label: '–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ' },
        { value: 'completed', label: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' },
        { value: 'cancelled', label: '–û—Ç–º–µ–Ω–µ–Ω–æ' }
    ];
    
    // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
    const currentStatus = task.status || 'draft';
    const statusOptions = statuses.map(s => 
        `<option value="${s.value}" ${s.value === currentStatus ? 'selected' : ''}>${s.label}</option>`
    ).join('');
    
    const newStatus = prompt(
        `–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ${statuses.find(s => s.value === currentStatus)?.label}
        
–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞:
1 - –ß–µ—Ä–Ω–æ–≤–∏–∫
2 - –ê–∫—Ç–∏–≤–Ω–æ–µ  
3 - –í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ
4 - –ó–∞–≤–µ—Ä—à–µ–Ω–æ
5 - –û—Ç–º–µ–Ω–µ–Ω–æ`,
        currentStatus === 'draft' ? '1' : 
        currentStatus === 'active' ? '2' :
        currentStatus === 'in-production' ? '3' :
        currentStatus === 'completed' ? '4' : '5'
    );
    
    const statusMap = {
        '1': 'draft',
        '2': 'active', 
        '3': 'in-production',
        '4': 'completed',
        '5': 'cancelled'
    };
    
    if (newStatus && statusMap[newStatus]) {
        task.status = statusMap[newStatus];
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        localStorage.setItem('productionTasks', JSON.stringify(productionTasks));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        loadProductionTasks();
        
        const statusLabel = statuses.find(s => s.value === task.status)?.label;
        showNotification(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${statusLabel}`, 'success');
    }
}

function exportProductionTask(id) {
    const task = productionTasks.find(t => t.id === id);
    if (!task) return;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ü–µ–ø—Ç –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
    const recipe = recipes.find(r => r.id === task.recipeId);
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel
    const exportData = [
        ['–ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–û–ï –ó–ê–î–ê–ù–ò–ï'],
        ['–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏:', task.batchNumber || task.id],
        ['–†–µ—Ü–µ–ø—Ç:', task.recipeName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'],
        ['–û–±—ä–µ–º –ø–∞—Ä—Ç–∏–∏:', `${task.batchSize} –∫–≥`],
        ['–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞:', task.productionDate ? new Date(task.productionDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'],
        ['–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:', `${(task.totalCost || 0).toFixed(2)} ‚ÇΩ`],
        ['–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:', `${(task.costPerKg || 0).toFixed(2)} ‚ÇΩ/–∫–≥`],
        ['–°—Ç–∞—Ç—É—Å:', getProductionStatus(task).text],
        [''],
        ['–°–û–°–¢–ê–í –†–ï–¶–ï–ü–¢–ê (–Ω–∞ 1 –∫–≥):']
    ];
    
    if (recipe && recipe.ingredients) {
        exportData.push(['–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≥)', '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)']);
        recipe.ingredients.forEach(ing => {
            exportData.push([
                ing.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç',
                `${ing.weight} –≥`,
                `${(ing.cost || 0).toFixed(2)} ‚ÇΩ`
            ]);
        });
        exportData.push(['']);
        exportData.push(['–û–ë–©–ò–ô –†–ê–°–ß–ï–¢ –ù–ê –ü–ê–†–¢–ò–Æ:']);
        exportData.push(['–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç', '–ù–∞ –ø–∞—Ä—Ç–∏—é (–∫–≥)', '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)']);
        recipe.ingredients.forEach(ing => {
            const totalWeight = (ing.weight / 1000) * task.batchSize;
            const totalCost = ing.cost * task.batchSize;
            exportData.push([
                ing.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç',
                `${totalWeight.toFixed(3)} –∫–≥`,
                `${totalCost.toFixed(2)} ‚ÇΩ`
            ]);
        });
    }
    
    if (task.notes) {
        exportData.push(['']);
        exportData.push(['–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:', task.notes]);
    }
    
    // –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ');
    
    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const fileName = `zadanie-${task.batchNumber || task.id}-${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification('–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ Excel', 'success');
}
function clearIngredientFilters() { loadIngredients(); }
function clearProductionFilters() { loadProductionTasks(); }
function filterIngredients() { /* –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ */ }

// –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ü–†–û–ò–ó–í–û–î–°–¢–í–ê
function generateBatchNumber() {
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
    
    // –ù–∞–π—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    const todayBatches = productionTasks.filter(task => 
        task.batchNumber && task.batchNumber.startsWith(dateStr)
    );
    
    let maxNumber = 0;
    todayBatches.forEach(task => {
        const numberMatch = task.batchNumber.match(/(\d+)$/);
        if (numberMatch) {
            maxNumber = Math.max(maxNumber, parseInt(numberMatch[1]));
        }
    });

    const newBatchNumber = dateStr + '-' + String(maxNumber + 1).padStart(3, '0');
    const batchNumberInput = document.getElementById('production-batch-number');
    if (batchNumberInput) {
        batchNumberInput.value = newBatchNumber;
    }
}

function updateProductionCalculations() {
    const recipeId = document.getElementById('production-recipe-select').value;
    const batchSize = parseFloat(document.getElementById('production-batch-size').value) || 0;

    if (!recipeId || batchSize <= 0) {
        return;
    }

    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe || !recipe.ingredients) return;

    // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
    let totalCost = 0;
    recipe.ingredients.forEach(recipeIng => {
        const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
        if (ingredient) {
            const neededWeight = (recipeIng.weight * batchSize) / 1000; // –≤ –∫–≥
            const ingredientCost = neededWeight * ingredient.price;
            totalCost += ingredientCost;
        }
    });

    showNotification(`–†–∞—Å—á–µ—Ç –¥–ª—è –ø–∞—Ä—Ç–∏–∏ ${batchSize} –∫–≥: ${totalCost.toFixed(2)} ‚ÇΩ`, 'info');
}

function saveProductionTask(event) {
    event.preventDefault();

    const recipeId = document.getElementById('production-recipe-select').value;
    const batchSize = parseFloat(document.getElementById('production-batch-size').value);
    let batchNumber = document.getElementById('production-batch-number').value;

    if (!recipeId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç');
        return;
    }

    if (!batchSize || batchSize <= 0) {
        alert('–£–∫–∞–∂–∏—Ç–µ –æ–±—ä–µ–º –ø–∞—Ä—Ç–∏–∏');
        return;
    }

    if (!batchNumber) {
        generateBatchNumber();
        batchNumber = document.getElementById('production-batch-number').value;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –ø–∞—Ä—Ç–∏–∏
    const existingBatch = productionTasks.find(task => task.batchNumber === batchNumber);
    if (existingBatch) {
        const confirmOverride = confirm(`–ü–∞—Ä—Ç–∏—è —Å –Ω–æ–º–µ—Ä–æ–º ${batchNumber} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä?`);
        if (confirmOverride) {
            generateBatchNumber();
            batchNumber = document.getElementById('production-batch-number').value;
        } else {
            return;
        }
    }

    const recipe = recipes.find(r => r.id === recipeId);
    
    // –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–∞—Ä—Ç–∏–∏
    let totalCost = 0;
    if (recipe && recipe.ingredients) {
        recipe.ingredients.forEach(recipeIng => {
            const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
            if (ingredient) {
                const neededWeight = (recipeIng.weight * batchSize) / 1000; // –≤ –∫–≥
                const ingredientCost = neededWeight * ingredient.price;
                totalCost += ingredientCost;
            }
        });
    }

    const taskData = {
        id: document.getElementById('production-task-id').value || Date.now().toString(),
        recipeId: recipeId,
        recipeName: recipe ? recipe.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç',
        batchSize: batchSize,
        batchNumber: batchNumber,
        productionDate: document.getElementById('production-date').value,
        totalCost: totalCost,
        costPerKg: totalCost / batchSize,
        status: 'in-production',
        createdAt: new Date().toISOString(),
        startedAt: new Date().toISOString()
    };

    // –°–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å–æ —Å–∫–ª–∞–¥–∞
    if (recipe && recipe.ingredients) {
        recipe.ingredients.forEach(recipeIng => {
            const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
            if (ingredient) {
                const neededWeight = (recipeIng.weight * batchSize) / 1000; // –≤ –∫–≥
                ingredient.stock = Math.max(0, ingredient.stock - neededWeight);
            }
        });
    }

    const existingIndex = productionTasks.findIndex(task => task.id === taskData.id);
    if (existingIndex >= 0) {
        productionTasks[existingIndex] = taskData;
    } else {
        productionTasks.push(taskData);
    }

    saveDataToStorage();
    hideModal('production-task-modal');
    loadProductionTasks();
    loadIngredients(); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
    updateDashboardStats();

    showNotification(`–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ ${batchNumber} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ! –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: ${totalCost.toFixed(2)} ‚ÇΩ`, 'success');
}

// ========== –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–õ–ò–ï–ù–¢–û–í ==========

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
let currentCustomersPage = 1;
let customersPerPage = 25;
let customersSortField = 'name';
let customersSortDirection = 'asc';
let filteredCustomers = [];

function loadCustomers() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Ç–∏–ø–æ–≤
    loadCustomerTypeFilter();
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
    applyCustomerFilters();
}

function applyCustomerFilters() {
    const searchTerm = document.getElementById('customer-search')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('customer-type-filter')?.value || '';
    const statusFilter = document.getElementById('customer-status-filter')?.value || '';

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    filteredCustomers = customers.filter(customer => {
        const matchesSearch = customer.name.toLowerCase().includes(searchTerm);
        const matchesType = !typeFilter || customer.type === typeFilter;
        const matchesStatus = !statusFilter || customer.status === statusFilter;
        
        return matchesSearch && matchesType && matchesStatus;
    });

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    filteredCustomers.sort((a, b) => {
        let valueA = a[customersSortField] || '';
        let valueB = b[customersSortField] || '';
        
        if (typeof valueA === 'string') {
            valueA = valueA.toLowerCase();
            valueB = valueB.toLowerCase();
        }
        
        if (customersSortDirection === 'asc') {
            return valueA > valueB ? 1 : -1;
        } else {
            return valueA < valueB ? 1 : -1;
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    renderCustomersTable();
    renderCustomersPagination();
    updateCustomersCount();
}

function renderCustomersTable() {
    const tableBody = document.getElementById('customers-table');
    if (!tableBody) return;

    const startIndex = (currentCustomersPage - 1) * customersPerPage;
    const endIndex = startIndex + customersPerPage;
    const pageCustomers = filteredCustomers.slice(startIndex, endIndex);

    if (pageCustomers.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-users text-4xl mb-4 text-gray-300"></i>
                    <div>–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                    <div class="text-sm">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</div>
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = '';
    pageCustomers.forEach(customer => {
        const row = tableBody.insertRow();
        const ordersCount = getCustomerOrdersCount(customer.id);
        const totalOrdersSum = getCustomerOrdersSum(customer.id);
        
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                        <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-user text-blue-600"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">${customer.name}</div>
                        ${customer.notes ? `<div class="text-xs text-gray-500 truncate max-w-xs" title="${customer.notes}">${customer.notes}</div>` : ''}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getCustomerTypeBadgeClass(customer.type)}">
                    ${getCustomerTypeLabel(customer.type)}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <div>${customer.phone || '-'}</div>
                <div class="text-gray-500">${customer.email || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <div class="font-medium">${ordersCount} –∑–∞–∫–∞–∑–æ–≤</div>
                ${totalOrdersSum > 0 ? `<div class="text-gray-500">${totalOrdersSum.toFixed(2)} ‚ÇΩ</div>` : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button onclick="toggleCustomerStatus('${customer.id}')" 
                        class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full cursor-pointer hover:opacity-80 transition-opacity ${customer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    <i class="fas fa-circle mr-1 ${customer.status === 'active' ? 'text-green-600' : 'text-red-600'}"></i>
                    ${customer.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ –∞–∫—Ç–∏–≤–Ω—ã–π'}
                </button>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end space-x-2">
                    <button onclick="editCustomer('${customer.id}')" 
                            class="text-blue-600 hover:text-blue-900 p-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteCustomer('${customer.id}')" 
                            class="text-red-600 hover:text-red-900 p-1" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
    });
}

function renderCustomersPagination() {
    const paginationContainer = document.getElementById('customers-pagination');
    if (!paginationContainer) return;

    const totalPages = Math.ceil(filteredCustomers.length / customersPerPage);
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }

    const startItem = (currentCustomersPage - 1) * customersPerPage + 1;
    const endItem = Math.min(currentCustomersPage * customersPerPage, filteredCustomers.length);

    paginationContainer.innerHTML = `
        <div class="flex-1 flex justify-between sm:hidden">
            <button onclick="changeCustomersPage(${currentCustomersPage - 1})" 
                    ${currentCustomersPage === 1 ? 'disabled' : ''} 
                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                –ù–∞–∑–∞–¥
            </button>
            <button onclick="changeCustomersPage(${currentCustomersPage + 1})" 
                    ${currentCustomersPage === totalPages ? 'disabled' : ''} 
                    class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                –í–ø–µ—Ä–µ–¥
            </button>
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-700">
                    –ü–æ–∫–∞–∑–∞–Ω—ã —Å <span class="font-medium">${startItem}</span> –ø–æ <span class="font-medium">${endItem}</span> –∏–∑ <span class="font-medium">${filteredCustomers.length}</span> —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                    ${generatePaginationButtons(currentCustomersPage, totalPages, 'changeCustomersPage')}
                </nav>
            </div>
        </div>
    `;
}

function changeCustomersPage(page) {
    const totalPages = Math.ceil(filteredCustomers.length / customersPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentCustomersPage = page;
    renderCustomersTable();
    renderCustomersPagination();
}

function updateCustomersCount() {
    const countElement = document.getElementById('customers-count');
    if (countElement) {
        countElement.textContent = `(${filteredCustomers.length})`;
    }
}

function getCustomerTypeLabel(type) {
    const typeObj = customerTypes.find(t => t.id === type);
    return typeObj ? typeObj.name : type;
}

function getCustomerTypeBadgeClass(type) {
    const classes = {
        'physical': 'bg-blue-100 text-blue-800',
        'legal': 'bg-purple-100 text-purple-800',
        'store': 'bg-green-100 text-green-800',
        'wholesale': 'bg-orange-100 text-orange-800'
    };
    return classes[type] || 'bg-gray-100 text-gray-800';
}

function getCustomerOrdersCount(customerId) {
    return orders.filter(order => order.customerId === customerId).length;
}

function getCustomerOrdersSum(customerId) {
    return orders.filter(order => order.customerId === customerId)
                 .reduce((sum, order) => sum + (order.total || 0), 0);
}

function toggleCustomerStatus(customerId) {
    const customer = customers.find(c => c.id === customerId);
    if (!customer) return;

    customer.status = customer.status === 'active' ? 'inactive' : 'active';
    
    saveDataToStorage();
    applyCustomerFilters();
    updateDashboardStats();
    
    showNotification(`–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞ "${customer.name}" –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${customer.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ –∞–∫—Ç–∏–≤–Ω—ã–π'}"`, 'success');
}

function saveCustomer(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const customerData = {
        id: document.getElementById('customer-id').value || Date.now().toString(),
        name: document.getElementById('customer-name').value.trim(),
        type: document.getElementById('customer-type').value,
        status: document.getElementById('customer-status').value,
        phone: document.getElementById('customer-phone').value.trim(),
        email: document.getElementById('customer-email').value.trim(),
        address: document.getElementById('customer-address').value.trim(),
        notes: document.getElementById('customer-notes').value.trim(),
        createdAt: document.getElementById('customer-id').value ? 
                   customers.find(c => c.id === document.getElementById('customer-id').value)?.createdAt || new Date().toISOString() : 
                   new Date().toISOString()
    };

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!customerData.name || customerData.name.length < 2) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)', 'error');
        return;
    }

    if (!customerData.type) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞', 'error');
        return;
    }

    if (customerData.notes.length > 1000) {
        showNotification('–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –Ω–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–≤—ã—à–∞—Ç—å 1000 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }

    const existingIndex = customers.findIndex(c => c.id === customerData.id);
    if (existingIndex >= 0) {
        customers[existingIndex] = customerData;
    } else {
        customers.push(customerData);
    }

    saveDataToStorage();
    hideModal('customer-modal');
    loadCustomers();
    updateDashboardStats();

    showNotification(`–ö–ª–∏–µ–Ω—Ç "${customerData.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 'success');
}

function editCustomer(customerId) {
    const customer = customers.find(c => c.id === customerId);
    if (!customer) return;

    document.getElementById('customer-id').value = customer.id;
    document.getElementById('customer-name').value = customer.name;
    document.getElementById('customer-type').value = customer.type;
    document.getElementById('customer-status').value = customer.status || 'active';
    document.getElementById('customer-phone').value = customer.phone || '';
    document.getElementById('customer-email').value = customer.email || '';
    document.getElementById('customer-address').value = customer.address || '';
    document.getElementById('customer-notes').value = customer.notes || '';
    document.getElementById('customer-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞';

    loadCustomerTypesToSelect();
    showModal('customer-modal', true);
}

function deleteCustomer(customerId) {
    const customer = customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const relatedOrders = orders.filter(order => order.customerId === customerId);
    
    let confirmMessage = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ "${customer.name}"?`;
    if (relatedOrders.length > 0) {
        confirmMessage += `\n\n–í–Ω–∏–º–∞–Ω–∏–µ: –£ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å ${relatedOrders.length} –∑–∞–∫–∞–∑–æ–≤. –û–Ω–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ.`;
    }
    
    if (!confirm(confirmMessage)) return;

    const customerIndex = customers.findIndex(c => c.id === customerId);
    if (customerIndex >= 0) {
        const customerName = customers[customerIndex].name;
        customers.splice(customerIndex, 1);
        
        saveDataToStorage();
        loadCustomers();
        updateDashboardStats();
        
        showNotification(`–ö–ª–∏–µ–Ω—Ç "${customerName}" —É–¥–∞–ª–µ–Ω`, 'success');
    }
}

// ========== –§–£–ù–ö–¶–ò–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ò –ü–û–ò–°–ö–ê –ö–õ–ò–ï–ù–¢–û–í ==========

function filterCustomers() {
    currentCustomersPage = 1; // –°–±—Ä–æ—Å –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    applyCustomerFilters();
}

function resetCustomerFilters() {
    document.getElementById('customer-search').value = '';
    document.getElementById('customer-type-filter').value = '';
    document.getElementById('customer-status-filter').value = '';
    
    currentCustomersPage = 1;
    applyCustomerFilters();
}

function sortCustomers(field) {
    if (customersSortField === field) {
        customersSortDirection = customersSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        customersSortField = field;
        customersSortDirection = 'asc';
    }
    
    applyCustomerFilters();
}

function loadCustomerTypeFilter() {
    const select = document.getElementById('customer-type-filter');
    if (!select) return;

    const currentValue = select.value;
    select.innerHTML = '<option value="">–í—Å–µ —Ç–∏–ø—ã</option>';
    
    customerTypes.forEach(type => {
        select.innerHTML += `<option value="${type.id}">${type.name}</option>`;
    });
    
    select.value = currentValue;
}

function loadCustomerTypesToSelect() {
    const select = document.getElementById('customer-type');
    if (!select) return;

    const currentValue = select.value;
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>';
    
    customerTypes.forEach(type => {
        select.innerHTML += `<option value="${type.id}">${type.name}</option>`;
    });
    
    select.value = currentValue;
}

// ========== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –¢–ò–ü–ê–ú–ò –ö–õ–ò–ï–ù–¢–û–í ==========

function loadCustomerTypesList() {
    const container = document.getElementById('customer-types-list');
    if (!container) return;

    container.innerHTML = '';
    customerTypes.forEach(type => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg';
        
        div.innerHTML = `
            <div class="flex items-center">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getCustomerTypeBadgeClass(type.id)}">
                    ${type.name}
                </span>
                <span class="ml-2 text-sm text-gray-500">(${getCustomerTypeUsageCount(type.id)} –∫–ª–∏–µ–Ω—Ç–æ–≤)</span>
            </div>
            <div class="flex space-x-2">
                ${type.removable ? `
                    <button onclick="deleteCustomerType('${type.id}')" 
                            class="text-red-600 hover:text-red-800 p-1" 
                            title="–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                ` : `
                    <span class="text-gray-400 text-xs">–°–∏—Å—Ç–µ–º–Ω—ã–π</span>
                `}
            </div>
        `;
        
        container.appendChild(div);
    });
}

function getCustomerTypeUsageCount(typeId) {
    return customers.filter(customer => customer.type === typeId).length;
}

function addCustomerType() {
    const input = document.getElementById('new-customer-type');
    const typeName = input.value.trim();
    
    if (!typeName) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞', 'error');
        return;
    }
    
    if (typeName.length < 2 || typeName.length > 50) {
        showNotification('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
    if (customerTypes.some(type => type.name.toLowerCase() === typeName.toLowerCase())) {
        showNotification('–¢–∏–ø —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
    }
    
    const newType = {
        id: 'custom_' + Date.now(),
        name: typeName,
        removable: true
    };
    
    customerTypes.push(newType);
    saveDataToStorage();
    
    input.value = '';
    loadCustomerTypesList();
    loadCustomerTypeFilter();
    loadCustomerTypesToSelect();
    
    showNotification(`–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞ "${typeName}" –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
}

function deleteCustomerType(typeId) {
    const type = customerTypes.find(t => t.id === typeId);
    if (!type) return;
    
    if (!type.removable) {
        showNotification('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞', 'error');
        return;
    }
    
    const usageCount = getCustomerTypeUsageCount(typeId);
    if (usageCount > 0) {
        showNotification(`–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø "${type.name}". –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É ${usageCount} –∫–ª–∏–µ–Ω—Ç–æ–≤.`, 'error');
        return;
    }
    
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø "${type.name}"?`)) return;
    
    const typeIndex = customerTypes.findIndex(t => t.id === typeId);
    if (typeIndex >= 0) {
        customerTypes.splice(typeIndex, 1);
        saveDataToStorage();
        
        loadCustomerTypesList();
        loadCustomerTypeFilter();
        loadCustomerTypesToSelect();
        
        showNotification(`–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞ "${type.name}" —É–¥–∞–ª–µ–Ω`, 'success');
    }
}

// ========== –§–£–ù–ö–¶–ò–ò –≠–ö–°–ü–û–†–¢–ê –ò –ü–ï–ß–ê–¢–ò ==========

function exportCustomersToExcel() {
    if (filteredCustomers.length === 0) {
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
        return;
    }

    const data = [
        ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–¢–∏–ø', '–°—Ç–∞—Ç—É—Å', '–¢–µ–ª–µ—Ñ–æ–Ω', 'Email', '–ê–¥—Ä–µ—Å', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤', '–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤', '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è', '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è']
    ];
    
    filteredCustomers.forEach(customer => {
        data.push([
            customer.name,
            getCustomerTypeLabel(customer.type),
            customer.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ –∞–∫—Ç–∏–≤–Ω—ã–π',
            customer.phone || '',
            customer.email || '',
            customer.address || '',
            getCustomerOrdersCount(customer.id),
            getCustomerOrdersSum(customer.id).toFixed(2) + ' ‚ÇΩ',
            customer.notes || '',
            new Date(customer.createdAt).toLocaleDateString('ru-RU')
        ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
    const colWidths = [
        { wch: 25 }, // –ù–∞–∑–≤–∞–Ω–∏–µ
        { wch: 15 }, // –¢–∏–ø
        { wch: 12 }, // –°—Ç–∞—Ç—É—Å
        { wch: 15 }, // –¢–µ–ª–µ—Ñ–æ–Ω
        { wch: 25 }, // Email
        { wch: 30 }, // –ê–¥—Ä–µ—Å
        { wch: 12 }, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤
        { wch: 15 }, // –°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤
        { wch: 40 }, // –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
        { wch: 12 }  // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
    ];
    ws['!cols'] = colWidths;
    
    XLSX.utils.book_append_sheet(wb, ws, '–ö–ª–∏–µ–Ω—Ç—ã');
    
    const fileName = `clients_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification(`–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: ${fileName}`, 'success');
}

function printCustomers() {
    if (filteredCustomers.length === 0) {
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏', 'error');
        return;
    }

    const printContent = `
        <html>
        <head>
            <title>–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ - –ü–æ–≤–∞—Ä –ë–∏–º</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .logo { font-size: 24px; font-weight: bold; color: #2563eb; }
                .subtitle { color: #666; margin-top: 5px; }
                .info { margin-bottom: 20px; font-size: 14px; color: #666; }
                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f5f5f5; font-weight: bold; }
                .status-active { color: #059669; }
                .status-inactive { color: #dc2626; }
                .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #999; }
                @media print {
                    body { margin: 10px; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">ü•ò CRM "–ü–æ–≤–∞—Ä –ë–∏–º"</div>
                <div class="subtitle">–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
            </div>
            
            <div class="info">
                <strong>–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${new Date().toLocaleString('ru-RU')}<br>
                <strong>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤:</strong> ${filteredCustomers.length}
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>‚Ññ</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–¢–∏–ø</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>Email</th>
                        <th>–ó–∞–∫–∞–∑—ã</th>
                        <th>–°—É–º–º–∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredCustomers.map((customer, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${customer.name}</td>
                            <td>${getCustomerTypeLabel(customer.type)}</td>
                            <td class="${customer.status === 'active' ? 'status-active' : 'status-inactive'}">
                                ${customer.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ –∞–∫—Ç–∏–≤–Ω—ã–π'}
                            </td>
                            <td>${customer.phone || '-'}</td>
                            <td>${customer.email || '-'}</td>
                            <td>${getCustomerOrdersCount(customer.id)}</td>
                            <td>${getCustomerOrdersSum(customer.id).toFixed(2)} ‚ÇΩ</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="footer">
                –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π CRM "–ü–æ–≤–∞—Ä –ë–∏–º"
            </div>
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

function generatePaginationButtons(currentPage, totalPages, onClickFunction) {
    let buttons = '';
    
    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    buttons += `
        <button onclick="${onClickFunction}(${currentPage - 1})" 
                ${currentPage === 1 ? 'disabled' : ''} 
                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        buttons += `
            <button onclick="${onClickFunction}(1)" 
                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                1
            </button>
        `;
        if (startPage > 2) {
            buttons += `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        buttons += `
            <button onclick="${onClickFunction}(${i})" 
                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium ${
                        i === currentPage 
                            ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' 
                            : 'bg-white text-gray-700 hover:bg-gray-50'
                    }">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            buttons += `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>`;
        }
        buttons += `
            <button onclick="${onClickFunction}(${totalPages})" 
                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                ${totalPages}
            </button>
        `;
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
    buttons += `
        <button onclick="${onClickFunction}(${currentPage + 1})" 
                ${currentPage === totalPages ? 'disabled' : ''} 
                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    return buttons;
}

// ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–û–í–ê–†–û–í ==========

function loadProducts() {
    const tableBody = document.getElementById('products-table');
    if (!tableBody) return;

    tableBody.innerHTML = '';

    products.forEach(product => {
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                        <div class="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fas fa-box text-green-600"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">${product.name}</div>
                        <div class="text-sm text-gray-500">${product.description || ''}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${product.sku}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${product.price.toFixed(2)} ‚ÇΩ
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <span class="${product.stock < 10 ? 'text-red-600' : 'text-green-600'}">${product.stock} —à—Ç</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="badge-${product.stock > 0 ? 'active' : 'inactive'}">
                    ${product.stock > 0 ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="editProduct('${product.id}')" class="text-green-600 hover:text-green-900 mr-3">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
}

function saveProduct(event) {
    event.preventDefault();
    
    const productData = {
        id: document.getElementById('product-id').value || Date.now().toString(),
        name: document.getElementById('product-name').value.trim(),
        sku: document.getElementById('product-sku').value.trim(),
        price: parseFloat(document.getElementById('product-price').value) || 0,
        stock: parseInt(document.getElementById('product-stock').value) || 0,
        weight: parseInt(document.getElementById('product-weight').value) || 0,
        description: document.getElementById('product-description').value.trim(),
        createdAt: new Date().toISOString()
    };

    if (!productData.name || !productData.sku) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }

    const existingIndex = products.findIndex(p => p.id === productData.id);
    if (existingIndex >= 0) {
        products[existingIndex] = productData;
    } else {
        products.push(productData);
    }

    saveDataToStorage();
    hideModal('product-modal');
    loadProducts();
    updateDashboardStats();

    showNotification(`–¢–æ–≤–∞—Ä "${productData.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 'success');
}

function editProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    document.getElementById('product-id').value = product.id;
    document.getElementById('product-name').value = product.name;
    document.getElementById('product-sku').value = product.sku;
    document.getElementById('product-price').value = product.price;
    document.getElementById('product-stock').value = product.stock;
    document.getElementById('product-weight').value = product.weight || '';
    document.getElementById('product-description').value = product.description || '';
    document.getElementById('product-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';

    showModal('product-modal', true);
}

function deleteProduct(productId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) return;

    const productIndex = products.findIndex(p => p.id === productId);
    if (productIndex >= 0) {
        const productName = products[productIndex].name;
        products.splice(productIndex, 1);
        
        saveDataToStorage();
        loadProducts();
        updateDashboardStats();
        
        showNotification(`–¢–æ–≤–∞—Ä "${productName}" —É–¥–∞–ª–µ–Ω`, 'success');
    }
}

// ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ó–ê–ö–ê–ó–û–í ==========

function loadOrders() {
    const tableBody = document.getElementById('orders-table');
    if (!tableBody) return;

    tableBody.innerHTML = '';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Å–µ–ª–µ–∫—Ç
    loadCustomersToSelect();

    orders.forEach(order => {
        const customer = customers.find(c => c.id === order.customerId);
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${order.number}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${customer ? customer.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${new Date(order.date).toLocaleDateString('ru-RU')}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${order.total.toFixed(2)} ‚ÇΩ
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="badge-${getOrderStatusColor(order.status)}">${getOrderStatusLabel(order.status)}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="editOrder('${order.id}')" class="text-orange-600 hover:text-orange-900 mr-3">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteOrder('${order.id}')" class="text-red-600 hover:text-red-900">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
}

function getOrderStatusLabel(status) {
    const labels = {
        'new': '–ù–æ–≤—ã–π',
        'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
        'production': '–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ',
        'ready': '–ì–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ',
        'shipped': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω',
        'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
        'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
    };
    return labels[status] || status;
}

function getOrderStatusColor(status) {
    const colors = {
        'new': 'active',
        'confirmed': 'active', 
        'production': 'wholesale',
        'ready': 'store',
        'shipped': 'legal',
        'delivered': 'active',
        'cancelled': 'inactive'
    };
    return colors[status] || 'active';
}

function loadCustomersToSelect() {
    const select = document.getElementById('order-customer');
    if (!select) return;

    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>';
    customers.forEach(customer => {
        select.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
    });
}

function saveOrder(event) {
    event.preventDefault();
    
    const orderData = {
        id: document.getElementById('order-id').value || Date.now().toString(),
        number: document.getElementById('order-number').value.trim(),
        customerId: document.getElementById('order-customer').value,
        date: document.getElementById('order-date').value,
        status: document.getElementById('order-status').value,
        total: parseFloat(document.getElementById('order-total').value) || 0,
        notes: document.getElementById('order-notes').value.trim(),
        createdAt: new Date().toISOString()
    };

    if (!orderData.number || !orderData.customerId || !orderData.date) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }

    const existingIndex = orders.findIndex(o => o.id === orderData.id);
    if (existingIndex >= 0) {
        orders[existingIndex] = orderData;
    } else {
        orders.push(orderData);
    }

    saveDataToStorage();
    hideModal('order-modal');
    loadOrders();
    updateDashboardStats();

    showNotification(`–ó–∞–∫–∞–∑ "${orderData.number}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 'success');
}

function editOrder(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;

    document.getElementById('order-id').value = order.id;
    document.getElementById('order-number').value = order.number;
    document.getElementById('order-customer').value = order.customerId;
    document.getElementById('order-date').value = order.date;
    document.getElementById('order-status').value = order.status;
    document.getElementById('order-total').value = order.total;
    document.getElementById('order-notes').value = order.notes || '';
    document.getElementById('order-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑';

    loadCustomersToSelect();
    showModal('order-modal', true);
}

function deleteOrder(orderId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) return;

    const orderIndex = orders.findIndex(o => o.id === orderId);
    if (orderIndex >= 0) {
        const orderNumber = orders[orderIndex].number;
        orders.splice(orderIndex, 1);
        
        saveDataToStorage();
        loadOrders();
        updateDashboardStats();
        
        showNotification(`–ó–∞–∫–∞–∑ "${orderNumber}" —É–¥–∞–ª–µ–Ω`, 'success');
    }
}

// ================================
// –ú–û–î–£–õ–¨ –¢–û–í–ê–†–û–í - –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ================================

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ SKU
function generateSKU(categoryPrefix = '–¢–í–†') {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.random().toString(36).substring(2, 5).toUpperCase();
    return `${categoryPrefix}-${timestamp}-${random}`;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SKU –¥–ª—è —Ñ–æ—Ä–º—ã —Ç–æ–≤–∞—Ä–∞
function generateProductSKU() {
    const nameField = document.getElementById('product-name');
    const skuField = document.getElementById('product-sku');
    const categoryField = document.getElementById('product-category');
    
    if (!nameField || !skuField) return;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SKU —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∏ SKU –ø—É—Å—Ç–æ–µ
    if (nameField.value.trim() && !skuField.value) {
        let prefix = '–¢–í–†';
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –ø—Ä–µ—Ñ–∏–∫—Å
        if (categoryField && categoryField.value) {
            const category = productCategories.find(c => c.id === categoryField.value);
            if (category && category.prefix) {
                prefix = category.prefix;
            }
        }
        
        skuField.value = generateSKU(prefix);
    }
}

// –†–∞—Å—á—ë—Ç –º–∞—Ä–∂–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
function calculateMargin() {
    const costPriceField = document.getElementById('product-cost-price');
    const salePriceField = document.getElementById('product-sale-price');
    const marginField = document.getElementById('product-margin');
    
    if (!costPriceField || !salePriceField || !marginField) return;
    
    const costPrice = parseFloat(costPriceField.value) || 0;
    const salePrice = parseFloat(salePriceField.value) || 0;
    
    if (costPrice > 0 && salePrice > 0) {
        const margin = ((salePrice - costPrice) / costPrice * 100).toFixed(2);
        marginField.value = margin;
    } else {
        marginField.value = '';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü—É
function loadProducts() {
    const tbody = document.getElementById('products-table-body');
    if (!tbody) return;

    if (!products || products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-box-open text-4xl mb-2 block"></i>
                    –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = products.map(product => {
        const category = productCategories.find(c => c.id === product.categoryId);
        const unit = productUnits.find(u => u.id === product.unitId);
        const totalStock = calculateTotalStock(product.id);
        const stockStatus = getStockStatus(totalStock, product.minStock || 0);
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="h-10 w-10 flex-shrink-0">
                            <div class="h-10 w-10 rounded-lg bg-gray-200 flex items-center justify-center">
                                <i class="fas fa-cube text-gray-500"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${product.name}</div>
                            <div class="text-sm text-gray-500">${product.sku}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                        ${category ? category.name : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <div class="text-sm font-medium">${product.salePrice ? product.salePrice.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    ${product.margin ? '<div class="text-xs text-green-600">+' + product.margin + '%</div>' : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <span class="text-sm font-medium ${stockStatus.color}">${totalStock}</span>
                        <span class="text-xs text-gray-500 ml-1">${unit ? unit.name : '—à—Ç'}</span>
                        ${stockStatus.icon}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${product.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${product.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${product.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(product.createdAt).toLocaleDateString('ru-RU')}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editProduct('${product.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="viewProductBatches('${product.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="–ü–∞—Ä—Ç–∏–∏">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// –†–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞ —Ç–æ–≤–∞—Ä–∞
function calculateTotalStock(productId) {
    if (!productBatches) return 0;
    return productBatches
        .filter(batch => batch.productId === productId && batch.quantity > 0)
        .reduce((total, batch) => total + batch.quantity, 0);
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
function getStockStatus(currentStock, minStock) {
    if (currentStock === 0) {
        return { color: 'text-red-600', icon: '<i class="fas fa-exclamation-triangle text-red-500 ml-1"></i>' };
    } else if (currentStock <= minStock) {
        return { color: 'text-yellow-600', icon: '<i class="fas fa-exclamation-circle text-yellow-500 ml-1"></i>' };
    }
    return { color: 'text-green-600', icon: '' };
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
function saveProduct(event) {
    event.preventDefault();
    
    const productData = {
        id: document.getElementById('product-id').value || Date.now().toString(),
        sku: document.getElementById('product-sku').value || generateSKU(),
        name: document.getElementById('product-name').value.trim(),
        categoryId: document.getElementById('product-category').value,
        unitId: document.getElementById('product-unit').value,
        costPrice: parseFloat(document.getElementById('product-cost-price').value) || 0,
        salePrice: parseFloat(document.getElementById('product-sale-price').value) || 0,
        margin: parseFloat(document.getElementById('product-margin').value) || 0,
        minStock: parseInt(document.getElementById('product-min-stock').value) || 0,
        maxStock: parseInt(document.getElementById('product-max-stock').value) || 0,
        description: document.getElementById('product-description').value.trim(),
        status: document.getElementById('product-status').value,
        barcode: document.getElementById('product-barcode').value.trim(),
        createdAt: document.getElementById('product-id').value ? 
                  products.find(p => p.id === document.getElementById('product-id').value)?.createdAt || new Date().toISOString() : 
                  new Date().toISOString()
    };

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    if (!productData.name || !productData.categoryId || !productData.unitId || !productData.costPrice || !productData.salePrice) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –µ–¥–∏–Ω–∏—Ü–∞, —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏)', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ SKU
    const existingProduct = products.find(p => p.sku === productData.sku && p.id !== productData.id);
    if (existingProduct) {
        showNotification('–¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º –∞—Ä—Ç–∏–∫—É–ª–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ SKU –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
    if (!productData.sku) {
        const category = productCategories.find(c => c.id === productData.categoryId);
        productData.sku = generateSKU(category?.prefix || '–¢–í–†');
    }

    const existingIndex = products.findIndex(p => p.id === productData.id);
    if (existingIndex >= 0) {
        products[existingIndex] = { ...products[existingIndex], ...productData };
    } else {
        products.push(productData);
    }

    saveDataToStorage();
    hideModal('product-modal');
    loadProducts();
    updateDashboardStats();

    showNotification(`–¢–æ–≤–∞—Ä "${productData.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 'success');
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
function editProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    document.getElementById('product-id').value = product.id;
    document.getElementById('product-sku').value = product.sku;
    document.getElementById('product-name').value = product.name;
    document.getElementById('product-category').value = product.categoryId;
    document.getElementById('product-unit').value = product.unitId;
    document.getElementById('product-cost-price').value = product.costPrice || '';
    document.getElementById('product-sale-price').value = product.salePrice || '';
    document.getElementById('product-margin').value = product.margin || '';
    document.getElementById('product-min-stock').value = product.minStock || '';
    document.getElementById('product-max-stock').value = product.maxStock || '';
    document.getElementById('product-description').value = product.description || '';
    document.getElementById('product-status').value = product.status;
    document.getElementById('product-barcode').value = product.barcode || '';
    document.getElementById('product-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';

    loadProductCategoriesToSelect();
    loadProductUnitsToSelect();
    showModal('product-modal', true);
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
function deleteProduct(productId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) return;

    const productIndex = products.findIndex(p => p.id === productId);
    if (productIndex >= 0) {
        const productName = products[productIndex].name;
        
        // –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏
        productBatches = productBatches.filter(batch => batch.productId !== productId);
        
        products.splice(productIndex, 1);
        
        saveDataToStorage();
        loadProducts();
        updateDashboardStats();
        
        showNotification(`–¢–æ–≤–∞—Ä "${productName}" —É–¥–∞–ª–µ–Ω`, 'success');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Å–µ–ª–µ–∫—Ç
function loadProductCategoriesToSelect() {
    console.log('üîß loadProductCategoriesToSelect –≤—ã–∑–≤–∞–Ω–∞');
    const select = document.getElementById('product-category');
    if (!select) {
        console.error('‚ùå –°–µ–ª–µ–∫—Ç product-category –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    console.log('üîß –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:', productCategories.length);
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
    productCategories.forEach(category => {
        select.innerHTML += `<option value="${category.id}">${category.name}</option>`;
    });
    console.log('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ —Å–µ–ª–µ–∫—Ç');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤ —Å–µ–ª–µ–∫—Ç
function loadProductUnitsToSelect() {
    console.log('üîß loadProductUnitsToSelect –≤—ã–∑–≤–∞–Ω–∞');
    const select = document.getElementById('product-unit');
    if (!select) {
        console.error('‚ùå –°–µ–ª–µ–∫—Ç product-unit –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    console.log('üîß –ï–¥–∏–Ω–∏—Ü—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:', productUnits.length);
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É</option>';
    productUnits.forEach(unit => {
        select.innerHTML += `<option value="${unit.id}">${unit.name} (${unit.symbol})</option>`;
    });
    console.log('‚úÖ –ï–¥–∏–Ω–∏—Ü—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ —Å–µ–ª–µ–∫—Ç');
}

// –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–æ–≤–∞—Ä–∞ —Å –æ—á–∏—Å—Ç–∫–æ–π —Ñ–æ—Ä–º—ã
function showProductModal() {
    console.log('üîß showProductModal –≤—ã–∑–≤–∞–Ω–∞');
    console.log('üîß productCategories:', productCategories);
    console.log('üîß productUnits:', productUnits);
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É (–Ω–∞–π–¥—ë–º —Ñ–æ—Ä–º—É –ø–æ –±–ª–∏–∂–∞–π—à–µ–º—É —Ä–æ–¥–∏—Ç–µ–ª—é)
    const form = document.querySelector('#product-modal form');
    if (form) form.reset();
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤—Ä—É—á–Ω—É—é
    document.getElementById('product-id').value = '';
    document.getElementById('product-sku').value = '';
    document.getElementById('product-name').value = '';
    document.getElementById('product-category').value = '';
    document.getElementById('product-unit').value = '';
    document.getElementById('product-cost-price').value = '';
    document.getElementById('product-sale-price').value = '';
    document.getElementById('product-margin').value = '';
    document.getElementById('product-min-stock').value = '';
    document.getElementById('product-max-stock').value = '';
    document.getElementById('product-description').value = '';
    document.getElementById('product-status').value = 'active';
    document.getElementById('product-barcode').value = '';
    
    document.getElementById('product-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–ª–µ–∫—Ç—ã
    console.log('üîß –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–ª–µ–∫—Ç—ã...');
    loadProductCategoriesToSelect();
    loadProductUnitsToSelect();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    console.log('üîß –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ...');
    showModal('product-modal', true);
}

// ================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò –¢–û–í–ê–†–û–í
// ================================

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function loadProductCategories() {
    const tbody = document.getElementById('categories-table-body');
    if (!tbody) return;

    if (!productCategories || productCategories.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-tags text-4xl mb-2 block"></i>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = productCategories.map(category => {
        const productsCount = products.filter(p => p.categoryId === category.id).length;
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="h-8 w-8 flex-shrink-0">
                            <div class="h-8 w-8 rounded bg-blue-100 flex items-center justify-center">
                                <i class="fas fa-tag text-blue-600 text-xs"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">${category.name}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${category.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${category.prefix || '–¢–í–†'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${productsCount} —Ç–æ–≤–∞—Ä–æ–≤
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editProductCategory('${category.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteProductCategory('${category.id}')" class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function saveProductCategory(event) {
    event.preventDefault();
    
    const categoryData = {
        id: document.getElementById('category-id').value || Date.now().toString(),
        name: document.getElementById('category-name').value.trim(),
        description: document.getElementById('category-description').value.trim(),
        prefix: document.getElementById('category-prefix').value.trim().toUpperCase() || '–¢–í–†',
        createdAt: document.getElementById('category-id').value ? 
                  productCategories.find(c => c.id === document.getElementById('category-id').value)?.createdAt || new Date().toISOString() : 
                  new Date().toISOString()
    };

    if (!categoryData.name) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è
    const existingCategory = productCategories.find(c => c.name === categoryData.name && c.id !== categoryData.id);
    if (existingCategory) {
        showNotification('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
    }

    const existingIndex = productCategories.findIndex(c => c.id === categoryData.id);
    if (existingIndex >= 0) {
        productCategories[existingIndex] = { ...productCategories[existingIndex], ...categoryData };
    } else {
        productCategories.push(categoryData);
    }

    saveDataToStorage();
    hideModal('category-modal');
    loadProductCategories();

    showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${categoryData.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`, 'success');
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function editProductCategory(categoryId) {
    const category = productCategories.find(c => c.id === categoryId);
    if (!category) return;

    document.getElementById('category-id').value = category.id;
    document.getElementById('category-name').value = category.name;
    document.getElementById('category-description').value = category.description || '';
    document.getElementById('category-prefix').value = category.prefix || '';
    document.getElementById('category-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';

    showModal('category-modal', true);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function deleteProductCategory(categoryId) {
    const productsInCategory = products.filter(p => p.categoryId === categoryId).length;
    if (productsInCategory > 0) {
        showNotification(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é. –í –Ω–µ–π —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è ${productsInCategory} —Ç–æ–≤–∞—Ä–æ–≤`, 'error');
        return;
    }

    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) return;

    const categoryIndex = productCategories.findIndex(c => c.id === categoryId);
    if (categoryIndex >= 0) {
        const categoryName = productCategories[categoryIndex].name;
        productCategories.splice(categoryIndex, 1);
        
        saveDataToStorage();
        loadProductCategories();
        
        showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${categoryName}" —É–¥–∞–ª–µ–Ω–∞`, 'success');
    }
}

// –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function showProductCategoryModal() {
    console.log('üîß showProductCategoryModal –≤—ã–∑–≤–∞–Ω–∞');
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    const nameField = document.getElementById('new-category-name');
    const colorField = document.getElementById('new-category-color');
    
    if (nameField) nameField.value = '';
    if (colorField) colorField.value = '#10B981';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    loadProductCategories();
    
    showModal('product-categories-modal', true);
}

// ================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ï–î–ò–ù–ò–¶–ê–ú–ò –ò–ó–ú–ï–†–ï–ù–ò–Ø
// ================================

// –ó–∞–≥—Ä—É–∑–∫–∞ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è
function loadProductUnits() {
    const tbody = document.getElementById('units-table-body');
    if (!tbody) return;

    if (!productUnits || productUnits.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-ruler text-4xl mb-2 block"></i>
                    –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = productUnits.map(unit => {
        const productsCount = products.filter(p => p.unitId === unit.id).length;
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${unit.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                        ${unit.symbol}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${unit.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${productsCount} —Ç–æ–≤–∞—Ä–æ–≤
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editProductUnit('${unit.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteProductUnit('${unit.id}')" class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
function saveProductUnit(event) {
    event.preventDefault();
    
    const unitData = {
        id: document.getElementById('unit-id').value || Date.now().toString(),
        name: document.getElementById('unit-name').value.trim(),
        symbol: document.getElementById('unit-symbol').value.trim(),
        description: document.getElementById('unit-description').value.trim(),
        createdAt: document.getElementById('unit-id').value ? 
                  productUnits.find(u => u.id === document.getElementById('unit-id').value)?.createdAt || new Date().toISOString() : 
                  new Date().toISOString()
    };

    if (!unitData.name || !unitData.symbol) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–∏–º–≤–æ–ª –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ —Å–∏–º–≤–æ–ª–∞
    const existingUnit = productUnits.find(u => (u.name === unitData.name || u.symbol === unitData.symbol) && u.id !== unitData.id);
    if (existingUnit) {
        showNotification('–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏–ª–∏ —Å–∏–º–≤–æ–ª–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
    }

    const existingIndex = productUnits.findIndex(u => u.id === unitData.id);
    if (existingIndex >= 0) {
        productUnits[existingIndex] = { ...productUnits[existingIndex], ...unitData };
    } else {
        productUnits.push(unitData);
    }

    saveDataToStorage();
    hideModal('unit-modal');
    loadProductUnits();

    showNotification(`–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è "${unitData.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`, 'success');
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
function editProductUnit(unitId) {
    const unit = productUnits.find(u => u.id === unitId);
    if (!unit) return;

    document.getElementById('unit-id').value = unit.id;
    document.getElementById('unit-name').value = unit.name;
    document.getElementById('unit-symbol').value = unit.symbol;
    document.getElementById('unit-description').value = unit.description || '';
    document.getElementById('unit-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è';

    showModal('unit-modal', true);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
function deleteProductUnit(unitId) {
    const productsWithUnit = products.filter(p => p.unitId === unitId).length;
    if (productsWithUnit > 0) {
        showNotification(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è. –û–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ${productsWithUnit} —Ç–æ–≤–∞—Ä–∞—Ö`, 'error');
        return;
    }

    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è?')) return;

    const unitIndex = productUnits.findIndex(u => u.id === unitId);
    if (unitIndex >= 0) {
        const unitName = productUnits[unitIndex].name;
        productUnits.splice(unitIndex, 1);
        
        saveDataToStorage();
        loadProductUnits();
        
        showNotification(`–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è "${unitName}" —É–¥–∞–ª–µ–Ω–∞`, 'success');
    }
}

// –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
function showProductUnitModal() {
    console.log('üîß showProductUnitModal –≤—ã–∑–≤–∞–Ω–∞');
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    const nameField = document.getElementById('new-unit-name');
    const codeField = document.getElementById('new-unit-code');
    
    if (nameField) nameField.value = '';
    if (codeField) codeField.value = '';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –µ–¥–∏–Ω–∏—Ü
    loadProductUnits();
    
    showModal('product-units-modal', true);
}

// ================================
// –ü–ê–†–¢–ò–û–ù–ù–´–ô –£–ß–Å–¢ –ò FIFO –õ–û–ì–ò–ö–ê
// ================================

// –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–∞—Ä—Ç–∏–π —Ç–æ–≤–∞—Ä–∞
function viewProductBatches(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    document.getElementById('batch-product-name').textContent = product.name;
    document.getElementById('batch-product-sku').textContent = product.sku;
    
    loadProductBatchesList(productId);
    showModal('product-batches-modal', true);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–∞—Ä—Ç–∏–π
function loadProductBatchesList(productId) {
    const tbody = document.getElementById('batches-table-body');
    if (!tbody) return;

    const batches = productBatches.filter(b => b.productId === productId);
    
    if (batches.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-layer-group text-4xl mb-2 block"></i>
                    –ü–∞—Ä—Ç–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
            </tr>
        `;
        return;
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (FIFO)
    batches.sort((a, b) => new Date(a.productionDate) - new Date(b.productionDate));

    tbody.innerHTML = batches.map(batch => {
        const expirationDate = batch.expirationDate ? new Date(batch.expirationDate) : null;
        const isExpiringSoon = expirationDate && (expirationDate - new Date()) / (1000 * 60 * 60 * 24) <= 30;
        const isExpired = expirationDate && expirationDate < new Date();
        
        return `
            <tr class="hover:bg-gray-50 ${isExpired ? 'bg-red-50' : isExpiringSoon ? 'bg-yellow-50' : ''}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${batch.batchNumber}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${new Date(batch.productionDate).toLocaleDateString('ru-RU')}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${expirationDate ? expirationDate.toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
                    ${isExpired ? '<span class="text-red-600 ml-1">(–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞)</span>' : 
                      isExpiringSoon ? '<span class="text-yellow-600 ml-1">(–ò—Å—Ç–µ–∫–∞–µ—Ç)</span>' : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${batch.quantity}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${batch.status === 'available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${batch.status === 'available' ? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editBatch('${batch.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteBatch('${batch.id}')" class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// FIFO —Å–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
function fifoWriteOff(productId, quantity) {
    const availableBatches = productBatches
        .filter(b => b.productId === productId && b.status === 'available' && b.quantity > 0)
        .sort((a, b) => new Date(a.productionDate) - new Date(b.productionDate));

    let remainingQuantity = quantity;
    const writeOffBatches = [];

    for (const batch of availableBatches) {
        if (remainingQuantity <= 0) break;

        const quantityToWriteOff = Math.min(batch.quantity, remainingQuantity);
        
        writeOffBatches.push({
            batchId: batch.id,
            batchNumber: batch.batchNumber,
            quantity: quantityToWriteOff
        });

        batch.quantity -= quantityToWriteOff;
        remainingQuantity -= quantityToWriteOff;

        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
        inventoryMovements.push({
            id: Date.now().toString() + Math.random(),
            productId: productId,
            batchId: batch.id,
            type: 'writeoff',
            quantity: quantityToWriteOff,
            date: new Date().toISOString(),
            reason: 'FIFO —Å–ø–∏—Å–∞–Ω–∏–µ'
        });
    }

    if (remainingQuantity > 0) {
        throw new Error(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: ${remainingQuantity}`);
    }

    saveDataToStorage();
    return writeOffBatches;
}

// ================================
// –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –ü–û–ò–°–ö –¢–û–í–ê–†–û–í
// ================================

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
function initProductFilters() {
    // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ SKU
    const searchInput = document.getElementById('products-search');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterProducts, 300));
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const categoryFilter = document.getElementById('products-category-filter');
    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterProducts);
        loadCategoriesFilter();
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
    const statusFilter = document.getElementById('products-status-filter');
    if (statusFilter) {
        statusFilter.addEventListener('change', filterProducts);
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    const sortSelect = document.getElementById('products-sort');
    if (sortSelect) {
        sortSelect.addEventListener('change', filterProducts);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä
function loadCategoriesFilter() {
    const select = document.getElementById('products-category-filter');
    if (!select) return;

    select.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
    productCategories.forEach(category => {
        select.innerHTML += `<option value="${category.id}">${category.name}</option>`;
    });
}

// –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
function filterProducts() {
    const searchTerm = document.getElementById('products-search')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('products-category-filter')?.value || '';
    const statusFilter = document.getElementById('products-status-filter')?.value || '';
    const sortBy = document.getElementById('products-sort')?.value || 'name';

    let filteredProducts = [...products];

    // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ SKU
    if (searchTerm) {
        filteredProducts = filteredProducts.filter(product => 
            product.name.toLowerCase().includes(searchTerm) ||
            product.sku.toLowerCase().includes(searchTerm) ||
            (product.description && product.description.toLowerCase().includes(searchTerm))
        );
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (categoryFilter) {
        filteredProducts = filteredProducts.filter(product => product.categoryId === categoryFilter);
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if (statusFilter) {
        filteredProducts = filteredProducts.filter(product => product.status === statusFilter);
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    filteredProducts.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'sku':
                return a.sku.localeCompare(b.sku);
            case 'price':
                return (b.price || 0) - (a.price || 0);
            case 'stock':
                return calculateTotalStock(b.id) - calculateTotalStock(a.id);
            case 'created':
                return new Date(b.createdAt) - new Date(a.createdAt);
            default:
                return 0;
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    renderFilteredProducts(filteredProducts);
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
function renderFilteredProducts(filteredProducts) {
    const tbody = document.getElementById('products-table-body');
    if (!tbody) return;

    if (filteredProducts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-search text-4xl mb-2 block"></i>
                    –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É —Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = filteredProducts.map(product => {
        const category = productCategories.find(c => c.id === product.categoryId);
        const unit = productUnits.find(u => u.id === product.unitId);
        const totalStock = calculateTotalStock(product.id);
        const stockStatus = getStockStatus(totalStock, product.minStock || 0);
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="h-10 w-10 flex-shrink-0">
                            <div class="h-10 w-10 rounded-lg bg-gray-200 flex items-center justify-center">
                                <i class="fas fa-cube text-gray-500"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${product.name}</div>
                            <div class="text-sm text-gray-500">${product.sku}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                        ${category ? category.name : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <div class="text-sm font-medium">${product.salePrice ? product.salePrice.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    ${product.margin ? '<div class="text-xs text-green-600">+' + product.margin + '%</div>' : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <span class="text-sm font-medium ${stockStatus.color}">${totalStock}</span>
                        <span class="text-xs text-gray-500 ml-1">${unit ? unit.name : '—à—Ç'}</span>
                        ${stockStatus.icon}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${product.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${product.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${product.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(product.createdAt).toLocaleDateString('ru-RU')}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editProduct('${product.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="viewProductBatches('${product.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="–ü–∞—Ä—Ç–∏–∏">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function clearProductFilters() {
    document.getElementById('products-search').value = '';
    document.getElementById('products-category-filter').value = '';
    document.getElementById('products-status-filter').value = '';
    document.getElementById('products-sort').value = 'name';
    loadProducts();
}

// –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∞–ª–∏–∞—Å –¥–ª—è clearProductFilters)
function resetProductFilters() {
    clearProductFilters();
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
function addProductUnit() {
    const name = document.getElementById('new-unit-name').value.trim();
    const code = document.getElementById('new-unit-code').value.trim();
    
    if (!name || !code) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è', 'error');
        return;
    }
    
    const unitData = {
        id: Date.now().toString(),
        name: name,
        symbol: code,
        description: '',
        createdAt: new Date().toISOString()
    };
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
    const existingUnit = productUnits.find(u => u.name === name || u.symbol === code);
    if (existingUnit) {
        showNotification('–ï–¥–∏–Ω–∏—Ü–∞ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏–ª–∏ –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
    }
    
    productUnits.push(unitData);
    saveDataToStorage();
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    document.getElementById('new-unit-name').value = '';
    document.getElementById('new-unit-code').value = '';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    loadProductUnits();
    loadProductUnitsToSelect();
    
    showNotification(`–ï–¥–∏–Ω–∏—Ü–∞ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞
function addProductCategory() {
    const name = document.getElementById('new-category-name').value.trim();
    const color = document.getElementById('new-category-color').value;
    
    if (!name) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'error');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const prefix = name.substring(0, 3).toUpperCase();
    
    const categoryData = {
        id: Date.now().toString(),
        name: name,
        prefix: prefix,
        description: '',
        color: color,
        createdAt: new Date().toISOString()
    };
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
    const existingCategory = productCategories.find(c => c.name === name);
    if (existingCategory) {
        showNotification('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
    }
    
    productCategories.push(categoryData);
    saveDataToStorage();
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    document.getElementById('new-category-name').value = '';
    document.getElementById('new-category-color').value = '#10B981';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
    loadProductCategories();
    loadProductCategoriesToSelect();
    loadCategoriesFilter();
    
    showNotification(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
}

// ================================
// –≠–ö–°–ü–û–†–¢ –ò –ü–ï–ß–ê–¢–¨
// ================================

// –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ Excel
function exportProductsToExcel() {
    const data = products.map(product => {
        const category = productCategories.find(c => c.id === product.categoryId);
        const unit = productUnits.find(u => u.id === product.unitId);
        const totalStock = calculateTotalStock(product.id);
        
        return {
            '–ê—Ä—Ç–∏–∫—É–ª': product.sku,
            '–ù–∞–∑–≤–∞–Ω–∏–µ': product.name,
            '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': category ? category.name : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
            '–¶–µ–Ω–∞': product.price || 0,
            '–û—Å—Ç–∞—Ç–æ–∫': totalStock,
            '–ï–¥–∏–Ω–∏—Ü–∞': unit ? unit.name : '—à—Ç',
            '–ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫': product.minStock || 0,
            '–ú–∞–∫—Å. –æ—Å—Ç–∞—Ç–æ–∫': product.maxStock || 0,
            '–°—Ç–∞—Ç—É—Å': product.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π',
            '–û–ø–∏—Å–∞–Ω–∏–µ': product.description || '',
            '–®—Ç—Ä–∏—Ö–∫–æ–¥': product.barcode || '',
            '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è': new Date(product.createdAt).toLocaleDateString('ru-RU')
        };
    });

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, '–¢–æ–≤–∞—Ä—ã');
    
    const fileName = `—Ç–æ–≤–∞—Ä—ã_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(workbook, fileName);
    
    showNotification('–≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
}

// –ü–µ—á–∞—Ç—å —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
function printProductsList() {
    const printContent = generateProductsPrintContent();
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ - –ü–æ–≤–∞—Ä –ë–∏–º</title>
            <style>
                body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .company-name { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                .report-title { font-size: 16px; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .footer { margin-top: 30px; font-size: 10px; color: #666; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            ${printContent}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 250);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏
function generateProductsPrintContent() {
    const totalProducts = products.length;
    const activeProducts = products.filter(p => p.status === 'active').length;
    const totalValue = products.reduce((sum, p) => sum + (p.price || 0) * calculateTotalStock(p.id), 0);
    
    const productsRows = products.map(product => {
        const category = productCategories.find(c => c.id === product.categoryId);
        const unit = productUnits.find(u => u.id === product.unitId);
        const totalStock = calculateTotalStock(product.id);
        
        return `
            <tr>
                <td>${product.sku}</td>
                <td>${product.name}</td>
                <td>${category ? category.name : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</td>
                <td><div class="text-sm font-medium">${product.salePrice ? product.salePrice.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    ${product.margin ? '<div class="text-xs text-green-600">+' + product.margin + '%</div>' : ''}</td>
                <td>${totalStock} ${unit ? unit.name : '—à—Ç'}</td>
                <td>${product.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π'}</td>
            </tr>
        `;
    }).join('');

    return `
        <div class="header">
            <div class="company-name">–ü–û–í–ê–† –ë–ò–ú - CRM –°–∏—Å—Ç–µ–º–∞</div>
            <div class="report-title">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</div>
            <div>–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}</div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <strong>–°–≤–æ–¥–∫–∞:</strong><br>
            –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: ${totalProducts}<br>
            –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: ${activeProducts}<br>
            –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ: ${totalValue.toLocaleString('ru-RU')} ‚ÇΩ
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                ${productsRows}
            </tbody>
        </table>
        
        <div class="footer">
            <p>–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ CRM —Å–∏—Å—Ç–µ–º–µ "–ü–æ–≤–∞—Ä –ë–∏–º"</p>
        </div>
    `;
}

// ================================
// –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö
// ================================

// –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞
function validateProductData(productData) {
    const errors = [];

    if (!productData.name || productData.name.length < 2) {
        errors.push('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
    }

    if (!productData.categoryId) {
        errors.push('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞');
    }

    if (!productData.unitId) {
        errors.push('–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è');
    }

    if (productData.price && (isNaN(productData.price) || productData.price < 0)) {
        errors.push('–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
    }

    if (productData.minStock && (isNaN(productData.minStock) || productData.minStock < 0)) {
        errors.push('–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
    }

    if (productData.maxStock && (isNaN(productData.maxStock) || productData.maxStock < 0)) {
        errors.push('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
    }

    if (productData.minStock && productData.maxStock && productData.minStock > productData.maxStock) {
        errors.push('–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ');
    }

    if (productData.barcode && productData.barcode.length > 50) {
        errors.push('–®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 50 —Å–∏–º–≤–æ–ª–æ–≤');
    }

    return errors;
}

// ================================
// –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ================================

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è localStorage
function updateProductsInStorage() {
    const data = {
        products: products,
        productCategories: productCategories,
        productUnits: productUnits,
        productBatches: productBatches,
        inventoryMovements: inventoryMovements
    };
    
    Object.keys(data).forEach(key => {
        localStorage.setItem(key, JSON.stringify(data[key]));
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è —Ç–æ–≤–∞—Ä–æ–≤
function initProductsModule() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–æ–≤
    loadProducts();
    loadProductCategories();
    loadProductUnits();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    initProductFilters();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–ª–µ–∫—Ç—ã
    loadProductCategoriesToSelect();
    loadProductUnitsToSelect();
    loadCategoriesFilter();
    
    console.log('–ú–æ–¥—É–ª—å —Ç–æ–≤–∞—Ä–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è debounce
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

    </script>
</body>
</html>