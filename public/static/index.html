<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Склад - Повар Бим</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Кастомные стили для анимаций */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal {
            backdrop-filter: blur(4px);
        }

        /* Скрыть скроллбар но оставить функциональность */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Заголовок приложения -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-warehouse text-2xl text-blue-600 mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Склад - Повар Бим</h1>
                </div>
                <div class="text-sm text-gray-500">
                    Модуль управления товарами
                </div>
            </div>
        </div>
    </header>

    <!-- Основной контент -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Панель управления -->
        <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <!-- Поиск и фильтры -->
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Поиск по названию -->
                        <div class="relative">
                            <input type="text" 
                                   id="searchInput" 
                                   placeholder="Поиск по названию..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>

                        <!-- Фильтр по категории -->
                        <select id="categoryFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Все категории</option>
                            <option value="finished">Готовая продукция</option>
                            <option value="ingredients">Ингредиенты</option>
                            <option value="packaging">Упаковка</option>
                        </select>

                        <!-- Фильтр по статусу -->
                        <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Все статусы</option>
                            <option value="in_stock">В наличии</option>
                            <option value="low_stock">Мало на складе</option>
                            <option value="out_of_stock">Нет в наличии</option>
                            <option value="discontinued">Снят с производства</option>
                        </select>
                    </div>

                    <!-- Кнопка добавления товара -->
                    <div class="flex items-center gap-3">
                        <button id="addProductBtn" 
                                class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus"></i>
                            Добавить товар
                        </button>

                        <!-- Счетчик товаров -->
                        <div class="text-sm text-gray-600">
                            Товаров: <span id="productsCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Таблица товаров -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <!-- Заголовок таблицы -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h2 class="text-lg font-semibold text-gray-900">Список товаров</h2>
            </div>

            <!-- Таблица -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('name')">
                                <div class="flex items-center gap-1">
                                    Товар
                                    <i class="fas fa-sort text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('sku')">
                                <div class="flex items-center gap-1">
                                    Артикул
                                    <i class="fas fa-sort text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('category')">
                                <div class="flex items-center gap-1">
                                    Категория
                                    <i class="fas fa-sort text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('currentStock')">
                                <div class="flex items-center gap-1">
                                    Остатки
                                    <i class="fas fa-sort text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('costPrice')">
                                <div class="flex items-center gap-1">
                                    Себестоимость
                                    <i class="fas fa-sort text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('salePrice')">
                                <div class="flex items-center gap-1">
                                    Цена продажи
                                    <i class="fas fa-sort text-xs"></i>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Статус
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Действия
                            </th>
                        </tr>
                    </thead>
                    <tbody id="productsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Строки товаров будут добавлены динамически -->
                        <tr id="emptyState" class="text-center">
                            <td colspan="8" class="px-6 py-12">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">Товары не найдены</h3>
                                    <p class="text-gray-500 mb-4">Добавьте первый товар для начала работы</p>
                                    <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        <i class="fas fa-plus mr-2"></i>
                                        Добавить товар
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Модальное окно для добавления/редактирования товара -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <!-- Заголовок модального окна -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">Добавить товар</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Форма товара -->
            <form id="productForm" class="p-6">
                <input type="hidden" id="productId">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Основная информация -->
                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-900 mb-3">Основная информация</h4>

                        <!-- Название товара -->
                        <div>
                            <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">
                                Название товара *
                            </label>
                            <input type="text" 
                                   id="productName" 
                                   name="name"
                                   required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Например: Каша гречневая с мясом">
                            <div id="nameError" class="text-red-500 text-xs mt-1 hidden"></div>
                        </div>

                        <!-- Артикул -->
                        <div>
                            <label for="productSku" class="block text-sm font-medium text-gray-700 mb-1">
                                Артикул (SKU) *
                            </label>
                            <input type="text" 
                                   id="productSku" 
                                   name="sku"
                                   required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Например: PB-GREK-MEAT-300">
                            <div id="skuError" class="text-red-500 text-xs mt-1 hidden"></div>
                        </div>

                        <!-- Категория -->
                        <div>
                            <label for="productCategory" class="block text-sm font-medium text-gray-700 mb-1">
                                Категория *
                            </label>
                            <select id="productCategory" 
                                    name="category"
                                    required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Выберите категорию</option>
                                <option value="finished">Готовая продукция</option>
                                <option value="ingredients">Ингредиенты</option>
                                <option value="packaging">Упаковка</option>
                            </select>
                            <div id="categoryError" class="text-red-500 text-xs mt-1 hidden"></div>
                        </div>

                        <!-- Статус -->
                        <div>
                            <label for="productStatus" class="block text-sm font-medium text-gray-700 mb-1">
                                Статус
                            </label>
                            <select id="productStatus" 
                                    name="status"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="in_stock">В наличии</option>
                                <option value="low_stock">Мало на складе</option>
                                <option value="out_of_stock">Нет в наличии</option>
                                <option value="discontinued">Снят с производства</option>
                            </select>
                        </div>
                    </div>

                    <!-- Финансы и остатки -->
                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-900 mb-3">Финансы и остатки</h4>

                        <!-- Себестоимость -->
                        <div>
                            <label for="costPrice" class="block text-sm font-medium text-gray-700 mb-1">
                                Себестоимость (₽) *
                            </label>
                            <input type="number" 
                                   id="costPrice" 
                                   name="costPrice"
                                   required
                                   min="0"
                                   step="0.01"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0.00">
                            <div id="costPriceError" class="text-red-500 text-xs mt-1 hidden"></div>
                        </div>

                        <!-- Цена продажи -->
                        <div>
                            <label for="salePrice" class="block text-sm font-medium text-gray-700 mb-1">
                                Цена продажи (₽) *
                            </label>
                            <input type="number" 
                                   id="salePrice" 
                                   name="salePrice"
                                   required
                                   min="0"
                                   step="0.01"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0.00">
                            <div id="salePriceError" class="text-red-500 text-xs mt-1 hidden"></div>
                        </div>

                        <!-- Текущий остаток -->
                        <div>
                            <label for="currentStock" class="block text-sm font-medium text-gray-700 mb-1">
                                Текущий остаток (шт)
                            </label>
                            <input type="number" 
                                   id="currentStock" 
                                   name="currentStock"
                                   min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0">
                        </div>

                        <!-- Минимальный остаток -->
                        <div>
                            <label for="minStock" class="block text-sm font-medium text-gray-700 mb-1">
                                Минимальный остаток (шт)
                            </label>
                            <input type="number" 
                                   id="minStock" 
                                   name="minStock"
                                   min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- Дополнительная информация -->
                <div class="mt-6">
                    <h4 class="font-medium text-gray-900 mb-3">Дополнительная информация</h4>

                    <!-- Описание -->
                    <div class="mb-4">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                            Описание
                        </label>
                        <textarea id="description" 
                                  name="description"
                                  rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Краткое описание товара..."></textarea>
                    </div>

                    <!-- Срок годности (для готовой продукции) -->
                    <div id="expirationDateContainer" class="mb-4">
                        <label for="expirationDate" class="block text-sm font-medium text-gray-700 mb-1">
                            Срок годности
                        </label>
                        <input type="date" 
                               id="expirationDate" 
                               name="expirationDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Кнопки управления -->
                <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                    <button type="button" 
                            id="cancelBtn"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Отмена
                    </button>
                    <button type="submit" 
                            id="submitBtn"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        Добавить товар
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Подтверждение удаления</h3>
                        <p class="text-gray-600">Это действие нельзя отменить</p>
                    </div>
                </div>

                <p class="text-gray-700 mb-6">
                    Вы действительно хотите удалить товар "<span id="deleteProductName" class="font-semibold"></span>"?
                </p>

                <div class="flex justify-end gap-3">
                    <button id="cancelDeleteBtn" 
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Отмена
                    </button>
                    <button id="confirmDeleteBtn" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                        Удалить
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
// ========== МОДЕЛЬ ДАННЫХ ==========
class Product {
    constructor(data = {}) {
        this.id = data.id || this.generateId();
        this.name = data.name || '';
        this.sku = data.sku || '';
        this.category = data.category || '';
        this.status = data.status || 'in_stock';
        this.costPrice = parseFloat(data.costPrice) || 0;
        this.salePrice = parseFloat(data.salePrice) || 0;
        this.currentStock = parseInt(data.currentStock) || 0;
        this.minStock = parseInt(data.minStock) || 0;
        this.description = data.description || '';
        this.expirationDate = data.expirationDate || null;
        this.createdAt = data.createdAt || new Date().toISOString();
        this.updatedAt = data.updatedAt || new Date().toISOString();
    }

    generateId() {
        return 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Вычисляемые свойства
    get margin() {
        return this.salePrice - this.costPrice;
    }

    get marginPercent() {
        return this.costPrice > 0 ? ((this.margin / this.costPrice) * 100).toFixed(2) : 0;
    }

    get isLowStock() {
        return this.currentStock <= this.minStock && this.currentStock > 0;
    }

    get isOutOfStock() {
        return this.currentStock === 0;
    }

    get statusText() {
        const statuses = {
            'in_stock': 'В наличии',
            'low_stock': 'Мало на складе',
            'out_of_stock': 'Нет в наличии',
            'discontinued': 'Снят с производства'
        };
        return statuses[this.status] || 'Неизвестно';
    }

    get categoryText() {
        const categories = {
            'finished': 'Готовая продукция',
            'ingredients': 'Ингредиенты',
            'packaging': 'Упаковка'
        };
        return categories[this.category] || 'Не указана';
    }

    // Автоматическое обновление статуса на основе остатков
    updateStatus() {
        if (this.currentStock === 0) {
            this.status = 'out_of_stock';
        } else if (this.isLowStock && this.status !== 'discontinued') {
            this.status = 'low_stock';
        } else if (this.currentStock > this.minStock && this.status === 'low_stock') {
            this.status = 'in_stock';
        }
        return this;
    }

    // Валидация данных
    validate() {
        const errors = {};

        if (!this.name.trim()) {
            errors.name = 'Название товара обязательно';
        }

        if (!this.sku.trim()) {
            errors.sku = 'Артикул обязателен';
        }

        if (!this.category) {
            errors.category = 'Категория обязательна';
        }

        if (this.costPrice < 0) {
            errors.costPrice = 'Себестоимость не может быть отрицательной';
        }

        if (this.salePrice < 0) {
            errors.salePrice = 'Цена продажи не может быть отрицательной';
        }

        if (this.salePrice < this.costPrice) {
            errors.salePrice = 'Цена продажи не может быть меньше себестоимости';
        }

        if (this.currentStock < 0) {
            errors.currentStock = 'Остаток не может быть отрицательным';
        }

        if (this.minStock < 0) {
            errors.minStock = 'Минимальный остаток не может быть отрицательным';
        }

        return {
            isValid: Object.keys(errors).length === 0,
            errors: errors
        };
    }

    toJSON() {
        return {
            id: this.id,
            name: this.name,
            sku: this.sku,
            category: this.category,
            status: this.status,
            costPrice: this.costPrice,
            salePrice: this.salePrice,
            currentStock: this.currentStock,
            minStock: this.minStock,
            description: this.description,
            expirationDate: this.expirationDate,
            createdAt: this.createdAt,
            updatedAt: this.updatedAt
        };
    }
}

// ========== УПРАВЛЕНИЕ ДАННЫМИ ==========
class ProductService {
    constructor() {
        this.storageKey = 'povar_bim_products';
        this.products = this.loadFromStorage();
    }

    // Загрузка из localStorage
    loadFromStorage() {
        try {
            const data = localStorage.getItem(this.storageKey);
            if (data) {
                const parsed = JSON.parse(data);
                return parsed.map(item => new Product(item));
            }
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
        }
        return [];
    }

    // Сохранение в localStorage
    saveToStorage() {
        try {
            const data = this.products.map(product => product.toJSON());
            localStorage.setItem(this.storageKey, JSON.stringify(data));
            return true;
        } catch (error) {
            console.error('Ошибка сохранения данных:', error);
            return false;
        }
    }

    // Получить все товары
    getAll() {
        return [...this.products];
    }

    // Получить товар по ID
    getById(id) {
        return this.products.find(product => product.id === id);
    }

    // Получить товар по артикулу
    getBySku(sku) {
        return this.products.find(product => product.sku === sku);
    }

    // Добавить товар
    add(productData) {
        const product = new Product(productData);
        product.updateStatus();

        // Проверка валидации
        const validation = product.validate();
        if (!validation.isValid) {
            return { success: false, errors: validation.errors };
        }

        // Проверка уникальности артикула
        if (this.getBySku(product.sku)) {
            return { success: false, errors: { sku: 'Товар с таким артикулом уже существует' } };
        }

        this.products.push(product);
        this.saveToStorage();

        return { success: true, product: product };
    }

    // Обновить товар
    update(id, productData) {
        const index = this.products.findIndex(product => product.id === id);
        if (index === -1) {
            return { success: false, errors: { general: 'Товар не найден' } };
        }

        const existingProduct = this.products[index];

        // Создаем обновленный товар
        const updatedData = {
            ...existingProduct.toJSON(),
            ...productData,
            id: id,
            updatedAt: new Date().toISOString()
        };

        const product = new Product(updatedData);
        product.updateStatus();

        // Проверка валидации
        const validation = product.validate();
        if (!validation.isValid) {
            return { success: false, errors: validation.errors };
        }

        // Проверка уникальности артикула (исключая текущий товар)
        const existingBySku = this.getBySku(product.sku);
        if (existingBySku && existingBySku.id !== id) {
            return { success: false, errors: { sku: 'Товар с таким артикулом уже существует' } };
        }

        this.products[index] = product;
        this.saveToStorage();

        return { success: true, product: product };
    }

    // Удалить товар
    delete(id) {
        const index = this.products.findIndex(product => product.id === id);
        if (index === -1) {
            return { success: false, error: 'Товар не найден' };
        }

        const deletedProduct = this.products.splice(index, 1)[0];
        this.saveToStorage();

        return { success: true, product: deletedProduct };
    }

    // Поиск и фильтрация
    search(query, filters = {}) {
        let results = [...this.products];

        // Текстовый поиск
        if (query && query.trim()) {
            const searchTerm = query.toLowerCase().trim();
            results = results.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.sku.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );
        }

        // Фильтр по категории
        if (filters.category) {
            results = results.filter(product => product.category === filters.category);
        }

        // Фильтр по статусу
        if (filters.status) {
            results = results.filter(product => product.status === filters.status);
        }

        return results;
    }

    // Сортировка
    sort(products, field, direction = 'asc') {
        return products.sort((a, b) => {
            let aVal = a[field];
            let bVal = b[field];

            // Для строковых значений
            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            if (direction === 'asc') {
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            } else {
                return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
            }
        });
    }

    // Статистика
    getStats() {
        const total = this.products.length;
        const inStock = this.products.filter(p => p.status === 'in_stock').length;
        const lowStock = this.products.filter(p => p.status === 'low_stock').length;
        const outOfStock = this.products.filter(p => p.status === 'out_of_stock').length;
        const discontinued = this.products.filter(p => p.status === 'discontinued').length;

        const totalValue = this.products.reduce((sum, p) => sum + (p.currentStock * p.costPrice), 0);

        return {
            total,
            inStock,
            lowStock,
            outOfStock,
            discontinued,
            totalValue
        };
    }
}

// Создаем глобальный экземпляр сервиса
const productService = new ProductService();

// ========== КОНТРОЛЛЕР UI ==========
class WarehouseController {
    constructor() {
        this.currentSort = { field: 'name', direction: 'asc' };
        this.currentFilters = {};
        this.currentQuery = '';
        this.editingProductId = null;

        this.init();
    }

    init() {
        this.bindEvents();
        this.loadTestData();
        this.renderProducts();
        this.updateStats();
    }

    bindEvents() {
        // Кнопки модального окна
        document.getElementById('addProductBtn').addEventListener('click', () => this.openAddModal());
        document.getElementById('closeModalBtn').addEventListener('click', () => this.closeModal());
        document.getElementById('cancelBtn').addEventListener('click', () => this.closeModal());

        // Форма товара
        document.getElementById('productForm').addEventListener('submit', (e) => this.handleSubmit(e));

        // Поиск и фильтры
        document.getElementById('searchInput').addEventListener('input', (e) => this.handleSearch(e));
        document.getElementById('categoryFilter').addEventListener('change', (e) => this.handleFilter(e));
        document.getElementById('statusFilter').addEventListener('change', (e) => this.handleFilter(e));

        // Модальное окно удаления
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => this.closeDeleteModal());
        document.getElementById('confirmDeleteBtn').addEventListener('click', () => this.confirmDelete());

        // Закрытие модального окна при клике вне его
        document.getElementById('productModal').addEventListener('click', (e) => {
            if (e.target.id === 'productModal') {
                this.closeModal();
            }
        });

        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                this.closeDeleteModal();
            }
        });

        // Обработка изменения категории для показа/скрытия поля срока годности
        document.getElementById('productCategory').addEventListener('change', (e) => {
            this.toggleExpirationDate(e.target.value);
        });
    }

    // ========== УПРАВЛЕНИЕ МОДАЛЬНЫМИ ОКНАМИ ==========
    openAddModal() {
        this.editingProductId = null;
        document.getElementById('modalTitle').textContent = 'Добавить товар';
        document.getElementById('submitBtn').textContent = 'Добавить товар';
        this.clearForm();
        this.showModal();
    }

    openEditModal(productId) {
        const product = productService.getById(productId);
        if (!product) return;

        this.editingProductId = productId;
        document.getElementById('modalTitle').textContent = 'Редактировать товар';
        document.getElementById('submitBtn').textContent = 'Сохранить изменения';
        this.fillForm(product);
        this.showModal();
    }

    showModal() {
        const modal = document.getElementById('productModal');
        modal.classList.remove('hidden');
        modal.classList.add('fade-in');
        document.body.style.overflow = 'hidden';

        // Фокус на первое поле
        setTimeout(() => {
            document.getElementById('productName').focus();
        }, 100);
    }

    closeModal() {
        const modal = document.getElementById('productModal');
        modal.classList.add('hidden');
        modal.classList.remove('fade-in');
        document.body.style.overflow = 'auto';
        this.clearForm();
        this.clearErrors();
    }

    openDeleteModal(productId) {
        const product = productService.getById(productId);
        if (!product) return;

        this.deletingProductId = productId;
        document.getElementById('deleteProductName').textContent = product.name;

        const modal = document.getElementById('deleteModal');
        modal.classList.remove('hidden');
        modal.classList.add('fade-in');
        document.body.style.overflow = 'hidden';
    }

    closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.add('hidden');
        modal.classList.remove('fade-in');
        document.body.style.overflow = 'auto';
        this.deletingProductId = null;
    }

    // ========== УПРАВЛЕНИЕ ФОРМОЙ ==========
    fillForm(product) {
        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('productSku').value = product.sku;
        document.getElementById('productCategory').value = product.category;
        document.getElementById('productStatus').value = product.status;
        document.getElementById('costPrice').value = product.costPrice;
        document.getElementById('salePrice').value = product.salePrice;
        document.getElementById('currentStock').value = product.currentStock;
        document.getElementById('minStock').value = product.minStock;
        document.getElementById('description').value = product.description;
        document.getElementById('expirationDate').value = product.expirationDate || '';

        this.toggleExpirationDate(product.category);
    }

    clearForm() {
        document.getElementById('productForm').reset();
        this.toggleExpirationDate('');
    }

    getFormData() {
        return {
            name: document.getElementById('productName').value.trim(),
            sku: document.getElementById('productSku').value.trim(),
            category: document.getElementById('productCategory').value,
            status: document.getElementById('productStatus').value,
            costPrice: parseFloat(document.getElementById('costPrice').value) || 0,
            salePrice: parseFloat(document.getElementById('salePrice').value) || 0,
            currentStock: parseInt(document.getElementById('currentStock').value) || 0,
            minStock: parseInt(document.getElementById('minStock').value) || 0,
            description: document.getElementById('description').value.trim(),
            expirationDate: document.getElementById('expirationDate').value || null
        };
    }

    toggleExpirationDate(category) {
        const container = document.getElementById('expirationDateContainer');
        if (category === 'finished') {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
            document.getElementById('expirationDate').value = '';
        }
    }

    // ========== ВАЛИДАЦИЯ ==========
    clearErrors() {
        const errorElements = document.querySelectorAll('[id$="Error"]');
        errorElements.forEach(element => {
            element.classList.add('hidden');
            element.textContent = '';
        });

        // Убираем красную границу с полей
        const inputs = document.querySelectorAll('#productForm input, #productForm select, #productForm textarea');
        inputs.forEach(input => {
            input.classList.remove('border-red-500');
        });
    }

    showErrors(errors) {
        this.clearErrors();

        Object.keys(errors).forEach(field => {
            const errorElement = document.getElementById(field + 'Error');
            const inputElement = document.getElementById(field) || 
                                 document.getElementById('product' + field.charAt(0).toUpperCase() + field.slice(1));

            if (errorElement) {
                errorElement.textContent = errors[field];
                errorElement.classList.remove('hidden');
            }

            if (inputElement) {
                inputElement.classList.add('border-red-500');
            }
        });
    }

    // ========== ОБРАБОТКА СОБЫТИЙ ==========
    handleSubmit(e) {
        e.preventDefault();

        const formData = this.getFormData();
        let result;

        if (this.editingProductId) {
            result = productService.update(this.editingProductId, formData);
        } else {
            result = productService.add(formData);
        }

        if (result.success) {
            this.closeModal();
            this.renderProducts();
            this.updateStats();
            this.showNotification(
                this.editingProductId ? 'Товар успешно обновлен!' : 'Товар успешно добавлен!',
                'success'
            );
        } else {
            this.showErrors(result.errors);
        }
    }

    handleSearch(e) {
        this.currentQuery = e.target.value;
        this.renderProducts();
    }

    handleFilter(e) {
        const filterName = e.target.id.replace('Filter', '');
        this.currentFilters[filterName] = e.target.value;
        this.renderProducts();
    }

    confirmDelete() {
        if (!this.deletingProductId) return;

        const result = productService.delete(this.deletingProductId);
        if (result.success) {
            this.closeDeleteModal();
            this.renderProducts();
            this.updateStats();
            this.showNotification('Товар успешно удален!', 'success');
        }
    }

    // ========== РЕНДЕРИНГ ТАБЛИЦЫ ==========
    renderProducts() {
        const products = this.getFilteredProducts();
        const tableBody = document.getElementById('productsTable');
        const emptyState = document.getElementById('emptyState');

        // Очищаем таблицу
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }

        if (products.length === 0) {
            tableBody.appendChild(emptyState);
        } else {
            products.forEach(product => {
                const row = this.createProductRow(product);
                tableBody.appendChild(row);
            });
        }

        this.updateStats();
    }

    getFilteredProducts() {
        let products = productService.search(this.currentQuery, this.currentFilters);
        return productService.sort(products, this.currentSort.field, this.currentSort.direction);
    }

    createProductRow(product) {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';

        // Определяем цвета статуса
        const statusColors = {
            'in_stock': 'bg-green-100 text-green-800',
            'low_stock': 'bg-yellow-100 text-yellow-800',
            'out_of_stock': 'bg-red-100 text-red-800',
            'discontinued': 'bg-gray-100 text-gray-800'
        };

        const statusColor = statusColors[product.status] || 'bg-gray-100 text-gray-800';

        // Определяем индикатор остатков
        let stockIndicator = '';
        if (product.currentStock <= product.minStock && product.currentStock > 0) {
            stockIndicator = '<i class="fas fa-exclamation-triangle text-yellow-500 ml-1" title="Мало на складе"></i>';
        } else if (product.currentStock === 0) {
            stockIndicator = '<i class="fas fa-times-circle text-red-500 ml-1" title="Нет в наличии"></i>';
        }

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-900">${this.escapeHtml(product.name)}</div>
                    <div class="text-sm text-gray-500">${this.escapeHtml(product.description || 'Без описания')}</div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-mono text-gray-900">${this.escapeHtml(product.sku)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${product.categoryText}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <span class="text-sm font-medium text-gray-900">${product.currentStock}</span>
                    <span class="text-xs text-gray-500 ml-1">/ мин: ${product.minStock}</span>
                    ${stockIndicator}
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${this.formatPrice(product.costPrice)} ₽</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-900">${this.formatPrice(product.salePrice)} ₽</div>
                    <div class="text-xs text-gray-500">Маржа: ${product.marginPercent}%</div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                    ${product.statusText}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex items-center justify-end gap-2">
                    <button onclick="warehouse.openEditModal('${product.id}')" 
                            class="text-blue-600 hover:text-blue-900 transition-colors"
                            title="Редактировать">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="warehouse.openDeleteModal('${product.id}')" 
                            class="text-red-600 hover:text-red-900 transition-colors"
                            title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;

        return row;
    }

    // ========== СОРТИРОВКА ==========


    // ========== ОБНОВЛЕНИЕ СТАТИСТИКИ ==========
    updateStats() {
        const stats = productService.getStats();
        document.getElementById('productsCount').textContent = stats.total;
    }

    // ========== УВЕДОМЛЕНИЯ ==========
    showNotification(message, type = 'info') {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg fade-in ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;

        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fas fa-${
                    type === 'success' ? 'check-circle' :
                    type === 'error' ? 'exclamation-circle' :
                    'info-circle'
                }"></i>
                <span>${this.escapeHtml(message)}</span>
            </div>
        `;

        document.body.appendChild(notification);

        // Автоматическое удаление через 3 секунды
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // ========== УТИЛИТЫ ==========
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    formatPrice(price) {
        return new Intl.NumberFormat('ru-RU', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(price);
    }

    formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU');
    }

    // ========== ТЕСТОВЫЕ ДАННЫЕ ==========
    loadTestData() {
        // Проверяем, есть ли уже данные
        if (productService.getAll().length > 0) {
            return; // Данные уже загружены
        }

        const testProducts = [
            {
                name: 'Каша гречневая с мясом 300г',
                sku: 'PB-GREK-MEAT-300',
                category: 'finished',
                status: 'in_stock',
                costPrice: 125.50,
                salePrice: 280.00,
                currentStock: 156,
                minStock: 50,
                description: 'Готовая каша из гречневой крупы с говяжьим мясом в банке 300г',
                expirationDate: '2024-12-15'
            },
            {
                name: 'Каша рисовая с курицей 300г',
                sku: 'PB-RICE-CHICK-300',
                category: 'finished',
                status: 'in_stock',
                costPrice: 118.75,
                salePrice: 265.00,
                currentStock: 89,
                minStock: 40,
                description: 'Готовая каша из риса с куриным мясом в банке 300г',
                expirationDate: '2024-11-20'
            },
            {
                name: 'Каша овсяная с фруктами 250г',
                sku: 'PB-OATS-FRUIT-250',
                category: 'finished',
                status: 'low_stock',
                costPrice: 95.20,
                salePrice: 220.00,
                currentStock: 23,
                minStock: 30,
                description: 'Овсяная каша с сухофруктами и орехами в банке 250г',
                expirationDate: '2024-10-30'
            },
            {
                name: 'Гречневая крупа высший сорт',
                sku: 'ING-BUCK-PREM',
                category: 'ingredients',
                status: 'in_stock',
                costPrice: 85.00,
                salePrice: 150.00,
                currentStock: 500,
                minStock: 100,
                description: 'Гречневая крупа высшего сорта для производства каш'
            },
            {
                name: 'Рис длиннозерный',
                sku: 'ING-RICE-LONG',
                category: 'ingredients',
                status: 'in_stock',
                costPrice: 72.50,
                salePrice: 130.00,
                currentStock: 350,
                minStock: 80,
                description: 'Длиннозерный рис высокого качества'
            },
            {
                name: 'Мясо говяжье (тушенка)',
                sku: 'ING-BEEF-STEW',
                category: 'ingredients',
                status: 'low_stock',
                costPrice: 450.00,
                salePrice: 650.00,
                currentStock: 45,
                minStock: 50,
                description: 'Говяжье мясо высшего сорта для готовых блюд'
            },
            {
                name: 'Банки стеклянные 300мл',
                sku: 'PKG-JAR-300',
                category: 'packaging',
                status: 'in_stock',
                costPrice: 25.80,
                salePrice: 45.00,
                currentStock: 2500,
                minStock: 500,
                description: 'Стеклянные банки с крышками для готовых каш 300мл'
            },
            {
                name: 'Этикетки самоклеящиеся',
                sku: 'PKG-LABEL-STD',
                category: 'packaging',
                status: 'out_of_stock',
                costPrice: 12.50,
                salePrice: 25.00,
                currentStock: 0,
                minStock: 1000,
                description: 'Самоклеящиеся этикетки для маркировки продукции'
            },
            {
                name: 'Каша перловая классическая 300г',
                sku: 'PB-PEARL-CLAS-300',
                category: 'finished',
                status: 'discontinued',
                costPrice: 105.00,
                salePrice: 195.00,
                currentStock: 12,
                minStock: 0,
                description: 'Перловая каша - снята с производства'
            }
        ];

        // Добавляем тестовые данные
        testProducts.forEach(productData => {
            productService.add(productData);
        });

        console.log('Загружены тестовые данные: ' + testProducts.length + ' товаров');
    }
}

// ========== ГЛОБАЛЬНЫЕ ФУНКЦИИ ==========
function sortTable(field) {
    if (warehouse.currentSort.field === field) {
        warehouse.currentSort.direction = warehouse.currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        warehouse.currentSort.field = field;
        warehouse.currentSort.direction = 'asc';
    }
    warehouse.renderProducts();
}

function openAddModal() {
    warehouse.openAddModal();
}

// ========== ИНИЦИАЛИЗАЦИЯ ==========
let warehouse;

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    warehouse = new WarehouseController();

    // Добавляем обработчик для клавиши Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const productModal = document.getElementById('productModal');
            const deleteModal = document.getElementById('deleteModal');

            if (!productModal.classList.contains('hidden')) {
                warehouse.closeModal();
            } else if (!deleteModal.classList.contains('hidden')) {
                warehouse.closeDeleteModal();
            }
        }
    });

    console.log('🚀 Склад "Повар Бим" инициализирован успешно!');
});
</script>

</body>
</html>